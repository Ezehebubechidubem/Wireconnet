<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect — Login (with debug)</title>
  <style>
    :root{
      --bg:#f6f8fb;--card:#fff;--accent:#0b5cff;--muted:#6b7280;--danger:#ef4444;
      --success-bg:#ecfdf5;--success-border:#bbf7d0;--success-text:#065f46;
    }
    html,body{height:100%}
    body{font-family:Inter, "Segoe UI", Roboto, Arial; background:var(--bg); margin:0; color:#111827}
    .wrap{max-width:920px;margin:28px auto;padding:20px}
    header{display:flex;flex-direction:column;gap:10px;align-items:stretch;margin-bottom:18px}
    .logo{width:100%;height:90px;border-radius:10px;background:linear-gradient(135deg,#0b5cff,#55a7ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:0 8px 24px rgba(11,92,255,0.08)}
    .logo img{height:90px; width:100%}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(16,24,40,0.06)}
    label{display:block;font-size:13px;margin-bottom:6px;color:#111827}
    input[type="text"],input[type="password"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px;background:white;box-sizing:border-box}
    .password-wrap{position:relative;display:flex;align-items:center}
    .toggle-eye{position:absolute;right:10px;cursor:pointer;color:var(--muted);display:flex;align-items:center;gap:6px}
    .toggle-eye svg{width:20px;height:20px}
    .actions{display:flex;gap:8px;align-items:center;margin-top:14px}
    button{background:var(--accent);color:white;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600;width:100%}
    .small{font-size:14px;color:var(--muted); }
    .smallt{text-decoration:none;color:blue}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:1200}
    .loader-card{background:white;border-radius:12px;padding:22px 26px;display:flex;flex-direction:column;align-items:center;gap:12px;box-shadow:0 12px 40px rgba(2,6,23,0.25);min-width:300px;text-align:center}
    .spinner{width:48px;height:48px;border-radius:50%;border:5px solid #eef3ff;border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .result-emoji{font-size:36px}.result-title{font-weight:700;margin-top:6px}.result-msg{color:#334155;margin-top:6px;font-size:14px}
    .result-close{margin-top:12px;padding:8px 14px;border-radius:8px;border:0;cursor:pointer;background:#0b5cff;color:white}
    .debug-box{margin-top:12px;background:#0f1724;color:#e6eef9;padding:12px;border-radius:8px;font-family:monospace;font-size:13px;white-space:pre-wrap;max-height:220px;overflow:auto;border:1px solid rgba(255,255,255,0.04)}
    .debug-toggle{margin-top:10px;display:inline-block;cursor:pointer;color:var(--accent);font-weight:700}
    @media(max-width:820px){.wrap{padding:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">
        <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect logo">
      </div>
    </header>

    <main class="card" style="max-width:520px;margin:0 auto;">
      <form id="loginForm" autocomplete="off" onsubmit="return false;">
        <label class="small">Login</label>

        <div style="margin-top:12px">
          <label for="identifier">Username, Email or Phone</label>
          <input id="identifier" name="identifier" type="text" placeholder="username or you@example.com or phone" required />
        </div>

        <div style="margin-top:12px">
          <label for="password">Password</label>
          <div class="password-wrap">
            <input id="password" name="password" type="password" placeholder="Enter your password" required />
            <div id="togglePassword" class="toggle-eye" title="Show / hide password" aria-hidden="true">
              <svg id="eyeOpen" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z"/><circle cx="12" cy="12" r="3"/></svg>
              <svg id="eyeClosed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" style="display:none"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-6 0-10-7-10-7"/><path d="M1 1l22 22"/></svg>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;align-items:center;gap:12px;">
          <input id="remember" type="checkbox" />
          <label for="remember" class="muted">Remember me</label>
        </div>

        <div style="margin-top:10px"><p class="small">Don't have an account? <a class="smallt" href="registration.html">Register here</a></p></div>

        <div class="actions" style="margin-top:16px;">
          <button type="button" id="submitBtn">Sign in</button>
        </div>

        <!-- DEBUG PANEL: visible on the page -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="muted">Server debug</div>
          <div id="debugToggle" class="debug-toggle">Show / Hide</div>
        </div>
        <pre id="debugBox" class="debug-box" style="display:none">No debug messages yet.</pre>
      </form>
    </main>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="loader-card">
      <div id="loadingView" style="display:flex;flex-direction:column;align-items:center;">
        <div class="spinner" aria-hidden="true"></div>
        <div style="font-weight:700">Signing you in…</div>
        <div class="small muted">Please wait while we verify your credentials.</div>
      </div>
      <div id="resultView" style="display:none;flex-direction:column;align-items:center;">
        <div class="result-emoji" id="resultEmoji">✅</div>
        <div class="result-title" id="resultTitle">Login successful</div>
        <div class="result-msg" id="resultText">Welcome back.</div>
        <button id="resultClose" class="result-close">OK</button>
      </div>
    </div>
  </div>

  <script>
    // backend base
    const BACKEND_URL = 'https://wireconnet-1.onrender.com';
    const LOGIN_ENDPOINT = BACKEND_URL + '/api/login';

    // elements
    const overlay = document.getElementById('overlay');
    const loadingView = document.getElementById('loadingView');
    const resultView = document.getElementById('resultView');
    const resultEmoji = document.getElementById('resultEmoji');
    const resultTitle = document.getElementById('resultTitle');
    const resultText = document.getElementById('resultText');
    const resultClose = document.getElementById('resultClose');

    const togglePassword = document.getElementById('togglePassword');
    const eyeOpen = document.getElementById('eyeOpen');
    const eyeClosed = document.getElementById('eyeClosed');
    const debugBox = document.getElementById('debugBox');
    const debugToggle = document.getElementById('debugToggle');

    togglePassword.addEventListener('click', () => {
      const pw = document.getElementById('password');
      if (pw.type === 'password') { pw.type = 'text'; eyeOpen.style.display='none'; eyeClosed.style.display='block'; }
      else { pw.type = 'password'; eyeOpen.style.display='block'; eyeClosed.style.display='none'; }
    });

    function showLoading(){ overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); loadingView.style.display='flex'; resultView.style.display='none'; }
    function showResult(success,title,message){ loadingView.style.display='none'; resultView.style.display='flex'; resultEmoji.textContent = success ? '✅' : '❌'; resultTitle.textContent = title; resultText.textContent = message; }
    function hideOverlay(){ overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); }
    function overlaySequenceFailure(){ if(overlay.style.display!=='flex') overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); }

    function redirectToClientDashboard(){ window.location.href = 'dashboard.html'; }
    function redirectToTechDashboard(){ window.location.href = 'technician.html'; }

    // debug helper: append and keep timestamp
    function appendDebug(txt){
      const time = new Date().toISOString();
      const prev = debugBox.textContent || '';
      const next = `--- ${time} ---\n${txt}\n\n${prev}`;
      debugBox.textContent = next;
      console.log('[DEBUG]', txt);
    }

    // toggle debug box visibility
    debugToggle.addEventListener('click', ()=> {
      const s = debugBox.style.display === 'none' ? 'block' : 'none';
      debugBox.style.display = s;
    });

    document.getElementById('submitBtn').addEventListener('click', async () => {
      const identifier = document.getElementById('identifier').value.trim();
      const password = document.getElementById('password').value;
      if(!identifier){ showLoading(); setTimeout(()=> showResult(false,'Login failed','Please enter your username, email or phone.'),300); appendDebug('Client validation failed: identifier empty'); return overlaySequenceFailure(); }
      if(!password || password.length < 6){ showLoading(); setTimeout(()=> showResult(false,'Login failed','Password must be at least 6 characters.'),300); appendDebug('Client validation failed: password too short'); return overlaySequenceFailure(); }

      showLoading();
      appendDebug(`Sending login request to ${LOGIN_ENDPOINT} with identifier="${identifier}" (password hidden)`);

      const payload = { login: identifier, password };

      try {
        const resp = await fetch(LOGIN_ENDPOINT, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload),
          credentials: 'include'
        });

        // Grab raw text first to make sure we can display it even if non-JSON was returned
        const rawText = await resp.text().catch(()=>null);
        let parsed = null;
        try { parsed = rawText ? JSON.parse(rawText) : null; } catch(e) { parsed = null; }

        // Show debug content
        const debugContent = [
          `HTTP ${resp.status} ${resp.statusText}`,
          `Request payload: ${JSON.stringify(payload)}`,
          `Response text: ${rawText || '(empty)'}`,
          `Parsed JSON: ${parsed ? JSON.stringify(parsed, null, 2) : '(not JSON or parse failed)'}`
        ].join('\n\n');
        appendDebug(debugContent);

        // If not OK, display server message (if available) and keep debug visible
        if(!resp.ok){
          const serverMsg = (parsed && parsed.message) ? parsed.message : (rawText || `HTTP ${resp.status}`);
          showResult(false,'Login failed', serverMsg);
          // Keep debug open for troubleshooting
          debugBox.style.display = 'block';
          return;
        }

        // Success path
        if(parsed && parsed.success && parsed.user){
          // Save session info
          try { localStorage.setItem('wc_user', JSON.stringify(parsed.user)); } catch(e){ appendDebug('localStorage write failed: ' + String(e)); }
          try { localStorage.setItem('userId', parsed.user.id); } catch(e){}
          try { localStorage.setItem('userRole', parsed.user.role || 'client'); } catch(e){}
          if(parsed.token){ try{ localStorage.setItem('wc_token', parsed.token); } catch(e){} }

          showResult(true,'Login successful', parsed.message || 'Redirecting...');
          appendDebug('Login success — saved user to localStorage.');

          setTimeout(()=> {
            hideOverlay();
            const role = (parsed.user.role || '').toString().toLowerCase();
            if(role === 'worker' || role === 'technician' || role === 'tech') {
              redirectToTechDashboard();
            } else {
              redirectToClientDashboard();
            }
          }, 800);
          return;
        }

        // If we reach here, response was OK but shape unexpected
        const fallbackMsg = (parsed && parsed.message) ? parsed.message : 'Unexpected server response';
        showResult(false,'Login failed', fallbackMsg);
        debugBox.style.display = 'block';
        appendDebug('Unexpected success response shape: ' + JSON.stringify(parsed));

      } catch(err){
        // network / fetch errors
        const errMsg = (err && err.message) ? err.message : String(err);
        appendDebug('Network / fetch error: ' + errMsg + (err && err.stack ? '\n' + err.stack : ''));
        showResult(false,'Login failed','Network error. Check debug for details.');
        debugBox.style.display = 'block';
      }
    });

    resultClose.addEventListener('click', ()=> hideOverlay());
  </script>
</body>
</html>