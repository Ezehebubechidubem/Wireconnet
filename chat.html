<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WireConnect — Chat</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{font-family:Inter,Arial;margin:0;background:#f6f8fb;color:#111}
header{display:flex;align-items:center;gap:12px;padding:10px;background:linear-gradient(135deg,#0b5cff,#55a7ff);color:#fff}

.container{
  display:flex;
  padding:12px;
  max-width:900px;
  margin:12px auto;
}

.chat-card{
  flex:1;
  background:#fff;
  border-radius:12px;
  padding:12px;
  box-shadow:0 8px 30px rgba(16,24,40,0.06)
}

#mapWrap{
  display:none;
  margin-top:12px;
}

#map{
  height:320px;
  border-radius:10px;
}

.chat-window{
  height:300px;
  overflow:auto;
  border:1px solid #eef2ff;
  padding:8px;
  border-radius:8px
}

.chat-input{
  display:flex;
  gap:8px;
  margin-top:8px
}

.btn{
  background:#0b5cff;
  color:#fff;
  padding:8px 12px;
  border-radius:8px;
  border:0;
  cursor:pointer;
  font-weight:600
}

.muted{color:#64748b}
</style>
</head>

<body>

<header>
<img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" style="height:36px">
<div style="font-weight:700">WireConnect — Chat</div>
</header>

<div class="container">
<div class="chat-card">

<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong id="peerName">Peer</strong>
<div class="muted" id="peerRole"></div>
</div>

<button id="toggleMapBtn" class="btn">Show Map</button>
</div>

<div id="jobStatus" style="font-weight:700;margin-top:6px"></div>
<div class="muted" id="distanceInfo"></div>

<div class="chat-window" id="chatWindow"></div>

<div class="chat-input">
<input id="chatText" placeholder="Write a message..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #eef2ff">
<button id="sendBtn" class="btn">Send</button>
</div>

<div id="mapWrap">
<div id="map"></div>
</div>

</div>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API_BASE = "https://wireconnet-1.onrender.com";

const params = new URLSearchParams(location.search);
const jobId = params.get("jobId");

if(!jobId){
 alert("No job specified");
 location.href="dashboard.html";
}

function q(s){return document.querySelector(s)}

const chatWindow=q("#chatWindow");
const chatText=q("#chatText");
const sendBtn=q("#sendBtn");
const jobStatus=q("#jobStatus");
const peerName=q("#peerName");
const peerRole=q("#peerRole");
const distanceInfo=q("#distanceInfo");

const toggleMapBtn=q("#toggleMapBtn");
const mapWrap=q("#mapWrap");

//////////////////////// CHAT ////////////////////////
const storageKey="wc_chat_"+jobId;

function loadMsgs(){return JSON.parse(localStorage.getItem(storageKey)||"[]")}
function saveMsg(m){
 const arr=loadMsgs();
 arr.push(m);
 localStorage.setItem(storageKey,JSON.stringify(arr));
 renderMsgs();
}

function renderMsgs(){
 const msgs=loadMsgs();
 chatWindow.innerHTML=msgs.map(m=>`
 <div style="margin-bottom:8px">
   <div style="font-size:12px;color:#64748b">${new Date(m.t).toLocaleTimeString()}</div>
   <div style="padding:8px;background:${m.own?'#e6f0ff':'#f3f6fb'};border-radius:8px">${m.text}</div>
 </div>`).join('');
 chatWindow.scrollTop=chatWindow.scrollHeight;
}

sendBtn.onclick=()=>{
 const txt=chatText.value.trim();
 if(!txt)return;
 saveMsg({t:Date.now(),text:txt,own:true});
 chatText.value="";
};

renderMsgs();

//////////////////////// MAP ////////////////////////
let map=null;
let routeLine=null;
let markerA=null;
let markerB=null;

toggleMapBtn.onclick=()=>{
 if(mapWrap.style.display==="none"){
   mapWrap.style.display="block";
   toggleMapBtn.textContent="Hide Map";
   initMap();
 }else{
   mapWrap.style.display="none";
   toggleMapBtn.textContent="Show Map";
 }
};

async function initMap(){
 if(map) return;

 map=L.map("map").setView([9.0820,8.6753],6);
 L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

 const job=await fetch(API_BASE+"/api/job/"+jobId+"/status")
               .then(r=>r.json()).then(j=>j.job);

 if(!job.lat||!job.lng||!job.assigned_tech_id) return;

 const tech=await fetch(API_BASE+"/api/user/"+job.assigned_tech_id)
                 .then(r=>r.json());

 let from,to;

 const role=(localStorage.getItem("userRole")||"").toLowerCase();

 if(role.includes("worker")){
   from=[tech.lat,tech.lng];
   to=[job.lat,job.lng];
 }else{
   from=[job.lat,job.lng];
   to=[tech.lat,tech.lng];
 }

 markerA=L.marker(from).addTo(map);
 markerB=L.marker(to).addTo(map);

 drawRoute(from,to);
}

//////////////// ROUTING ///////////////////
async function drawRoute(a,b){
 const url=`https://router.project-osrm.org/route/v1/driving/${a[1]},${a[0]};${b[1]},${b[0]}?overview=full&geometries=geojson`;
 const data=await fetch(url).then(r=>r.json());

 if(!data.routes.length) return;

 const route=data.routes[0];

 routeLine=L.geoJSON(route.geometry).addTo(map);
 map.fitBounds(routeLine.getBounds());

 const km=(route.distance/1000).toFixed(2);
 const min=Math.round(route.duration/60);

 distanceInfo.textContent=`Distance: ${km} km — ETA: ${min} minutes`;
}

//////////////// JOB STATUS ////////////////
async function loadJob(){
 const js=await fetch(API_BASE+"/api/job/"+jobId+"/status")
             .then(r=>r.json());

 const job=js.job;
 jobStatus.textContent=`Job: ${job.job_type} — ${job.status}`;
 peerName.textContent=job.assigned_tech_id||"Unassigned";
 peerRole.textContent="Connected";
}

loadJob();
setInterval(loadJob,3000);

</script>
</body>
</html>