<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect — KYC</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--accent:#0b5cff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#111}
    .wrap{max-width:720px;margin:20px auto;padding:16px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 28px rgba(2,6,23,0.06)}
    .logo{display:flex;align-items:center;justify-content:center;margin-bottom:8px}
    .logo img{width:100%;max-width:320px;height:auto;display:block}
    label{display:block;margin-top:12px;font-weight:700;color:#111}
    input[type="file"], input[type="text"], textarea, select { width:100%; padding:10px; border-radius:8px; border:1px solid #e6e9ef; background:#fff }
    .small{font-size:13px;color:var(--muted);margin-top:6px}
    .btn{background:var(--accent);color:#fff;padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .file-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumb{width:88px;height:72px;border-radius:8px;overflow:hidden;border:1px solid #e6eef9;background:#fafafa;display:flex;align-items:center;justify-content:center;position:relative}
    .thumb img, .thumb video{max-width:100%;max-height:100%;display:block}
    .thumb .remove{position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px}
    .error{color:#b91c1c;font-weight:700;margin-top:8px}
    .hidden{display:none}
    footer{margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    @media (max-width:480px){ .thumb{width:72px;height:60px} .logo img{max-width:240px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- logo only header (no heading text) -->
      <div class="logo">
        <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect logo">
      </div>

      <!-- Simple labels only (as requested) -->
      <label for="id_number">ID number</label>
      <input id="id_number" type="text" placeholder="Enter ID number">

      <label for="id_front">Front picture (ID)</label>
      <input id="id_front" type="file" accept="image/*">

      <label for="id_back">Back picture (ID)</label>
      <input id="id_back" type="file" accept="image/*">

      <!-- optional additional image slot created on demand -->
      <div id="addImageRow" class="row" style="margin-top:8px">
        <button id="addIdImageBtn" class="btn" style="background:#fff;color:var(--accent);border:1px solid rgba(11,92,255,0.12)">Add another ID image</button>
        <div class="muted" style="font-weight:600">Optional</div>
      </div>

      <div id="extraIdContainer" class="file-row"></div>
      <div id="id_preview" class="file-row" aria-live="polite"></div>

      <label for="videos_input" style="margin-top:12px">Work video (required)</label>
      <input id="videos_input" type="file" accept="video/*" multiple>
      <div class="small">Up to 2 videos. Each ≤ 3 minutes.</div>
      <div id="videos_preview" class="file-row"></div>

      <label for="notes" style="margin-top:12px">Notes (optional)</label>
      <textarea id="notes" rows="3" placeholder="Any extra info (optional)"></textarea>

      <div id="validationErrors" class="error hidden" role="alert"></div>

      <footer>
        <button id="submitBtn" class="btn">Submit KYC</button>
        <div class="muted">All docs go to admin</div>
      </footer>

      <div id="status" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- simple modal for responses -->
  <div id="overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:2000">
    <div style="background:#fff;padding:16px;border-radius:10px;max-width:320px;text-align:center">
      <div id="modalText">Processing...</div>
      <div style="margin-top:10px"><button id="modalClose" class="btn" style="background:#eef3ff;color:var(--accent)">OK</button></div>
    </div>
  </div>

<script>
(function(){
  const API_BASE = (location.hostname.includes('localhost') ? 'http://localhost:10000' : 'https://wireconnet-1.onrender.com');
  const me = JSON.parse(localStorage.getItem('wc_user') || 'null');
  if(!me){ alert('Please login'); window.location.href = 'login.html'; return; }

  // DOM
  const idNumberEl = document.getElementById('id_number');
  const idFrontEl = document.getElementById('id_front');
  const idBackEl = document.getElementById('id_back');
  const addIdImageBtn = document.getElementById('addIdImageBtn');
  const extraIdContainer = document.getElementById('extraIdContainer');
  const idPreview = document.getElementById('id_preview');

  const videosInput = document.getElementById('videos_input');
  const videosPreview = document.getElementById('videos_preview');

  const notesEl = document.getElementById('notes');
  const submitBtn = document.getElementById('submitBtn');
  const statusEl = document.getElementById('status');
  const validationErrors = document.getElementById('validationErrors');

  const overlay = document.getElementById('overlay');
  const modalText = document.getElementById('modalText');
  const modalClose = document.getElementById('modalClose');

  // state
  let extraIdInputs = []; // array of input elements
  let extraIdFiles = [];  // corresponding File objects
  let idFiles = { front: null, back: null }; // File objects
  let videoFiles = []; // File objects

  const MAX_EXTRA_ID = 3;     // allow up to 3 extra if needed
  const MAX_VIDEOS = 2;
  const MAX_VIDEO_SECONDS = 180;

  function showModal(msg){ modalText.textContent = msg; overlay.style.display = 'flex'; }
  function hideModal(){ overlay.style.display = 'none'; }
  modalClose.addEventListener('click', hideModal);

  function showValidation(msg){
    validationErrors.textContent = msg;
    validationErrors.classList.remove('hidden');
  }
  function clearValidation(){
    validationErrors.textContent = '';
    validationErrors.classList.add('hidden');
  }

  // preview helpers
  function renderIdPreview(){
    idPreview.innerHTML = '';
    const list = [];
    if(idFiles.front) list.push({ f: idFiles.front, label: 'Front' });
    if(idFiles.back) list.push({ f: idFiles.back, label: 'Back' });
    extraIdFiles.forEach(f=> list.push({ f, label: 'Extra' }));
    list.forEach((item, idx) => {
      const box = document.createElement('div'); box.className = 'thumb';
      const img = document.createElement('img'); img.src = URL.createObjectURL(item.f); img.alt = item.label;
      box.appendChild(img);
      const rm = document.createElement('div'); rm.className = 'remove'; rm.innerText = '×';
      rm.addEventListener('click', ()=> {
        URL.revokeObjectURL(img.src);
        // remove from state
        if(idx === 0 && idFiles.front) { idFiles.front = null; idFrontEl.value = ''; }
        else if(idx === 1 && idFiles.back && idFiles.front) { idFiles.back = null; idBackEl.value = ''; }
        else {
          // extra index calculation
          const extrasStart = (idFiles.front ? 1 : 0) + (idFiles.back ? 1 : 0);
          const extraIdx = idx - extrasStart;
          if(extraIdx >= 0) {
            extraIdFiles.splice(extraIdx,1);
            // also remove corresponding extra input (if present)
            const inp = extraIdInputs[extraIdx];
            if(inp){ extraIdContainer.removeChild(inp); extraIdInputs.splice(extraIdx,1); }
          }
        }
        renderIdPreview();
      });
      box.appendChild(rm);
      idPreview.appendChild(box);
    });
  }

  function renderVideoPreview(){
    videosPreview.innerHTML = '';
    videoFiles.forEach((file, idx) => {
      const box = document.createElement('div'); box.className = 'thumb';
      const vid = document.createElement('video'); vid.preload='metadata'; vid.muted=true; vid.playsInline=true;
      vid.src = URL.createObjectURL(file);
      box.appendChild(vid);
      const rm = document.createElement('div'); rm.className='remove'; rm.innerText='×';
      rm.addEventListener('click', ()=> {
        URL.revokeObjectURL(vid.src);
        videoFiles.splice(idx,1);
        renderVideoPreview();
      });
      box.appendChild(rm);
      videosPreview.appendChild(box);
    });
  }

  // file input handlers
  idFrontEl.addEventListener('change', (e)=>{
    clearValidation();
    const f = e.target.files && e.target.files[0];
    if(f && f.type.startsWith('image/')) { idFiles.front = f; renderIdPreview(); }
    else { idFiles.front = null; idFrontEl.value=''; }
  });
  idBackEl.addEventListener('change', (e)=>{
    clearValidation();
    const f = e.target.files && e.target.files[0];
    if(f && f.type.startsWith('image/')) { idFiles.back = f; renderIdPreview(); }
    else { idFiles.back = null; idBackEl.value=''; }
  });

  addIdImageBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    clearValidation();
    if(extraIdInputs.length >= MAX_EXTRA_ID) { showValidation('Max extra ID images reached'); return; }
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.style.display = 'block';
    input.addEventListener('change', (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      if(!f.type.startsWith('image/')) { showValidation('Select an image file'); return; }
      extraIdFiles.push(f);
      renderIdPreview();
    });
    extraIdInputs.push(input);
    extraIdContainer.appendChild(input);
    // auto-click to open chooser
    input.click();
  });

  videosInput.addEventListener('change', async (e)=>{
    clearValidation();
    const files = Array.from(e.target.files || []);
    // append respecting max
    for(const f of files){
      if(videoFiles.length >= MAX_VIDEOS) break;
      if(!f.type.startsWith('video/')) continue;
      videoFiles.push(f);
    }
    // validate durations
    const problems = await validateVideoDurations(videoFiles);
    if(problems.length){
      showValidation(problems.join('\n'));
      // remove offending files
      videoFiles = videoFiles.filter(v => !problems.some(p => p.includes(v.name)));
    }
    videosInput.value = '';
    renderVideoPreview();
  });

  // verify video durations (returns array of error msgs)
  function validateVideoDurations(files){
    const checks = files.map(f => new Promise((resolve) => {
      const url = URL.createObjectURL(f);
      const v = document.createElement('video'); v.preload='metadata';
      v.src = url;
      const onloaded = ()=> {
        const d = v.duration || 0;
        URL.revokeObjectURL(url);
        v.remove();
        if(d > MAX_VIDEO_SECONDS) resolve(`"${f.name}" is ${Math.round(d)}s — over ${MAX_VIDEO_SECONDS}s`);
        else resolve(null);
      };
      const onerror = ()=> { URL.revokeObjectURL(url); v.remove(); resolve(null); };
      v.addEventListener('loadedmetadata', onloaded, {once:true});
      v.addEventListener('error', onerror, {once:true});
    } ));
    return Promise.all(checks).then(results => results.filter(Boolean));
  }

  // final submit
  submitBtn.addEventListener('click', async ()=>{
    clearValidation();
    statusEl.textContent = '';

    const idNumber = (idNumberEl.value || '').trim();
    if(!idNumber){ showValidation('Enter ID number'); return; }
    if(!idFiles.front){ showValidation('Upload front picture of ID'); return; }
    if(!idFiles.back){ showValidation('Upload back picture of ID'); return; }
    if(videoFiles.length === 0){ showValidation('Upload at least one work video (required)'); return; }
    if(videoFiles.length > MAX_VIDEOS){ showValidation('Max 2 videos allowed'); return; }

    // validate durations again before send
    const durationProblems = await validateVideoDurations(videoFiles);
    if(durationProblems.length){ showValidation(durationProblems.join('\n')); return; }

    // Build FormData
    const form = new FormData();
    form.append('userId', me.id);
    form.append('id_type', 'unknown'); // frontend kept minimal; backend can ignore or you can add a select if needed
    form.append('id_number', idNumber);
    form.append('notes', notesEl.value || '');

    // append id files: front, back, extras
    form.append('id_images', idFiles.front, idFiles.front.name || 'id_front.jpg');
    form.append('id_images', idFiles.back, idFiles.back.name || 'id_back.jpg');
    extraIdFiles.forEach(f => form.append('id_images', f, f.name));

    // append videos
    videoFiles.forEach(f => form.append('work_videos', f, f.name));

    // hint to server that this is multipart
    form.append('_multipart','1');

    try{
      showModal('Uploading — please wait...');
      const resp = await fetch(`${API_BASE}/api/kyc/submit`, { method:'POST', body: form, credentials:'include' });
      let data = null;
      try{ data = await resp.json(); } catch(e){ data = null; }
      if(resp.ok && data && data.success){
        // mark local user as pending
        me.kyc_status = 'pending';
        localStorage.setItem('wc_user', JSON.stringify(me));
        showModal('Submitted — awaiting review');
        setTimeout(()=> { hideModal(); window.location.href = 'dashboard.html'; }, 1200);
      } else {
        showModal('Submission failed: ' + ((data && data.message) ? data.message : ('HTTP ' + resp.status)));
      }
    }catch(err){
      console.error(err);
      showModal('Network error while submitting. Try again.');
    }
  });

  // helper: auto-save last-known coords if available (unchanged)
  (function trySaveGeo(){
    try{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          try{ localStorage.setItem('wc_last_lat', String(pos.coords.latitude)); localStorage.setItem('wc_last_lng', String(pos.coords.longitude)); }catch(e){}
        }, ()=>{}, { maximumAge: 10000, timeout: 3500 });
      }
    }catch(e){}
  })();

})();
</script>
</body>
</html>