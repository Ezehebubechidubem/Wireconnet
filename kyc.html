<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect — KYC</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--accent:#0b5cff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#111}
    .wrap{max-width:720px;margin:18px auto;padding:14px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 28px rgba(2,6,23,0.06)}
    .logo{display:flex;align-items:center;justify-content:center;margin-bottom:8px}
    .logo img{width:100%;max-width:320px;height:auto;display:block}
    label{display:block;margin-top:12px;font-weight:700;color:#111;font-size:15px}
    .input, .choose-btn { width:100%; padding:12px; border-radius:10px; border:1px solid #e6e9ef; background:#fff; display:block; text-align:left; font-size:14px }
    .choose-btn{cursor:pointer; display:flex;align-items:center;gap:10px; justify-content:space-between}
    .choose-btn small{color:var(--muted);font-weight:600}
    .small{font-size:13px;color:var(--muted);margin-top:6px}
    .btn{background:var(--accent);color:#fff;padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .file-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .thumb{width:90px;height:72px;border-radius:8px;overflow:hidden;border:1px solid #e6eef9;background:#fafafa;display:flex;align-items:center;justify-content:center;position:relative}
    .thumb img, .thumb video{max-width:100%;max-height:100%;display:block}
    .thumb .remove{position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px}
    .error{color:#b91c1c;font-weight:700;margin-top:8px}
    .hidden{display:none}
    footer{margin-top:14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    @media (max-width:480px){ .thumb{width:72px;height:60px} .logo img{max-width:240px} }
    /* hide native file inputs; we trigger them via labels */
    input[type="file"].native { display:none; }
    /* simple modal style */
    .modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:2000; }
    .modal{ background:#fff; padding:14px; border-radius:10px; width:320px; max-width:90%; text-align:center; box-shadow:0 12px 36px rgba(0,0,0,0.18); }
    .modal .actions{ display:flex; gap:8px; justify-content:center; margin-top:12px; }
    .modal button{ padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .btn-outline{ background:#fff; border:1px solid #e6eef9; color:#111 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- logo-only header -->
      <div class="logo">
        <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect logo">
      </div>

      <!-- ID type selector (before id name and id number) -->
      <label for="id_type">ID type</label>
      <select id="id_type" class="input" aria-label="ID type">
        <option value="national_id">National ID</option>
        <option value="driver_license">Driver's License</option>
        <option value="passport">Passport</option>
      </select>

      <!-- NEW: ID name (added as requested) -->
      <label for="id_name">Name on ID</label>
      <input id="id_name" class="input" type="text" placeholder="Name exactly as on the ID" />

      <label for="id_number">ID number</label>
      <input id="id_number" class="input" type="text" placeholder="Enter ID number" />

      <!-- front/back file inputs: hidden native with capture attribute (kept as-is) -->
      <label for="id_front_btn">Front picture (ID)</label>
      <input id="id_front" class="native" type="file" accept="image/*" capture="environment">
      <label id="id_front_btn" class="choose-btn" data-target="front" tabindex="0">
        <span>Choose file — front</span>
        <small>Camera or files</small>
      </label>

      <label for="id_back_btn">Back picture (ID)</label>
      <input id="id_back" class="native" type="file" accept="image/*" capture="environment">
      <label id="id_back_btn" class="choose-btn" data-target="back" tabindex="0">
        <span>Choose file — back</span>
        <small>Camera or files</small>
      </label>

      <div id="id_preview" class="file-row" aria-live="polite"></div>

      <!-- videos: required -->
      <label for="videos_input_btn" style="margin-top:12px">Work video (required)</label>
      <input id="videos_input" class="native" type="file" accept="video/*" capture="camcorder" multiple>
      <label id="videos_input_btn" class="choose-btn" data-target="videos" tabindex="0">
        <span>Choose videos (up to 2)</span>
        <small>Record or files</small>
      </label>
      <div class="small">Up to 2 videos. Each ≤ 3 minutes.</div>
      <div id="videos_preview" class="file-row"></div>

      <div id="validationErrors" class="error hidden" role="alert"></div>

      <footer>
        <button id="submitBtn" class="btn">Submit</button>
        <div class="muted">All docs go to admin</div>
      </footer>

      <div id="status" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- pop modal to choose Camera vs Upload -->
  <div class="modal-backdrop" id="choiceModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="choiceTitle">
      <div id="choiceTitle" style="font-weight:800">Choose upload method</div>
      <div class="muted" style="margin-top:8px">Use camera to take a new photo/video or choose from your files</div>
      <div class="actions">
        <button id="cameraBtn" class="btn-outline">Use Camera</button>
        <button id="filesBtn" class="btn">Upload from files</button>
      </div>
      <div style="margin-top:10px"><button id="choiceCancel" class="btn-outline">Cancel</button></div>
    </div>
  </div>

  <!-- modal for upload status -->
  <div id="overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:2000">
    <div style="background:#fff;padding:16px;border-radius:10px;max-width:320px;text-align:center">
      <div id="modalText">Processing...</div>
      <div style="margin-top:10px"><button id="modalClose" class="btn" style="background:#eef3ff;color:var(--accent)">OK</button></div>
    </div>
  </div>

<script>
(function(){
  const API_BASE = (location.hostname.includes('localhost') ? 'http://localhost:10000' : 'https://wireconnet-1.onrender.com');
  const me = JSON.parse(localStorage.getItem('wc_user') || 'null');
  if(!me){ alert('Please login'); window.location.href = 'login.html'; return; }

  // DOM
  const idTypeEl = document.getElementById('id_type');
  const idNameEl = document.getElementById('id_name');
  const idNumberEl = document.getElementById('id_number');

  // native (kept) inputs
  const idFrontNative = document.getElementById('id_front');
  const idBackNative = document.getElementById('id_back');
  const videosNative = document.getElementById('videos_input');

  // visible labels / buttons
  const idFrontBtn = document.getElementById('id_front_btn');
  const idBackBtn  = document.getElementById('id_back_btn');
  const videosBtn  = document.getElementById('videos_input_btn');

  const idPreview = document.getElementById('id_preview');
  const videosPreview = document.getElementById('videos_preview');

  const submitBtn = document.getElementById('submitBtn');
  const statusEl = document.getElementById('status');
  const validationErrors = document.getElementById('validationErrors');

  const choiceModal = document.getElementById('choiceModal');
  const cameraBtn = document.getElementById('cameraBtn');
  const filesBtn = document.getElementById('filesBtn');
  const choiceCancel = document.getElementById('choiceCancel');

  const overlay = document.getElementById('overlay'), modalText = document.getElementById('modalText'), modalClose = document.getElementById('modalClose');

  // state
  let idFiles = { front: null, back: null };
  let videoFiles = [];
  let currentTarget = null; // 'front' | 'back' | 'videos'
  const MAX_VIDEOS = 2;
  const MAX_VIDEO_SECONDS = 180; // 3 minutes

  // show/hide modals
  function openChoice(target){
    currentTarget = target;
    choiceModal.style.display = 'flex';
  }
  function closeChoice(){
    choiceModal.style.display = 'none';
    currentTarget = null;
  }
  cameraBtn.addEventListener('click', ()=> handleChoice('camera'));
  filesBtn.addEventListener('click', ()=> handleChoice('files'));
  choiceCancel.addEventListener('click', closeChoice);

  function showModal(msg){ modalText.textContent = msg; overlay.style.display = 'flex'; }
  function hideModal(){ overlay.style.display = 'none'; }
  modalClose.addEventListener('click', hideModal);

  function showValidation(msg){
    validationErrors.textContent = msg;
    validationErrors.classList.remove('hidden');
  }
  function clearValidation(){
    validationErrors.textContent = '';
    validationErrors.classList.add('hidden');
  }

  // preview helpers (same as before)
  function renderIdPreview(){
    idPreview.innerHTML = '';
    const list = [];
    if(idFiles.front) list.push({ f: idFiles.front, label: 'Front' });
    if(idFiles.back) list.push({ f: idFiles.back, label: 'Back' });
    list.forEach((item, idx) => {
      const box = document.createElement('div'); box.className = 'thumb';
      const img = document.createElement('img'); img.src = URL.createObjectURL(item.f); img.alt = item.label;
      box.appendChild(img);
      const rm = document.createElement('div'); rm.className = 'remove'; rm.innerText = '×';
      rm.addEventListener('click', ()=> {
        URL.revokeObjectURL(img.src);
        if(item.label === 'Front'){ idFiles.front = null; idFrontNative.value = ''; }
        else { idFiles.back = null; idBackNative.value = ''; }
        renderIdPreview();
      });
      box.appendChild(rm);
      idPreview.appendChild(box);
    });
  }

  function renderVideoPreview(){
    videosPreview.innerHTML = '';
    videoFiles.forEach((file, idx) => {
      const box = document.createElement('div'); box.className = 'thumb';
      const vid = document.createElement('video'); vid.preload='metadata'; vid.muted=true; vid.playsInline=true; vid.controls=true;
      vid.src = URL.createObjectURL(file);
      box.appendChild(vid);
      const rm = document.createElement('div'); rm.className='remove'; rm.innerText='×';
      rm.addEventListener('click', ()=> {
        URL.revokeObjectURL(vid.src);
        videoFiles.splice(idx,1);
        renderVideoPreview();
      });
      box.appendChild(rm);
      videosPreview.appendChild(box);
    });
  }

  // Existing native change handlers (kept for fallback if user uses native inputs directly)
  idFrontNative.addEventListener('change', (e)=>{
    clearValidation();
    const f = e.target.files && e.target.files[0];
    if(f && f.type.startsWith('image/')) { idFiles.front = f; renderIdPreview(); }
    else { idFiles.front = null; idFrontNative.value=''; renderIdPreview(); }
  });
  idBackNative.addEventListener('change', (e)=>{
    clearValidation();
    const f = e.target.files && e.target.files[0];
    if(f && f.type.startsWith('image/')) { idFiles.back = f; renderIdPreview(); }
    else { idFiles.back = null; idBackNative.value=''; renderIdPreview(); }
  });
  videosNative.addEventListener('change', async (e)=>{
    clearValidation();
    const files = Array.from(e.target.files || []);
    for(const f of files){
      if(videoFiles.length >= MAX_VIDEOS) break;
      if(!f.type.startsWith('video/')) continue;
      videoFiles.push(f);
    }
    const problems = await validateVideoDurations(videoFiles);
    if(problems.length){
      showValidation(problems.join('\n'));
      videoFiles = videoFiles.filter(v => !problems.some(p => p.includes(v.name)));
    }
    videosNative.value = '';
    renderVideoPreview();
  });

  // attach click handlers to visible buttons (they open our choice modal)
  idFrontBtn.addEventListener('click', ()=> openChoice('front'));
  idBackBtn.addEventListener('click', ()=> openChoice('back'));
  videosBtn.addEventListener('click', ()=> openChoice('videos'));

  // keyboard accessibility (Enter)
  [idFrontBtn, idBackBtn, videosBtn].forEach(btn=>{
    btn.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); } });
  });

  // handle choice: create temporary file input with appropriate capture attr and click it
  async function handleChoice(kind){
    closeChoice();
    clearValidation();
    if(!['front','back','videos'].includes(currentTarget)){
      // if currentTarget null, but kind passed, set currentTarget to kind
    }
    const target = currentTarget || kind;
    let accept = 'image/*';
    let capture = 'environment';
    let multiple = false;
    if(target === 'videos'){
      accept = 'video/*';
      capture = 'camcorder';
      multiple = true;
    } else {
      accept = 'image/*';
      capture = 'environment';
      multiple = false;
    }

    if(kind === 'files'){ // open file chooser without capture attribute
      capture = null;
    } // else keep capture for camera

    // create temporary input
    const tmp = document.createElement('input');
    tmp.type = 'file';
    tmp.accept = accept;
    if(multiple) tmp.multiple = true;
    if(capture) tmp.setAttribute('capture', capture);

    // listening to selection
    tmp.addEventListener('change', async (ev)=>{
      const files = Array.from(ev.target.files || []);
      if(target === 'front' || target === 'back'){
        const f = files[0];
        if(!f) return;
        if(!f.type.startsWith('image/')) { showValidation('Select an image file'); return; }
        // assign to state and also mirror to native input's value by not possible; instead set native input file is not possible programmatically
        // we keep native inputs as-is (they are for fallback). We update our state & preview directly:
        if(target === 'front'){ idFiles.front = f; idFrontNative.value = ''; } // clear native input
        else { idFiles.back = f; idBackNative.value = ''; }
        renderIdPreview();
      } else if(target === 'videos'){
        // append respecting MAX_VIDEOS
        for(const f of files){
          if(videoFiles.length >= MAX_VIDEOS) break;
          if(!f.type.startsWith('video/')) continue;
          videoFiles.push(f);
        }
        const problems = await validateVideoDurations(videoFiles);
        if(problems.length){
          showValidation(problems.join('\n'));
          videoFiles = videoFiles.filter(v => !problems.some(p => p.includes(v.name)));
        }
        renderVideoPreview();
      }
      // remove tmp input afterwards
      tmp.remove();
    });

    // click the input to open chooser / camera
    document.body.appendChild(tmp); // required for some browsers
    tmp.click();

    // note: some browsers (esp desktop) ignore capture; on mobile it triggers camera
  }

  // validate video durations (client-side)
  function validateVideoDurations(files){
    const checks = files.map(f => new Promise((resolve) => {
      const url = URL.createObjectURL(f);
      const v = document.createElement('video'); v.preload='metadata';
      v.src = url;
      const onloaded = ()=>{
        const d = v.duration || 0;
        URL.revokeObjectURL(url);
        v.remove();
        if(d > MAX_VIDEO_SECONDS) resolve(`"${f.name}" is ${Math.round(d)}s — over ${MAX_VIDEO_SECONDS}s`);
        else resolve(null);
      };
      const onerror = ()=> { URL.revokeObjectURL(url); v.remove(); resolve(null); };
      v.addEventListener('loadedmetadata', onloaded, {once:true});
      v.addEventListener('error', onerror, {once:true});
    }));
    return Promise.all(checks).then(results => results.filter(Boolean));
  }

  // final submit (keeps same endpoints & behavior)
  submitBtn.addEventListener('click', async ()=>{
    clearValidation();
    statusEl.textContent = '';

    const idNumber = (idNumberEl.value || '').trim();
    const idName = (idNameEl.value || '').trim();
    const idType = idTypeEl.value || 'unknown';

    if(!idName){ showValidation('Enter name on ID'); return; }
    if(!idNumber){ showValidation('Enter ID number'); return; }
    if(!idFiles.front){ showValidation('Upload front picture of ID'); return; }
    if(!idFiles.back){ showValidation('Upload back picture of ID'); return; }
    if(videoFiles.length === 0){ showValidation('Upload at least one work video (required)'); return; }
    if(videoFiles.length > MAX_VIDEOS){ showValidation('Max 2 videos allowed'); return; }

    const durationProblems = await validateVideoDurations(videoFiles);
    if(durationProblems.length){ showValidation(durationProblems.join('\n')); return; }

    const form = new FormData();
    form.append('userId', me.id);
    form.append('id_type', idType);
    form.append('id_name', idName);
    form.append('id_number', idNumber);

    // append id images
    form.append('id_images', idFiles.front, idFiles.front.name || 'id_front.jpg');
    form.append('id_images', idFiles.back, idFiles.back.name || 'id_back.jpg');

    // append videos
    videoFiles.forEach(f => form.append('work_videos', f, f.name));

    form.append('_multipart','1');

    try{
      showModal('Uploading — please wait...');
      const resp = await fetch(API_BASE + '/api/kyc/submit', { method: 'POST', body: form });
      let data = null;
      try{ data = await resp.json(); } catch(e){ data = null; }

      if(resp.ok && data && data.success){
        me.kyc_status = 'pending';
        localStorage.setItem('wc_user', JSON.stringify(me));
        showModal('Submitted — awaiting review');
        setTimeout(()=> { hideModal(); window.location.href = 'dashboard.html'; }, 1200);
      } else {
        showModal('Submission failed: ' + ((data && data.message) ? data.message : ('HTTP ' + resp.status)));
      }
    }catch(err){
      console.error(err);
      showModal('Network error while submitting. Try again.');
    }
  });

  // unobtrusive geo save as before
  (function trySaveGeo(){
    try{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          try{ localStorage.setItem('wc_last_lat', String(pos.coords.latitude)); localStorage.setItem('wc_last_lng', String(pos.coords.longitude)); }catch(e){}
        }, ()=>{}, { maximumAge: 10000, timeout: 3500 });
      }
    }catch(e){}
  })();

})();
</script>
</body>
</html>