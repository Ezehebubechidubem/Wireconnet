<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect — KYC (with selfie + debug)</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--accent:#0b5cff;--muted:#6b7280;--danger:#b91c1c}
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#111}
    .wrap{max-width:820px;margin:18px auto;padding:14px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 28px rgba(2,6,23,0.06)}
    .logo{display:flex;align-items:center;justify-content:center;margin-bottom:8px}
    .logo img{width:100%;max-width:320px;height:auto;display:block}
    label{display:block;margin-top:12px;font-weight:700;color:#111;font-size:15px}
    .input, .choose-btn { width:100%; padding:12px; border-radius:10px; border:1px solid #e6e9ef; background:#fff; display:block; text-align:left; font-size:14px }
    .choose-btn{cursor:pointer; display:flex;align-items:center;gap:10px; justify-content:space-between}
    .choose-btn small{color:var(--muted);font-weight:600}
    .small{font-size:13px;color:var(--muted);margin-top:6px}
    .btn{background:var(--accent);color:#fff;padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .file-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .thumb{width:120px;height:96px;border-radius:8px;overflow:hidden;border:1px solid #e6eef9;background:#fafafa;display:flex;align-items:center;justify-content:center;position:relative;flex-direction:column;padding:6px}
    .thumb img, .thumb video{max-width:100%;max-height:100%;display:block}
    .thumb .label { font-size:12px; color:var(--muted); margin-top:6px; font-weight:700 }
    .thumb .remove{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px}
    .status-box{margin-top:12px;padding:10px;border-radius:8px;background:#fff;border:1px solid #eef2f6}
    .status-message{font-weight:700}
    .admin-note{margin-top:8px;color:var(--danger);font-weight:700}
    .error{color:#b91c1c;font-weight:700;margin-top:8px}
    .hidden{display:none}
    footer{margin-top:14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    @media (max-width:480px){ .thumb{width:96px;height:76px} .logo img{max-width:240px} }
    input[type="file"].native { display:none; }
    .modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:2000; }
    .modal{ background:#fff; padding:14px; border-radius:10px; width:360px; max-width:90%; text-align:center; box-shadow:0 12px 36px rgba(0,0,0,0.18); }
    .modal .actions{ display:flex; gap:8px; justify-content:center; margin-top:12px; }
    .modal button{ padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .btn-outline{ background:#fff; border:1px solid #e6eef9; color:#111 }
    /* debug panel */
    .debug-wrap { margin-top:14px; display:flex; gap:12px; align-items:flex-start; }
    .debug-controls { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .debug-panel { background:#0b1220; color:#e6f0ff; padding:12px; border-radius:10px; font-family:monospace; font-size:13px; max-height:360px; overflow:auto; white-space:pre-wrap; width:100%; box-sizing:border-box; }
    .debug-toggle { margin-left:auto; }
    .pill { background:#e6eef9; color:#0b1220; padding:6px 8px; border-radius:999px; font-weight:700; font-size:12px }
    .preview-col { min-width:280px; }
    .flex { display:flex; gap:12px; }
    .flex .card-preview { flex:1; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="logo">
        <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect logo">
      </div>

      <!-- ID type -->
      <label for="id_type">ID type</label>
      <select id="id_type" class="input" aria-label="ID type">
        <option value="national_id">National ID</option>
        <option value="driver_license">Driver's License</option>
        <option value="passport">Passport</option>
      </select>

      <!-- ID name -->
      <label for="id_name">Name on ID</label>
      <input id="id_name" class="input" type="text" placeholder="Name exactly as on the ID" />

      <label for="id_number">ID number</label>
      <input id="id_number" class="input" type="text" placeholder="Enter ID number" />

      <!-- native file inputs (kept) -->
      <label for="id_front_btn">Front picture (ID)</label>
      <input id="id_front" class="native" type="file" accept="image/*" capture="environment">
      <label id="id_front_btn" class="choose-btn" data-target="front" tabindex="0">
        <span>Choose file — front</span>
        <small>Camera or files</small>
      </label>

      <label for="id_back_btn">Back picture (ID)</label>
      <input id="id_back" class="native" type="file" accept="image/*" capture="environment">
      <label id="id_back_btn" class="choose-btn" data-target="back" tabindex="0">
        <span>Choose file — back</span>
        <small>Camera or files</small>
      </label>

      <!-- selfie / user photo -->
      <label for="selfie_btn">Selfie (your photo)</label>
      <input id="selfie" class="native" type="file" accept="image/*" capture="user">
      <label id="selfie_btn" class="choose-btn" data-target="selfie" tabindex="0">
        <span>Take / upload selfie</span>
        <small>Front camera or files</small>
      </label>

      <div id="id_preview" class="file-row" aria-live="polite"></div>

      <!-- videos -->
      <label for="videos_input_btn" style="margin-top:12px">Work video (required)</label>
      <input id="videos_input" class="native" type="file" accept="video/*" capture="camcorder" multiple>
      <label id="videos_input_btn" class="choose-btn" data-target="videos" tabindex="0">
        <span>Choose videos (up to 2)</span>
        <small>Record or files</small>
      </label>
      <div class="small">Up to 2 videos. Each ≤ 3 minutes.</div>
      <div id="videos_preview" class="file-row"></div>

      <div id="validationErrors" class="error hidden" role="alert"></div>

      <div id="statusBox" class="status-box hidden" aria-live="polite">
        <div id="statusText" class="status-message"></div>
        <div id="statusSub" class="muted"></div>
        <div id="adminNote" class="admin-note hidden"></div>
      </div>

      <footer>
        <button id="submitBtn" class="btn">Submit</button>
        <div class="muted">All docs go to admin</div>
      </footer>

      <!-- modal to select camera or files -->
      <div class="modal-backdrop" id="choiceModal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="choiceTitle">
          <div id="choiceTitle" style="font-weight:800">Choose upload method</div>
          <div class="muted" style="margin-top:8px">Use camera to take a new photo/video or choose from your files</div>
          <div class="actions">
            <button id="cameraBtn" class="btn-outline">Use Camera</button>
            <button id="filesBtn" class="btn">Upload from files</button>
          </div>
          <div style="margin-top:10px"><button id="choiceCancel" class="btn-outline">Cancel</button></div>
        </div>
      </div>

      <!-- upload status modal -->
      <div id="overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:2000">
        <div style="background:#fff;padding:16px;border-radius:10px;max-width:320px;text-align:center">
          <div id="modalText">Processing...</div>
          <div style="margin-top:10px"><button id="modalClose" class="btn" style="background:#eef3ff;color:var(--accent)">OK</button></div>
        </div>
      </div>

      <!-- debug panel -->
      <div class="debug-wrap">
        <div style="flex:1">
          <div class="debug-controls">
            <div class="pill">DEBUG</div>
            <button id="clearDebug" class="btn-outline" style="margin-left:8px">Clear</button>
            <button id="copyDebug" class="btn-outline">Copy</button>
            <label style="margin-left:auto; font-weight:700; color:var(--muted)">Auto-scroll</label>
            <input id="autoScroll" type="checkbox" checked style="margin-left:6px" />
          </div>
          <div id="debugPanel" class="debug-panel" aria-live="polite"></div>
        </div>
      </div>

    </div>
  </div>

<script>
(function(){
  const API_BASE = 'https://wireconnet-1.onrender.com';

  // read logged user from localStorage
  const me = JSON.parse(localStorage.getItem('wc_user') || 'null');
  if(!me){
    alert('Please login');
    window.location.href = 'login.html';
    return;
  }

  // DOM
  const idTypeEl = document.getElementById('id_type');
  const idNameEl = document.getElementById('id_name');
  const idNumberEl = document.getElementById('id_number');

  const idFrontNative = document.getElementById('id_front');
  const idBackNative = document.getElementById('id_back');
  const selfieNative = document.getElementById('selfie');
  const videosNative = document.getElementById('videos_input');

  const idFrontBtn = document.getElementById('id_front_btn');
  const idBackBtn  = document.getElementById('id_back_btn');
  const selfieBtn  = document.getElementById('selfie_btn');
  const videosBtn  = document.getElementById('videos_input_btn');

  const idPreview = document.getElementById('id_preview');
  const videosPreview = document.getElementById('videos_preview');

  const submitBtn = document.getElementById('submitBtn');
  const validationErrors = document.getElementById('validationErrors');

  const statusBox = document.getElementById('statusBox');
  const statusText = document.getElementById('statusText');
  const statusSub = document.getElementById('statusSub');
  const adminNoteEl = document.getElementById('adminNote');

  const choiceModal = document.getElementById('choiceModal');
  const cameraBtn = document.getElementById('cameraBtn');
  const filesBtn = document.getElementById('filesBtn');
  const choiceCancel = document.getElementById('choiceCancel');

  const overlay = document.getElementById('overlay'), modalText = document.getElementById('modalText'), modalClose = document.getElementById('modalClose');

  // debug
  const debugPanel = document.getElementById('debugPanel');
  const clearDebugBtn = document.getElementById('clearDebug');
  const copyDebugBtn = document.getElementById('copyDebug');
  const autoScrollCheckbox = document.getElementById('autoScroll');

  // state
  let idFiles = { front: null, back: null, selfie: null };
  let videoFiles = [];
  let currentTarget = null; // 'front' | 'back' | 'selfie' | 'videos'
  const MAX_VIDEOS = 2;
  const MAX_VIDEO_SECONDS = 180; // 3 minutes
  let uploading = false;

  // server values (updated by fetchServerKycStatus)
  let serverUser = null;
  let serverLatest = null;

  // ---------- debug helpers ----------
  function now(){ return new Date().toISOString(); }
  function appendDebug(text){
    const line = `[${now()}] ${text}`;
    debugPanel.textContent = line + '\n\n' + debugPanel.textContent;
    if(autoScrollCheckbox.checked) {
      debugPanel.scrollTop = 0;
    }
    console.log(line);
  }
  clearDebugBtn.addEventListener('click', ()=> { debugPanel.textContent = ''; });
  copyDebugBtn.addEventListener('click', async ()=> {
    try {
      await navigator.clipboard.writeText(debugPanel.textContent || '');
      appendDebug('Copied debug log to clipboard');
    } catch(e){ appendDebug('Failed to copy debug: ' + String(e)); }
  });

  // helper: normalize server-stored path/URL to usable src
  function normalizeUrl(p){
    if(!p) return null;
    if(typeof p !== 'string') return null;
    if(p.startsWith('http://') || p.startsWith('https://')) return p;
    if(p.startsWith('/')) return API_BASE + p;
    if(p.indexOf('/') === -1) return API_BASE + '/uploads/kyc/' + p;
    return API_BASE + '/' + p;
  }

  // fetch server status and latest request
  async function fetchServerKycStatus(){
    try {
      appendDebug('Fetching KYC status ' + API_BASE + '/api/kyc/status/' + me.id);
      const resp = await fetch(API_BASE + '/api/kyc/status/' + encodeURIComponent(me.id));
      const raw = await resp.text().catch(()=>null);
      appendDebug('KYC status response: HTTP ' + resp.status + ' — raw: ' + (raw || '(empty)'));
      let parsed = null;
      try { parsed = raw ? JSON.parse(raw) : null; } catch(e){ parsed = null; appendDebug('KYC status parse error: ' + e); }
      if(resp.ok && parsed && parsed.success){
        serverUser = parsed.user || null;
        serverLatest = parsed.latest_request || null;
        appendDebug('KYC status parsed OK: user.kyc_status=' + (serverUser && serverUser.kyc_status));
      } else {
        // handle non-ok
        appendDebug('KYC status fetch returned non-ok or invalid JSON');
        serverUser = parsed && parsed.user ? parsed.user : null;
        serverLatest = parsed && parsed.latest_request ? parsed.latest_request : null;
      }
      renderServerStatus();
      return { raw, parsed, status: resp.status };
    } catch(e){
      appendDebug('Error fetching KYC status: ' + String(e));
      console.error(e);
      serverUser = null; serverLatest = null;
      renderServerStatus();
      return { error: e };
    }
  }

  function renderServerStatus(){
    const status = (serverUser && serverUser.kyc_status) ? String(serverUser.kyc_status).toLowerCase() : (serverLatest && serverLatest.status ? serverLatest.status : null);
    if(status){
      statusBox.classList.remove('hidden');
      statusText.innerText = 'KYC status: ' + status;
      statusSub.innerText = serverLatest && serverLatest.submitted_at ? 'Last submitted: ' + new Date(serverLatest.submitted_at).toLocaleString() : '';
    } else {
      statusBox.classList.add('hidden');
      statusText.innerText = '';
      statusSub.innerText = '';
    }
    if(serverLatest && serverLatest.admin_note){
      adminNoteEl.classList.remove('hidden');
      adminNoteEl.innerText = 'Admin note: ' + serverLatest.admin_note;
    } else {
      adminNoteEl.classList.add('hidden');
      adminNoteEl.innerText = '';
    }
    renderPreviouslySubmitted();
    const lockedStatuses = ['pending', 'approved', 'approved_by_admin'];
    const locked = status && lockedStatuses.includes(status);
    setSubmissionLocked(locked);
  }

  function renderPreviouslySubmitted(){
    const existingPrev = document.getElementById('previousSubmissionWrap');
    if(existingPrev) existingPrev.remove();
    if(!serverLatest) return;
    const wrap = document.createElement('div');
    wrap.id = 'previousSubmissionWrap';
    wrap.style.marginTop = '10px';

    if(Array.isArray(serverLatest.id_images) && serverLatest.id_images.length){
      const title = document.createElement('div'); title.style.fontWeight = 700; title.style.marginTop = '10px'; title.innerText = 'Previously submitted ID images';
      wrap.appendChild(title);
      const row = document.createElement('div'); row.className = 'file-row';
      serverLatest.id_images.forEach(p => {
        const url = normalizeUrl(p);
        const box = document.createElement('div'); box.className = 'thumb';
        const img = document.createElement('img'); img.src = url; img.alt = 'previous id';
        img.onerror = ()=>{ img.style.opacity = 0.6; img.alt='(unavailable)'; };
        box.appendChild(img);
        row.appendChild(box);
      });
      wrap.appendChild(row);
    }
    if(serverLatest.selfie){
      const title = document.createElement('div'); title.style.fontWeight = 700; title.style.marginTop = '10px'; title.innerText = 'Previously submitted selfie';
      wrap.appendChild(title);
      const row = document.createElement('div'); row.className = 'file-row';
      const box = document.createElement('div'); box.className = 'thumb';
      const img = document.createElement('img'); img.src = normalizeUrl(serverLatest.selfie); img.alt = 'previous selfie';
      img.onerror = ()=>{ img.style.opacity = 0.6; img.alt='(unavailable)'; };
      box.appendChild(img);
      row.appendChild(box);
      wrap.appendChild(row);
    }
    if(serverLatest.work_video){
      const title2 = document.createElement('div'); title2.style.fontWeight = 700; title2.style.marginTop = '10px'; title2.innerText = 'Previously submitted video';
      wrap.appendChild(title2);
      const row2 = document.createElement('div'); row2.className = 'file-row';
      const url = normalizeUrl(serverLatest.work_video);
      const box = document.createElement('div'); box.className = 'thumb';
      const v = document.createElement('video'); v.controls = true; v.src = url; v.style.maxWidth = '320px';
      v.onerror = ()=>{ v.style.opacity = 0.6; };
      box.appendChild(v);
      row2.appendChild(box);
      wrap.appendChild(row2);
    }

    idPreview.parentNode.insertBefore(wrap, idPreview.nextSibling);
  }

  function setSubmissionLocked(locked){
    submitBtn.disabled = !!locked || uploading;
    submitBtn.style.opacity = (locked || uploading) ? 0.6 : 1;
    [idFrontBtn, idBackBtn, selfieBtn, videosBtn].forEach(b => {
      if(locked){ b.setAttribute('aria-disabled','true'); b.style.pointerEvents='none'; b.style.opacity=0.6; }
      else { b.removeAttribute('aria-disabled'); b.style.pointerEvents='auto'; b.style.opacity=1; }
    });
  }

  // previews
  function renderIdPreview(){
    idPreview.innerHTML = '';
    const order = [
      { key: 'front', file: idFiles.front, label: 'Front' },
      { key: 'back',  file: idFiles.back,  label: 'Back' },
      { key: 'selfie', file: idFiles.selfie, label: 'Selfie' }
    ];
    order.forEach((item) => {
      if(!item.file) return;
      const box = document.createElement('div'); box.className = 'thumb';
      const img = document.createElement('img'); img.src = URL.createObjectURL(item.file); img.alt = item.label;
      box.appendChild(img);
      const lbl = document.createElement('div'); lbl.className = 'label'; lbl.innerText = item.label;
      box.appendChild(lbl);
      const rm = document.createElement('div'); rm.className = 'remove'; rm.innerText = '×';
      rm.addEventListener('click', ()=> {
        URL.revokeObjectURL(img.src);
        if(item.key === 'front'){ idFiles.front = null; idFrontNative.value = ''; }
        else if(item.key === 'back'){ idFiles.back = null; idBackNative.value = ''; }
        else if(item.key === 'selfie'){ idFiles.selfie = null; selfieNative.value = ''; }
        renderIdPreview();
      });
      box.appendChild(rm);
      idPreview.appendChild(box);
    });
  }
  function renderVideoPreview(){
    videosPreview.innerHTML = '';
    videoFiles.forEach((file, idx) => {
      const box = document.createElement('div'); box.className = 'thumb';
      const vid = document.createElement('video'); vid.preload='metadata'; vid.muted=true; vid.playsInline=true; vid.controls=true;
      vid.src = URL.createObjectURL(file);
      box.appendChild(vid);
      const rm = document.createElement('div'); rm.className='remove'; rm.innerText='×';
      rm.addEventListener('click', ()=> {
        URL.revokeObjectURL(vid.src);
        videoFiles.splice(idx,1);
        renderVideoPreview();
      });
      box.appendChild(rm);
      videosPreview.appendChild(box);
    });
  }

  // native change handlers
  idFrontNative.addEventListener('change', (e)=>{
    clearValidation();
    const f = e.target.files && e.target.files[0];
    if(f && f.type.startsWith('image/')) { idFiles.front = f; renderIdPreview(); appendDebug('Selected front ID file: ' + f.name + ' (' + Math.round(f.size/1024) + 'KB)'); }
    else { idFiles.front = null; idFrontNative.value=''; renderIdPreview(); }
  });
  idBackNative.addEventListener('change', (e)=>{
    clearValidation();
    const f = e.target.files && e.target.files[0];
    if(f && f.type.startsWith('image/')) { idFiles.back = f; renderIdPreview(); appendDebug('Selected back ID file: ' + f.name + ' (' + Math.round(f.size/1024) + 'KB)'); }
    else { idFiles.back = null; idBackNative.value=''; renderIdPreview(); }
  });
  selfieNative.addEventListener('change', (e)=>{
    clearValidation();
    const f = e.target.files && e.target.files[0];
    if(f && f.type.startsWith('image/')) { idFiles.selfie = f; renderIdPreview(); appendDebug('Selected selfie file: ' + f.name + ' (' + Math.round(f.size/1024) + 'KB)'); }
    else { idFiles.selfie = null; selfieNative.value=''; renderIdPreview(); }
  });
  videosNative.addEventListener('change', async (e)=>{
    clearValidation();
    const files = Array.from(e.target.files || []);
    for(const f of files){
      if(videoFiles.length >= MAX_VIDEOS) break;
      if(!f.type.startsWith('video/')) continue;
      videoFiles.push(f);
      appendDebug('Selected video: ' + f.name + ' (' + Math.round(f.size/1024) + 'KB)');
    }
    const problems = await validateVideoDurations(videoFiles);
    if(problems.length){
      showValidation(problems.join('\\n'));
      videoFiles = videoFiles.filter(v => !problems.some(p => p.includes(v.name)));
      appendDebug('Video duration problems: ' + problems.join('; '));
    }
    videosNative.value = '';
    renderVideoPreview();
  });

  // visible buttons open the modal
  idFrontBtn.addEventListener('click', ()=> openChoice('front'));
  idBackBtn.addEventListener('click', ()=> openChoice('back'));
  selfieBtn.addEventListener('click', ()=> openChoice('selfie'));
  videosBtn.addEventListener('click', ()=> openChoice('videos'));

  [idFrontBtn, idBackBtn, selfieBtn, videosBtn].forEach(btn=>{
    btn.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); } });
  });

  function openChoice(target){
    currentTarget = target;
    choiceModal.style.display = 'flex';
  }
  function closeChoice(){
    choiceModal.style.display = 'none';
  }
  cameraBtn.addEventListener('click', ()=> handleChoiceMode('camera'));
  filesBtn.addEventListener('click', ()=> handleChoiceMode('files'));
  choiceCancel.addEventListener('click', ()=> { closeChoice(); currentTarget = null; });

  function handleChoiceMode(mode){
    closeChoice();
    clearValidation();
    if(!currentTarget) return;
    if(currentTarget === 'front' || currentTarget === 'back' || currentTarget === 'selfie'){
      let native = idFrontNative;
      if(currentTarget === 'back') native = idBackNative;
      if(currentTarget === 'selfie') native = selfieNative;
      if(mode === 'camera') {
        if(currentTarget === 'selfie') native.setAttribute('capture','user');
        else native.setAttribute('capture','environment');
      } else {
        native.removeAttribute('capture');
      }
      native.click();
    } else if(currentTarget === 'videos'){
      if(mode === 'camera') videosNative.setAttribute('capture','camcorder');
      else videosNative.removeAttribute('capture');
      videosNative.click();
    }
    currentTarget = null;
  }

  // validate video durations
  function validateVideoDurations(files){
    const checks = files.map(f => new Promise((resolve) => {
      const url = URL.createObjectURL(f);
      const v = document.createElement('video'); v.preload='metadata';
      v.src = url;
      const onloaded = ()=>{
        const d = v.duration || 0;
        URL.revokeObjectURL(url);
        v.remove();
        if(d > MAX_VIDEO_SECONDS) resolve(`"${f.name}" is ${Math.round(d)}s — over ${MAX_VIDEO_SECONDS}s`);
        else resolve(null);
      };
      const onerror = ()=> { URL.revokeObjectURL(url); v.remove(); resolve(null); };
      v.addEventListener('loadedmetadata', onloaded, {once:true});
      v.addEventListener('error', onerror, {once:true});
    }));
    return Promise.all(checks).then(results => results.filter(Boolean));
  }

  // validation helpers
  function showValidation(msg){
    validationErrors.textContent = msg;
    validationErrors.classList.remove('hidden');
    appendDebug('Validation: ' + msg);
  }
  function clearValidation(){
    validationErrors.textContent = '';
    validationErrors.classList.add('hidden');
  }

  // submit handler
  submitBtn.addEventListener('click', async ()=>{
    if(uploading) return;
    clearValidation();

    // refresh server status before submit
    await fetchServerKycStatus();
    const currentStatus = (serverUser && serverUser.kyc_status) ? String(serverUser.kyc_status).toLowerCase() : (serverLatest && serverLatest.status ? serverLatest.status : null);
    if(currentStatus && ['pending','approved','approved_by_admin'].includes(currentStatus)){
      showValidation('KYC already submitted — you cannot submit again unless admin rejects/declines it.');
      setSubmissionLocked(true);
      return;
    }

    const idName = (idNameEl.value || '').trim();
    const idNumber = (idNumberEl.value || '').trim();
    const idType = (idTypeEl.value || 'unknown');

    if(!idName){ showValidation('Enter name on ID'); return; }
    if(!idNumber){ showValidation('Enter ID number'); return; }
    if(!idFiles.front){ showValidation('Upload front picture of ID'); return; }
    if(!idFiles.back){ showValidation('Upload back picture of ID'); return; }
    if(!idFiles.selfie){ showValidation('Upload a selfie (your photo)'); return; }
    if(videoFiles.length === 0){ showValidation('Upload at least one work video (required)'); return; }
    if(videoFiles.length > MAX_VIDEOS){ showValidation('Max 2 videos allowed'); return; }

    const durationProblems = await validateVideoDurations(videoFiles);
    if(durationProblems.length){ showValidation(durationProblems.join('\\n')); return; }

    // Build FormData
    const form = new FormData();
    form.append('userId', me.id);
    form.append('user_id', me.id); // compatibility
    form.append('id_type', idType);
    form.append('id_name', idName);
    form.append('id_number', idNumber);

    const idImageList = [];
    if(idFiles.front) idImageList.push(idFiles.front);
    if(idFiles.back) idImageList.push(idFiles.back);
    if(idFiles.selfie) idImageList.push(idFiles.selfie); // we'll also append selfie separately

    // Append id_images entries
    idImageList.forEach((file) => { if(file instanceof File) form.append('id_images', file, file.name); });

    // Append selfie as its own field (backend expects 'selfie' optionally)
    if(idFiles.selfie instanceof File) form.append('selfie', idFiles.selfie, idFiles.selfie.name);

    videoFiles.forEach((f) => { if(f instanceof File) form.append('work_videos', f, f.name); });

    form.append('_multipart', '1');

    // debug: show summary of formdata entries (file names & sizes)
    const entries = [];
    for(const pair of form.entries()){
      const key = pair[0];
      const val = pair[1];
      if(val instanceof File){
        entries.push(`${key}: File(${val.name}, ${val.type}, ${Math.round(val.size/1024)}KB)`);
      } else {
        entries.push(`${key}: ${String(val)}`);
      }
    }
    appendDebug('Submitting KYC POST ' + API_BASE + '/api/kyc/submit');
    appendDebug('FormData summary:\\n' + entries.join('\\n'));

    // prevent double submits
    uploading = true;
    setSubmissionLocked(true);
    showModal('Uploading — please wait...');

    let fetchResp = null;
    let rawText = null;
    let parsed = null;

    try {
      const resp = await fetch(API_BASE + '/api/kyc/submit', { method: 'POST', body: form });
      fetchResp = resp;
      rawText = await resp.text().catch(()=>null);
      appendDebug('KYC submit response: HTTP ' + resp.status + '\\nRaw: ' + (rawText || '(empty)'));
      try{ parsed = rawText ? JSON.parse(rawText) : null; } catch(e){ parsed = null; appendDebug('Parse error: ' + e); }

      if(resp.ok && parsed && parsed.success){
        me.kyc_status = 'pending';
        try{ localStorage.setItem('wc_user', JSON.stringify(me)); }catch(e){}
        await fetchServerKycStatus();
        showModal('Submitted — awaiting review');
        setTimeout(()=> {
          hideModal();
          try {
            if (window.history.length > 1) window.history.back();
            else if(document.referrer) window.location.href = document.referrer;
            else window.location.href = '/';
          } catch(e){
            window.location.href = '/';
          }
        }, 900);
      } else {
        const msg = (parsed && parsed.message) ? parsed.message : (`HTTP ${resp.status}`);
        hideModal();
        showValidation('Submission failed: ' + msg);
        appendDebug('Submission failed detail: ' + msg + (parsed ? (' • parsed: ' + JSON.stringify(parsed)) : ''));
        await fetchServerKycStatus();
      }
    } catch(err){
      hideModal();
      showValidation('Network error while submitting. Try again.');
      appendDebug('Network ERROR: ' + String(err));
      console.error('Network ERROR:', err);
      await fetchServerKycStatus();
    } finally {
      uploading = false;
      setSubmissionLocked(false);
    }
  });

  // modal helpers
  function showModal(msg){ const el = document.getElementById('overlay'); if(el){ document.getElementById('modalText').textContent = msg; el.style.display = 'flex'; } }
  function hideModal(){ const el = document.getElementById('overlay'); if(el) el.style.display = 'none'; }
  modalClose.addEventListener('click', hideModal);

  // init
  (async function init(){
    idNameEl.value = me && me.fullname ? me.fullname : '';
    appendDebug('KYC page initialized for user: ' + me.id);
    await fetchServerKycStatus();
  })();

  // save geo quietly
  (function trySaveGeo(){
    try{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          try{ localStorage.setItem('wc_last_lat', String(pos.coords.latitude)); localStorage.setItem('wc_last_lng', String(pos.coords.longitude)); }catch(e){}
        }, ()=>{}, { maximumAge: 10000, timeout: 3500 });
      }
    }catch(e){}
  })();

})();
</script>
</body>
</html>