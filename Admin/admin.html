<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect ‚Äî Admin Dashboard</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --accent:#1154ff; --muted:#6b7280;
      --shadow: 0 8px 30px rgba(16,24,40,0.06);
      --accent-2:#0738d6;
    }
    *{box-sizing:border-box;font-family:Inter, system-ui, Arial, sans-serif}
    body{margin:0;background:var(--bg);color:#0b1220}
    .layout{display:flex;min-height:100vh}
    aside{
      width:300px;padding:22px;border-right:1px solid #e8eef8;background:#fff;
      transition:transform .24s ease;box-shadow:0 0 0 rgba(0,0,0,0);
    }
    /* hidden class used to hide sidebar on mobile; default is visible on desktop */
    aside.hidden{transform:translateX(-110%);position:fixed;z-index:900;left:0;top:0;height:100%}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .brand img{height:52px;width:auto}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:12px}
    .nav a{display:flex;gap:8px;align-items:center;padding:10px;border-radius:10px;text-decoration:none;color:#0b1220;font-weight:700}
    .nav a:hover{background:#f3f7ff}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid #eef3fb;background:linear-gradient(90deg,#fff,#fff)}
    .hamburger{display:none;font-size:22px;cursor:pointer;padding:6px 8px;border-radius:8px}
    main{flex:1;padding:20px}
    .metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:18px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow)}
    .metric-title{font-size:13px;color:var(--muted)}
    .metric-value{font-size:22px;font-weight:900;margin-top:8px}
    .panel{margin-bottom:14px}
    .controls{display:flex;gap:8px;align-items:center}
    .search{padding:8px;border-radius:8px;border:1px solid #e6eef9}
    .btn{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:800}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eef3fb;text-align:left;font-size:13px}
    .muted{color:var(--muted);font-size:13px}
    .empty{color:var(--muted);padding:12px}
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:1100}
    .popup{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:10px;box-shadow:0 12px 40px rgba(10,20,40,0.24);z-index:1200;max-width:92%;width:760px}
    .small-btn{padding:6px 10px;border-radius:8px;border:1px solid #e6eef9;background:#fff;cursor:pointer}
    .green{background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46;padding:8px 12px;border-radius:8px}
    @media(max-width:920px){
      aside{position:fixed;left:0;top:0;height:100%;z-index:900}
      .hamburger{display:block}
      .metrics{grid-template-columns:repeat(2,1fr)}
      /* Hide sidebar by default for small screens so it only opens via hamburger */
      aside { transform: translateX(-110%); }
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>

  <!-- Reusable popup / modal used for KYC and Jobs details -->
  <div class="popup" id="popup">
    <div id="popupMessage"></div>
    <div id="popupActions" style="text-align:right;margin-top:12px"></div>
  </div>

  <div class="layout">
    <aside id="sidebar">
      <div class="brand">
        <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect logo">
        <div>
          <div style="font-weight:900">WireConnect</div>
          <div class="muted" style="font-size:12px">Admin Console</div>
        </div>
      </div>

      <nav class="nav" id="menu">
        <a href="#" data-panel="overview">üè† Overview</a>
        <a href="#" data-panel="kyc">ü™™ KYC Monitoring</a>
        <a href="#" data-panel="jobs">üîß Jobs Monitor</a>
        <a href="#" data-panel="errors">üêû Server Errors (Debug)</a>
        <a href="#" data-panel="security">üõ°Ô∏è Security Issues</a>
        <a href="#" id="logout">üö™ Logout</a>
      </nav>

      <div style="margin-top:18px;color:var(--muted);font-size:13px">
        Logged in as <strong id="adminName">Admin</strong>
        <div style="margin-top:8px">
          <button id="refreshAll" class="btn" style="padding:8px 10px;background:#eef3ff;color:var(--accent)">Refresh</button>
        </div>
      </div>
    </aside>

    <div style="flex:1">
      <header>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="hamburger" id="hamburgerBtn" title="Open / Close menu">‚ò∞</div>
          <div>
            <div style="font-weight:900">WireConnect ‚Äî Admin</div>
            <div class="muted" style="font-size:13px">Monitor users, KYC, jobs, and system health</div>
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center">
          <div class="muted" id="lastUpdated">Last updated: ‚Äî</div>
        </div>
      </header>

      <main>
        <section class="metrics" aria-live="polite">
          <div class="card">
            <div class="metric-title">Active users (24h)</div>
            <div id="activeUsers" class="metric-value">‚Äî</div>
            <div class="muted" id="activeHint">‚Äî</div>
          </div>
          <div class="card">
            <div class="metric-title">Online users</div>
            <div id="onlineUsers" class="metric-value">‚Äî</div>
            <div class="muted" id="onlineHint">‚Äî</div>
          </div>
          <div class="card">
            <div class="metric-title">Offline users</div>
            <div id="offlineUsers" class="metric-value">‚Äî</div>
            <div class="muted" id="offlineHint">‚Äî</div>
          </div>
          <div class="card">
            <div class="metric-title">Pending KYC</div>
            <div id="pendingKYC" class="metric-value">‚Äî</div>
            <div class="muted" id="kycHint">Quick view</div>
          </div>
        </section>

        <!-- dynamic content area -->
        <section id="contentArea" class="panel card">
          <div id="panelHeader" style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong id="panelTitle">Overview</strong>
              <div class="muted" id="panelSubtitle">Summary view</div>
            </div>
            <div class="controls">
              <input id="panelSearch" class="search" placeholder="Search (users, job id, errors)" />
              <button id="panelRefresh" class="btn">Refresh</button>
            </div>
          </div>

          <div id="panelBody" style="margin-top:12px">
            <!-- Overview default content -->
            <div id="overview" class="panelSection">
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div class="card" style="flex:1;min-width:260px">
                  <strong>Recent KYC requests</strong>
                  <div id="overviewKyc" style="margin-top:8px" class="muted">Loading‚Ä¶</div>
                </div>
                <div class="card" style="flex:1;min-width:260px">
                  <strong>Recent job assignments</strong>
                  <div id="overviewJobs" style="margin-top:8px" class="muted">Loading‚Ä¶</div>
                </div>
                <div class="card" style="flex:1;min-width:260px">
                  <strong>Recent server errors</strong>
                  <div id="overviewErrors" style="margin-top:8px" class="muted">Loading‚Ä¶</div>
                </div>
              </div>
            </div>

            <!-- KYC -->
            <div id="kyc" class="panelSection" style="display:none">
              <h3 style="margin:0 0 8px 0">KYC Monitoring</h3>
              <div class="muted">Pending requests below ‚Äî click a row to view details.</div>
              <table id="kycTable" style="margin-top:12px">
                <thead><tr><th>ID</th><th>User</th><th>Type</th><th>Submitted</th><th>Status</th></tr></thead>
                <tbody><tr><td colspan="5" class="empty">Loading‚Ä¶</td></tr></tbody>
              </table>
            </div>

            <!-- Jobs -->
            <div id="jobs" class="panelSection" style="display:none">
              <h3 style="margin:0 0 8px 0">Jobs Monitor</h3>
              <div class="muted">Recent / active jobs. Click job id to inspect.</div>
              <table id="jobsTable" style="margin-top:12px">
                <thead><tr><th>Job ID</th><th>Client</th><th>Type</th><th>State</th><th>Status</th></tr></thead>
                <tbody><tr><td colspan="5" class="empty">Loading‚Ä¶</td></tr></tbody>
              </table>
            </div>

            <!-- Errors -->
            <div id="errors" class="panelSection" style="display:none">
              <h3 style="margin:0 0 8px 0">Server Errors & Debug</h3>
              <div class="muted">Recent server errors and stack traces (last 24h)</div>
              <table id="errorsTable" style="margin-top:12px">
                <thead><tr><th>When</th><th>Path</th><th>Message</th><th>Count</th></tr></thead>
                <tbody><tr><td colspan="4" class="empty">Loading‚Ä¶</td></tr></tbody>
              </table>
            </div>

            <!-- Security -->
            <div id="security" class="panelSection" style="display:none">
              <h3 style="margin:0 0 8px 0">Security Issues</h3>
              <div class="muted">Alerts: failed logins, suspicious activity</div>
              <table id="securityTable" style="margin-top:12px">
                <thead><tr><th>When</th><th>Type</th><th>Subject</th><th>Details</th></tr></thead>
                <tbody><tr><td colspan="4" class="empty">Loading‚Ä¶</td></tr></tbody>
              </table>
            </div>

          </div>
        </section>
      </main>
    </div>
  </div>

<script>
(function(){
  // API base detection
  const API_BASE = (location.hostname.includes('localhost') ? 'http://localhost:10000' : 'https://wireconnet-1.onrender.com');
  // admin token or normal token
  const adminToken = localStorage.getItem('wc_admin_token') || localStorage.getItem('wc_token') || null;

  // UI refs
  const sidebar = document.getElementById('sidebar');
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const overlay = document.getElementById('overlay');
  const popup = document.getElementById('popup');
  const popupMessage = document.getElementById('popupMessage');
  const popupActions = document.getElementById('popupActions');
  const popupClose = document.getElementById('popupClose');
  const lastUpdated = document.getElementById('lastUpdated');
  const panelTitle = document.getElementById('panelTitle');
  const panelSubtitle = document.getElementById('panelSubtitle');
  const panelSections = document.querySelectorAll('.panelSection');
  const navLinks = document.querySelectorAll('#menu a[data-panel]');
  const adminName = document.getElementById('adminName');

  // metric elements
  const activeUsersEl = document.getElementById('activeUsers');
  const onlineUsersEl = document.getElementById('onlineUsers');
  const offlineUsersEl = document.getElementById('offlineUsers');
  const pendingKYCEl = document.getElementById('pendingKYC');

  // helper: popup show/close
  function showPopupHtml(html, actionsHtml = '') {
    popupMessage.innerHTML = html;
    popupActions.innerHTML = actionsHtml;
    popup.style.display = 'block';
    overlay.style.display = 'block';
  }
  function closePopup(){
    popup.style.display = 'none';
    overlay.style.display = 'none';
    popupMessage.innerHTML = '';
    popupActions.innerHTML = '';
  }
  overlay.addEventListener('click', closePopup);

  // MANUAL sidebar toggling:
  // On small screens sidebar is hidden by default (CSS does that). Hamburger toggles the "hidden" class.
  hamburgerBtn.addEventListener('click', ()=> {
    sidebar.classList.toggle('hidden');
  });

  // logout (clears admin token)
  document.getElementById('logout').addEventListener('click', (e)=> {
    e.preventDefault();
    localStorage.removeItem('wc_admin_token');
    localStorage.removeItem('wc_token');
    showPopupHtml('Logged out (token cleared). Refresh to re-login.');
  });

  // choose panel
  navLinks.forEach(a=>{
    a.addEventListener('click',(ev)=>{
      ev.preventDefault();
      const panel = a.getAttribute('data-panel') || 'overview';
      openPanel(panel);
      // don't auto-toggle the sidebar to open; only close on small screens for UX
      if(window.innerWidth < 920) sidebar.classList.add('hidden');
    });
  });

  function openPanel(name){
    panelSections.forEach(s => s.style.display = 'none');
    const el = document.getElementById(name);
    if(el) el.style.display = 'block';
    panelTitle.innerText = (name[0].toUpperCase() + name.slice(1));
    panelSubtitle.innerText = {overview:'Summary view', kyc:'Pending KYC requests', jobs:'Active & recent jobs', errors:'Server errors (debug)', security:'Security alerts'}[name] || '';
    // load panel data
    if(name === 'overview') loadOverview();
    if(name === 'kyc') loadKyc();
    if(name === 'jobs') loadJobs();
    if(name === 'errors') loadErrors();
    if(name === 'security') loadSecurity();
    window.__wc_currentPanel = name;
  }

  // Generic fetch helper that injects Authorization (if token available)
  async function apiFetch(path, opts = {}) {
    const headers = Object.assign({}, opts.headers || {});
    if(adminToken) headers['Authorization'] = 'Bearer ' + adminToken;
    try {
      const r = await fetch(API_BASE + path, Object.assign({ headers }, opts));
      const text = await r.text().catch(()=>null);
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch(e){ json = null; }
      return { ok: r.ok, status: r.status, text, body: json };
    } catch(e) {
      return { ok:false, error: String(e) };
    }
  }

  // ---- Metrics loader ----
  async function loadMetrics(){
    activeUsersEl.textContent = '‚Äî';
    onlineUsersEl.textContent = '‚Äî';
    offlineUsersEl.textContent = '‚Äî';
    pendingKYCEl.textContent = '‚Äî';

    // try admin metrics endpoint first (best)
    const res = await apiFetch('/api/admin/metrics');
    if(res.ok && res.body && res.body.success){
      const b = res.body;
      activeUsersEl.textContent = b.active_users ?? b.active ?? '‚Äî';
      onlineUsersEl.textContent = b.online_users ?? b.online ?? '‚Äî';
      offlineUsersEl.textContent = b.offline_users ?? b.offline ?? '‚Äî';
      pendingKYCEl.textContent = b.pending_kyc ?? b.pendingKyc ?? '‚Äî';
      lastUpdated.innerText = 'Last updated: ' + (new Date()).toLocaleTimeString();
      return;
    }

    // fallback: try to detect pending KYC / basic info from existing endpoints
    const k = await apiFetch('/api/kyc/pending');
    if(k.ok && k.body && Array.isArray(k.body.requests)){
      pendingKYCEl.textContent = k.body.requests.length;
    } else {
      pendingKYCEl.textContent = 'N/A';
    }

    lastUpdated.innerText = 'Last updated: ' + (new Date()).toLocaleTimeString();
  }

  // ---- Overview ----
  async function loadOverview(){
    document.getElementById('overviewKyc').innerText = 'Loading‚Ä¶';
    document.getElementById('overviewJobs').innerText = 'Loading‚Ä¶';
    document.getElementById('overviewErrors').innerText = 'Loading‚Ä¶';

    const k = await apiFetch('/api/kyc/pending');
    if(k.ok && k.body && k.body.requests) {
      const list = k.body.requests || [];
      document.getElementById('overviewKyc').innerHTML = `${list.length} pending ‚Äî <a href="#" data-panel="kyc">Open KYC</a>`;
    } else {
      document.getElementById('overviewKyc').innerHTML = `<span class="muted">No KYC endpoint</span>`;
    }

    const j = await apiFetch('/api/admin/jobs');
    if(j.ok && j.body && Array.isArray(j.body.jobs)) {
      const jobs = j.body.jobs || [];
      document.getElementById('overviewJobs').innerHTML = `${jobs.length} recent ‚Äî <a href="#" data-panel="jobs">Open Jobs</a>`;
    } else {
      document.getElementById('overviewJobs').innerHTML = `<span class="muted">Jobs endpoint not found</span>`;
    }

    const e = await apiFetch('/api/admin/errors');
    if(e.ok && e.body && Array.isArray(e.body.errors)){
      document.getElementById('overviewErrors').innerHTML = `${(e.body.errors||[]).length} recent ‚Äî <a href="#" data-panel="errors">Open Errors</a>`;
    } else {
      document.getElementById('overviewErrors').innerHTML = `<span class="muted">Errors endpoint not found</span>`;
    }
  }

  // ---- KYC panel & actions ----
  async function loadKyc(){
    const tbody = document.querySelector('#kycTable tbody');
    tbody.innerHTML = `<tr><td colspan="5" class="empty">Loading‚Ä¶</td></tr>`;
    const res = await apiFetch('/api/kyc/pending');
    if(res.ok && res.body && Array.isArray(res.body.requests)){
      const rows = res.body.requests;
      if(rows.length === 0){ tbody.innerHTML = `<tr><td colspan="5" class="empty">No pending requests</td></tr>`; return; }
      tbody.innerHTML = rows.map(r => `<tr data-id="${r.id}">
        <td>${r.id}</td>
        <td>${escapeHtml(r.username || r.fullname || r.user_id || '-')}</td>
        <td>${escapeHtml(r.id_type || '-')}</td>
        <td>${new Date(r.submitted_at || r.created_at || Date.now()).toLocaleString()}</td>
        <td>${escapeHtml(r.status || '-')}</td>
      </tr>`).join('');
      // click --> open modal with details + approve/decline
      tbody.querySelectorAll('tr[data-id]').forEach(tr => tr.addEventListener('click', async ()=>{
        const id = tr.getAttribute('data-id');
        await showKycDetailModal(id);
      }));
      return;
    }
    if(res.notfound) {
      tbody.innerHTML = `<tr><td colspan="5" class="empty">Endpoint /api/kyc/pending not found on server</td></tr>`;
      return;
    }
    tbody.innerHTML = `<tr><td colspan="5" class="empty">Failed to load KYC (${res.error||res.status})</td></tr>`;
  }

  // show KYC detail and provide Approve / Decline actions
  async function showKycDetailModal(reqId){
    // fetch detail if endpoint available (fallback to list data)
    let detail = null;
    // some APIs return request object directly at GET /api/kyc/:id ‚Äî try it
    const tryRes = await apiFetch('/api/kyc/' + encodeURIComponent(reqId));
    if(tryRes.ok && tryRes.body && tryRes.body.request){
      detail = tryRes.body.request;
    } else {
      // fallback to retrieving the pending list and find entry
      const listRes = await apiFetch('/api/kyc/pending');
      if(listRes.ok && listRes.body && Array.isArray(listRes.body.requests)){
        detail = listRes.body.requests.find(x => String(x.id) === String(reqId));
      }
    }

    const html = `
      <h3>KYC Request #${escapeHtml(reqId)}</h3>
      <div style="margin-top:8px">
        <strong>User:</strong> ${escapeHtml((detail && (detail.username||detail.fullname))||'-')}<br>
        <strong>Type:</strong> ${escapeHtml((detail && detail.id_type) || '-')}<br>
        <strong>Number:</strong> ${escapeHtml((detail && detail.id_number) || '-')}<br>
        <strong>Submitted:</strong> ${new Date((detail && (detail.submitted_at||detail.created_at))||Date.now()).toLocaleString()}<br>
        <div style="margin-top:8px"><strong>Notes:</strong><div class="muted" style="margin-top:6px">${escapeHtml((detail && detail.notes) || '(no notes)')}</div></div>
        <div style="margin-top:10px">${(detail && detail.id_images && detail.id_images.length) ? ('<strong>Images:</strong><div style="display:flex;gap:8px;margin-top:6px">' + detail.id_images.map(i=>`<img src="${escapeHtml(i)}" style="height:80px;border-radius:6px;object-fit:cover">`).join('') + '</div>') : ''}</div>
      </div>
    `;

    const adminId = getAdminIdForActions();
    const actionsHtml = `
      <button id="kycApprove" class="btn" style="margin-right:8px">Approve</button>
      <button id="kycDecline" class="small-btn">Decline</button>
      <button id="kycClose" class="small-btn" style="margin-left:8px">Close</button>
    `;

    showPopupHtml(html, actionsHtml);

    document.getElementById('kycClose').addEventListener('click', closePopup);
    document.getElementById('kycApprove').addEventListener('click', async ()=>{
      document.getElementById('kycApprove').disabled = true;
      await kycDecision(reqId, 'approve', adminId);
      document.getElementById('kycApprove').disabled = false;
    });
    document.getElementById('kycDecline').addEventListener('click', async ()=>{
      document.getElementById('kycDecline').disabled = true;
      await kycDecision(reqId, 'decline', adminId);
      document.getElementById('kycDecline').disabled = false;
    });
  }

  // call backend to approve/decline
  async function kycDecision(reqId, decision, adminId){
    try {
      const payload = { adminId: adminId || 'admin', decision: decision === 'approve' ? 'approve' : 'decline', adminNote: (decision === 'decline' ? 'Declined by admin' : 'Approved by admin') };
      const res = await apiFetch('/api/kyc/' + encodeURIComponent(reqId) + '/decision', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(res.ok && res.body && res.body.success){
        showPopupHtml(`<div class="green">${decision === 'approve' ? 'KYC approved' : 'KYC declined'}</div>`,
          `<button id="okBtn" class="btn">OK</button>`);
        document.getElementById('okBtn').addEventListener('click', ()=>{ closePopup(); loadKyc(); loadMetrics(); });
        return;
      } else {
        showPopupHtml(`<div class="muted">Failed: ${escapeHtml((res.body && res.body.message) || res.error || res.status)}</div>`,
          `<button id="okBtn" class="btn">OK</button>`);
        document.getElementById('okBtn').addEventListener('click', closePopup);
      }
    } catch(e){
      showPopupHtml(`<div class="muted">Network error: ${escapeHtml(String(e))}</div>`, `<button id="okBtn" class="btn">OK</button>`);
      document.getElementById('okBtn').addEventListener('click', closePopup);
    }
  }

  // ---- Jobs panel & actions ----
  async function loadJobs(){
    const tbody = document.querySelector('#jobsTable tbody');
    tbody.innerHTML = `<tr><td colspan="5" class="empty">Loading‚Ä¶</td></tr>`;
    // Try admin jobs endpoint
    let res = await apiFetch('/api/admin/jobs');
    if(res.ok && res.body && Array.isArray(res.body.jobs)){
      const rows = res.body.jobs;
      if(rows.length === 0){ tbody.innerHTML = `<tr><td colspan="5" class="empty">No jobs found</td></tr>`; return; }
      tbody.innerHTML = rows.map(j => `<tr data-id="${j.id}">
        <td>${j.id}</td>
        <td>${escapeHtml(j.client_name || j.client_id || '-')}</td>
        <td>${escapeHtml(j.job_type || '-')}</td>
        <td>${escapeHtml(j.state || '-')}</td>
        <td>${escapeHtml(j.status || '-')}</td>
      </tr>`).join('');
      tbody.querySelectorAll('tr[data-id]').forEach(tr => tr.addEventListener('click', ()=> showJobDetailModal(tr.getAttribute('data-id'))));
      return;
    }

    // Fallback to /api/dashboard info (if admin jobs not available)
    res = await apiFetch('/api/dashboard?role=client');
    if(res.ok && res.body){
      tbody.innerHTML = `<tr><td colspan="5" class="empty">No admin jobs endpoint. Dashboard returned data but not jobs.</td></tr>`;
      return;
    }
    tbody.innerHTML = `<tr><td colspan="5" class="empty">Failed to load jobs (no endpoint)</td></tr>`;
  }

  async function showJobDetailModal(jobId){
    // fetch job status
    const res = await apiFetch('/api/job/' + encodeURIComponent(jobId) + '/status');
    if(!res.ok || !res.body || !res.body.success){
      showPopupHtml(`<div class="muted">Could not fetch job details. (${res.error || res.status})</div>`, `<button id="closeBtn" class="btn">Close</button>`);
      document.getElementById('closeBtn').addEventListener('click', closePopup);
      return;
    }
    const job = res.body.job;
    // construct detail HTML
    const html = `<h3>Job ${escapeHtml(jobId)}</h3>
      <div style="margin-top:8px">
        <strong>Status:</strong> ${escapeHtml(job.status || '-')}<br>
        <strong>Assigned tech:</strong> ${escapeHtml(job.assigned_tech_id || '(none)')}<br>
        <strong>Assigned at:</strong> ${job.assigned_at ? new Date(job.assigned_at).toLocaleString() : '-'}<br>
        <strong>Expires at:</strong> ${job.expires_at ? new Date(job.expires_at).toLocaleString() : '-'}<br>
      </div>`;

    // actions: if assigned tech present add toggle for online/offline
    let actionsHtml = `<button id="closeJob" class="small-btn">Close</button>`;
    if(job.assigned_tech_id){
      actionsHtml = `
        <button id="setOnline" class="btn">Set Tech Online</button>
        <button id="setOffline" class="small-btn">Set Tech Offline</button>
        <button id="closeJob" class="small-btn" style="margin-left:8px">Close</button>
      `;
    }
    showPopupHtml(html, actionsHtml);

    document.getElementById('closeJob').addEventListener('click', closePopup);
    if(job.assigned_tech_id){
      document.getElementById('setOnline').addEventListener('click', async ()=>{
        await setTechOnline(job.assigned_tech_id, true);
        closePopup();
        loadJobs();
      });
      document.getElementById('setOffline').addEventListener('click', async ()=>{
        await setTechOnline(job.assigned_tech_id, false);
        closePopup();
        loadJobs();
      });
    }
  }

  // call backend to set tech online/offline
  async function setTechOnline(techId, online){
    try{
      const payload = { techId: techId, online: !!online, lat: null, lng: null };
      const r = await apiFetch('/api/tech/status', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(r.ok && r.body && r.body.success){
        showPopupHtml(`<div class="green">Technician ${online ? 'set online' : 'set offline'} successfully</div>`,
          `<button id="okBtn" class="btn">OK</button>`);
        document.getElementById('okBtn').addEventListener('click', ()=> { closePopup(); loadMetrics(); });
        return;
      } else {
        showPopupHtml(`<div class="muted">Failed: ${escapeHtml((r.body && r.body.message) || r.error || r.status)}</div>`,
          `<button id="okBtn" class="btn">OK</button>`);
        document.getElementById('okBtn').addEventListener('click', closePopup);
      }
    }catch(e){
      showPopupHtml(`<div class="muted">Network error: ${escapeHtml(String(e))}</div>`, `<button id="okBtn" class="btn">OK</button>`);
      document.getElementById('okBtn').addEventListener('click', closePopup);
    }
  }

  // ---- Errors panel ----
  async function loadErrors(){
    const tbody = document.querySelector('#errorsTable tbody');
    tbody.innerHTML = `<tr><td colspan="4" class="empty">Loading‚Ä¶</td></tr>`;
    const res = await apiFetch('/api/admin/errors');
    if(res.ok && res.body && Array.isArray(res.body.errors)){
      const rows = res.body.errors;
      if(rows.length === 0){ tbody.innerHTML = `<tr><td colspan="4" class="empty">No recent errors</td></tr>`; return; }
      tbody.innerHTML = rows.map(e => `<tr>
        <td>${new Date(e.when || e.created_at).toLocaleString()}</td>
        <td>${escapeHtml(e.path || '-')}</td>
        <td style="max-width:480px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml((e.message || e.msg || '').slice(0,200))}</td>
        <td>${e.count || 1}</td>
      </tr>`).join('');
      return;
    }
    if(res.notfound){
      tbody.innerHTML = `<tr><td colspan="4" class="empty">Endpoint /api/admin/errors not found</td></tr>`;
      return;
    }
    tbody.innerHTML = `<tr><td colspan="4" class="empty">Failed to load errors (${res.error||res.status})</td></tr>`;
  }

  // ---- Security panel ----
  async function loadSecurity(){
    const tbody = document.querySelector('#securityTable tbody');
    tbody.innerHTML = `<tr><td colspan="4" class="empty">Loading‚Ä¶</td></tr>`;
    const res = await apiFetch('/api/admin/security');
    if(res.ok && res.body && Array.isArray(res.body.alerts)){
      const rows = res.body.alerts;
      if(rows.length === 0){ tbody.innerHTML = `<tr><td colspan="4" class="empty">No security alerts</td></tr>`; return; }
      tbody.innerHTML = rows.map(a => `<tr>
        <td>${new Date(a.when || a.created_at).toLocaleString()}</td>
        <td>${escapeHtml(a.type || '-')}</td>
        <td>${escapeHtml(a.subject || '-')}</td>
        <td style="max-width:420px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml((a.details||'').slice(0,200))}</td>
      </tr>`).join('');
      return;
    }
    if(res.notfound){
      tbody.innerHTML = `<tr><td colspan="4" class="empty">Endpoint /api/admin/security not found</td></tr>`;
      return;
    }
    tbody.innerHTML = `<tr><td colspan="4" class="empty">Failed to load security alerts (${res.error||res.status})</td></tr>`;
  }

  // refresh handlers
  document.getElementById('refreshAll').addEventListener('click', () => {
    loadMetrics();
    const current = window.__wc_currentPanel || 'overview';
    openPanel(current);
  });
  document.getElementById('panelRefresh').addEventListener('click', () => {
    const current = window.__wc_currentPanel || 'overview';
    openPanel(current);
  });

  // auto-refresh metrics every 15s; panel reload every 8s (if visible)
  loadMetrics();
  setInterval(loadMetrics, 15000);
  openPanel('overview');
  setInterval(()=> {
    const panel = window.__wc_currentPanel || 'overview';
    if(panel === 'overview') loadOverview();
    else if(panel === 'kyc') loadKyc();
    else if(panel === 'jobs') loadJobs();
    else if(panel === 'errors') loadErrors();
    else if(panel === 'security') loadSecurity();
  }, 8000);

  // try to show admin name from stored user
  try {
    const me = JSON.parse(localStorage.getItem('wc_user') || 'null');
    if(me && (me.fullname || me.username)) adminName.innerText = me.fullname || me.username;
  } catch(e){}

  // utility helpers
  function escapeHtml(str){ if(!str && str !== 0) return ''; return String(str).replace(/[&<>"'`=\/]/g, function(ch){ return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;' })[ch]; }); }
  function getAdminIdForActions(){ try { const me = JSON.parse(localStorage.getItem('wc_user') || 'null'); return (me && me.id) ? me.id : (localStorage.getItem('userId') || 'admin'); } catch(e){ return (localStorage.getItem('userId') || 'admin'); } }

  // expose a few helpers for debug from console
  window.adminUI = { openPanel, loadMetrics, loadKyc, loadJobs, loadErrors, loadSecurity, setTechOnline };

})();
</script>
</body>
</html>