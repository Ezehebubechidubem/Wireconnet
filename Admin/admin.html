<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect ‚Äî Admin Dashboard</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --accent:#1154ff; --muted:#6b7280;
      --shadow: 0 8px 30px rgba(16,24,40,0.06);
      --accent-2:#0738d6;
    }
    *{box-sizing:border-box;font-family:Inter, system-ui, Arial, sans-serif}
    body{margin:0;background:var(--bg);color:#0b1220}
    .layout{display:flex;min-height:100vh}
    aside{
      width:300px;padding:18px;border-right:1px solid #e8eef8;background:#fff;
      transition:transform .24s ease;box-shadow:0 0 0 rgba(0,0,0,0);
    }
    aside.hidden{transform:translateX(-110%);position:fixed;z-index:900;left:0;top:0;height:100%}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .brand img{height:48px;width:auto}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:12px}
    .nav a{display:block;padding:10px;border-radius:8px;text-decoration:none;color:#0b1220;font-weight:700;cursor:pointer}
    .nav a:hover{background:#f3f7ff}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #eef3fb;background:#fff}
    .hamburger{display:none;font-size:20px;cursor:pointer;padding:6px 8px;border-radius:8px}
    main{flex:1;padding:18px}
    .metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:14px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--shadow)}
    .metric-title{font-size:13px;color:var(--muted)}
    .metric-value{font-size:20px;font-weight:800;margin-top:6px}
    .panel{margin-bottom:12px}
    .controls{display:flex;gap:8px;align-items:center}
    .search{padding:8px;border-radius:8px;border:1px solid #e6eef9}
    .btn{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:800}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eef3fb;text-align:left;font-size:13px}
    .muted{color:var(--muted);font-size:13px}
    .empty{color:var(--muted);padding:10px}
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:1100}
    .popup{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:14px;border-radius:10px;box-shadow:0 12px 40px rgba(10,20,40,0.24);z-index:1200;width:min(780px,96%)}
    .small{font-size:13px;color:var(--muted)}
    .small-btn{padding:6px 8px;border-radius:8px;border:1px solid #e6eef9;background:#fff;cursor:pointer}
    @media(max-width:920px){ .hamburger{display:block} .metrics{grid-template-columns:repeat(2,1fr)} }
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid #eef3fb;width:100%;box-sizing:border-box}
    .row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>
  <div class="popup" id="popup">
    <div id="popupMessage"></div>
    <div style="text-align:right;margin-top:12px"><button id="popupClose" class="btn" style="background:#eef3ff;color:var(--accent)">Close</button></div>
  </div>

  <div class="layout">
    <aside id="sidebar" aria-hidden="false">
      <div class="brand">
        <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect logo">
        <div>
          <div style="font-weight:900">WireConnect</div>
          <div class="muted" style="font-size:12px">Admin Console</div>
        </div>
      </div>

      <nav class="nav" id="menu">
        <a data-panel="overview">üè† Overview</a>
        <a data-panel="kyc">ü™™ KYC Monitoring</a>
        <a data-panel="jobs">üîß Jobs Monitor</a>
        <a data-panel="users">üë• Users</a>
        <a data-panel="errors">üêû Server Errors</a>
        <a id="logout">üö™ Logout</a>
      </nav>

      <div style="margin-top:14px;color:var(--muted);font-size:13px">
        Logged in as <strong id="adminName">Admin</strong>
        <div style="margin-top:8px">
          <button id="refreshAll" class="btn" style="padding:8px 10px;background:#eef3ff;color:var(--accent)">Refresh</button>
        </div>
      </div>
    </aside>

    <div style="flex:1">
      <header>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="hamburger" id="hamburgerBtn">‚ò∞</div>
          <div>
            <div style="font-weight:900">WireConnect ‚Äî Admin</div>
            <div class="muted" style="font-size:13px">Monitor KYC, jobs, and manage users</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="muted" id="lastUpdated">Last updated: ‚Äî</div>
        </div>
      </header>

      <main>
        <section class="metrics" aria-live="polite">
          <div class="card">
            <div class="metric-title">Clients (leaderboard size)</div>
            <div id="clientCount" class="metric-value">‚Äî</div>
            <div class="muted">Using /api/dashboard?role=client as a proxy (leaderboard length)</div>
          </div>
          <div class="card">
            <div class="metric-title">Technicians (leaderboard size)</div>
            <div id="techCount" class="metric-value">‚Äî</div>
            <div class="muted">Using /api/dashboard?role=worker as a proxy</div>
          </div>
          <div class="card">
            <div class="metric-title">Online ‚Äî Technicians (manual)</div>
            <div id="onlineTech" class="metric-value">N/A</div>
            <div class="muted">Use Users panel to check/set online flags per user</div>
          </div>
          <div class="card">
            <div class="metric-title">Pending KYC</div>
            <div id="pendingKYC" class="metric-value">‚Äî</div>
            <div class="muted">Data from /api/kyc/pending</div>
          </div>
        </section>

        <section id="contentArea" class="panel card">
          <div id="panelHeader" style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong id="panelTitle">Overview</strong>
              <div class="muted" id="panelSubtitle">Summary view</div>
            </div>
            <div class="controls">
              <input id="panelSearch" class="search" placeholder="Search (job id or user id)" />
              <button id="panelRefresh" class="btn">Refresh</button>
            </div>
          </div>

          <div id="panelBody" style="margin-top:12px">
            <div id="overview" class="panelSection">
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div class="card" style="flex:1;min-width:220px">
                  <strong>Recent KYC requests</strong>
                  <div id="overviewKyc" style="margin-top:8px" class="muted">Loading‚Ä¶</div>
                </div>
                <div class="card" style="flex:1;min-width:220px">
                  <strong>Job lookup</strong>
                  <div style="margin-top:8px">
                    <div class="row"><input id="overviewJobId" placeholder="Enter job id" /><button id="overviewJobLookup" class="small-btn">Lookup</button></div>
                    <div id="overviewJobResult" style="margin-top:8px"></div>
                  </div>
                </div>
                <div class="card" style="flex:1;min-width:220px">
                  <strong>Notes</strong>
                  <div class="muted" style="margin-top:8px">This admin UI uses only the routes present in your backend (as requested). For bulk/auto metrics you must add backend endpoints that list users or expose metrics.</div>
                </div>
              </div>
            </div>

            <div id="kyc" class="panelSection" style="display:none">
              <h3 style="margin:0 0 8px 0">KYC Monitoring</h3>
              <div class="muted">Pending requests ‚Äî click approve/decline.</div>
              <table id="kycTable" style="margin-top:12px">
                <thead><tr><th>ID</th><th>User</th><th>Type</th><th>Submitted</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody><tr><td colspan="6" class="empty">Loading‚Ä¶</td></tr></tbody>
              </table>
            </div>

            <div id="jobs" class="panelSection" style="display:none">
              <h3 style="margin:0 0 8px 0">Jobs Monitor</h3>
              <div class="muted">Lookup a job by id (calls /api/job/:id).</div>
              <div style="margin-top:8px" class="row">
                <input id="jobIdInput" placeholder="job id" /><button id="jobLookupBtn" class="small-btn">Lookup job</button>
              </div>
              <div id="jobDetail" style="margin-top:12px"></div>
            </div>

            <div id="users" class="panelSection" style="display:none">
              <h3 style="margin:0 0 8px 0">Users</h3>
              <div class="muted">Lookup user by id and set online/offline (calls /api/user/:id and /api/tech/status).</div>
              <div style="margin-top:8px" class="row">
                <input id="userIdInput" placeholder="user id" />
                <button id="userLookupBtn" class="small-btn">Load</button>
                <button id="setOnlineBtn" class="small-btn">Set Online</button>
                <button id="setOfflineBtn" class="small-btn">Set Offline</button>
              </div>
              <div id="userCard" style="margin-top:12px"></div>
            </div>

            <div id="errors" class="panelSection" style="display:none">
              <h3 style="margin:0 0 8px 0">Server Errors</h3>
              <div class="muted">No server error endpoint available in backend ‚Äî this section is placeholder.</div>
            </div>

          </div>
        </section>
      </main>
    </div>
  </div>

<script>
(function(){
  const API_BASE = (location.hostname.includes('localhost') ? 'http://localhost:10000' : (location.origin.includes('localhost') ? 'http://localhost:10000' : 'https://wireconnet-1.onrender.com'));
  const adminToken = localStorage.getItem('wc_admin_token') || localStorage.getItem('wc_token') || null;

  // DOM refs
  const sidebar = document.getElementById('sidebar');
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const overlay = document.getElementById('overlay');
  const popup = document.getElementById('popup');
  const popupMessage = document.getElementById('popupMessage');
  const popupClose = document.getElementById('popupClose');
  const lastUpdated = document.getElementById('lastUpdated');

  const navLinks = document.querySelectorAll('#menu a[data-panel]');
  const refreshAllBtn = document.getElementById('refreshAll');
  const panelRefresh = document.getElementById('panelRefresh');

  const clientCountEl = document.getElementById('clientCount');
  const techCountEl = document.getElementById('techCount');
  const pendingKycEl = document.getElementById('pendingKYC');
  const onlineTechEl = document.getElementById('onlineTech');

  // show/hide popup
  function showPopup(msg){ popupMessage.innerText = msg; popup.style.display='block'; overlay.style.display='block'; }
  function closePopup(){ popup.style.display='none'; overlay.style.display='none'; }
  popupClose.addEventListener('click', closePopup);
  overlay.addEventListener('click', closePopup);

  // hamburger manual toggle
  hamburgerBtn.addEventListener('click', ()=> {
    sidebar.classList.toggle('hidden');
    sidebar.setAttribute('aria-hidden', sidebar.classList.contains('hidden') ? 'true' : 'false');
  });

  // click outside -> hide sidebar on small screens
  document.addEventListener('click', (e)=>{
    if(window.innerWidth < 920){
      const path = e.composedPath ? e.composedPath() : (e.path || []);
      if(!path.includes(sidebar) && !path.includes(hamburgerBtn) && !sidebar.classList.contains('hidden')){
        sidebar.classList.add('hidden');
      }
    }
  });

  // nav click handlers
  navLinks.forEach(a=>{
    a.addEventListener('click', (ev)=>{
      ev.preventDefault();
      const panel = a.getAttribute('data-panel') || 'overview';
      openPanel(panel);
      if(window.innerWidth < 920) sidebar.classList.add('hidden');
    });
  });

  function openPanel(name){
    document.querySelectorAll('.panelSection').forEach(s => s.style.display = 'none');
    const el = document.getElementById(name);
    if(el) el.style.display = 'block';
    document.getElementById('panelTitle').innerText = (name[0].toUpperCase() + name.slice(1));
    const subtitles = {overview:'Summary view', kyc:'Pending KYC requests', jobs:'Job lookup', users:'User management', errors:'Server errors'};
    document.getElementById('panelSubtitle').innerText = subtitles[name] || '';
    if(name === 'overview') loadOverview();
    if(name === 'kyc') loadKyc();
    if(name === 'jobs') { document.getElementById('jobDetail').innerHTML=''; }
    if(name === 'users') { document.getElementById('userCard').innerHTML=''; }
    window.__panel = name;
  }

  // basic fetch helper
  async function apiFetch(path, opts = {}) {
    const headers = Object.assign({}, opts.headers || {});
    if(adminToken) headers['Authorization'] = 'Bearer ' + adminToken;
    try{
      const res = await fetch(API_BASE + path, Object.assign({ headers }, opts));
      const text = await res.text().catch(()=>null);
      let body = null;
      try{ body = text ? JSON.parse(text) : null; } catch(e){ body = null; }
      return { ok: res.ok, status: res.status, text, body };
    }catch(e){
      return { ok:false, error: String(e) };
    }
  }

  // load overview proxies: use /api/dashboard role endpoints as proxy for counts where possible
  async function loadOverview(){
    // KYC count
    const k = await apiFetch('/api/kyc/pending');
    if(k.ok && k.body && Array.isArray(k.body.requests)) pendingKycEl.innerText = String(k.body.requests.length); else pendingKycEl.innerText='N/A';

    // client/tech leaderboards (proxy counts)
    const clients = await apiFetch('/api/dashboard?role=client');
    if(clients.ok && clients.body && Array.isArray(clients.body.leaderboard)) clientCountEl.innerText = String(clients.body.leaderboard.length);
    else clientCountEl.innerText = 'N/A';

    const techs = await apiFetch('/api/dashboard?role=worker');
    if(techs.ok && techs.body && Array.isArray(techs.body.leaderboard)) techCountEl.innerText = String(techs.body.leaderboard.length);
    else techCountEl.innerText = 'N/A';

    // onlineTech (no list endpoint available): mark N/A and instruct admin to use Users panel
    onlineTechEl.innerText = 'N/A (use Users panel)';

    lastUpdated.innerText = 'Last updated: ' + (new Date()).toLocaleString();
  }

  // KYC panel
  async function loadKyc(){
    const tbody = document.querySelector('#kycTable tbody');
    tbody.innerHTML = `<tr><td colspan="6" class="empty">Loading‚Ä¶</td></tr>`;
    const res = await apiFetch('/api/kyc/pending');
    if(res.ok && res.body && Array.isArray(res.body.requests)){
      const rows = res.body.requests;
      if(rows.length === 0){ tbody.innerHTML = `<tr><td colspan="6" class="empty">No pending requests</td></tr>`; return; }
      tbody.innerHTML = rows.map(r => `<tr data-id="${r.id}">
        <td>${r.id}</td>
        <td>${escapeHtml(r.username || r.fullname || r.user_id || '-')}</td>
        <td>${escapeHtml(r.id_type || '-')}</td>
        <td>${new Date(r.submitted_at || r.created_at || Date.now()).toLocaleString()}</td>
        <td>${escapeHtml(r.status || '-')}</td>
        <td><button data-id="${r.id}" class="small-btn approve">Approve</button> <button data-id="${r.id}" class="small-btn decline">Decline</button></td>
      </tr>`).join('');
      tbody.querySelectorAll('button.approve').forEach(b => b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-id');
        if(!confirm('Approve #' + id + '?')) return;
        const r = await apiFetch('/api/kyc/' + encodeURIComponent(id) + '/decision', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ adminId: localStorage.getItem('userId')||null, decision:'approve', adminNote:'Approved via UI' }) });
        if(r.ok && r.body && r.body.success){ alert('Approved'); loadKyc(); } else alert('Failed to approve');
      }));
      tbody.querySelectorAll('button.decline').forEach(b => b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-id');
        if(!confirm('Decline #' + id + '?')) return;
        const r = await apiFetch('/api/kyc/' + encodeURIComponent(id) + '/decision', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ adminId: localStorage.getItem('userId')||null, decision:'decline', adminNote:'Declined via UI' }) });
        if(r.ok && r.body && r.body.success){ alert('Declined'); loadKyc(); } else alert('Failed to decline');
      }));
      return;
    }
    tbody.innerHTML = `<tr><td colspan="6" class="empty">Failed to load KYC (${res.status||res.error})</td></tr>`;
  }

  // job lookup
  document.getElementById('jobLookupBtn').addEventListener('click', async ()=>{
    const id = (document.getElementById('jobIdInput').value || '').trim();
    if(!id) { alert('Enter job id'); return; }
    await fetchJobAndRender(id);
  });
  document.getElementById('overviewJobLookup').addEventListener('click', async ()=>{
    const id = (document.getElementById('overviewJobId').value || '').trim();
    if(!id) { alert('Enter job id'); return; }
    await fetchJobAndRender(id, 'overviewJobResult');
  });

  async function fetchJobAndRender(jobId, targetId = 'jobDetail'){
    const target = document.getElementById(targetId);
    target.innerHTML = `<div class="card"><div class="muted">Loading job ${escapeHtml(jobId)}‚Ä¶</div></div>`;
    const res = await apiFetch('/api/job/' + encodeURIComponent(jobId));
    if(res.ok && res.body && res.body.success && res.body.job){
      const job = res.body.job;
      const client = res.body.client;
      const tech = res.body.technician;
      target.innerHTML = `<div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Job ${escapeHtml(job.id)}</strong><div class="muted" style="margin-top:6px">Status: ${escapeHtml(job.status)}</div></div>
          <div><button id="openChatBtn" class="small-btn">Open chat</button></div>
        </div>
        <div style="margin-top:8px" class="small">Client: ${escapeHtml(client ? (client.fullname || client.username) : job.client_id)} ${client ? '('+escapeHtml(client.city||'')+')' : ''}</div>
        <div class="small" style="margin-top:6px">Technician: ${tech ? escapeHtml(tech.fullname || tech.username) : '-'}</div>
        <div style="margin-top:8px">${escapeHtml(job.description || '')}</div>
      </div>`;
      document.getElementById('openChatBtn').addEventListener('click', ()=> {
        const qs = 'jobId=' + encodeURIComponent(job.id) + (job.assigned_tech_id ? ('&techId=' + encodeURIComponent(job.assigned_tech_id)) : '');
        window.location.href = 'chat.html?' + qs;
      });
    } else {
      target.innerHTML = `<div class="card"><div class="empty">Job not found or server error (${res.status||res.error})</div></div>`;
    }
  }

  // Users panel
  document.getElementById('userLookupBtn').addEventListener('click', async ()=>{
    const uid = (document.getElementById('userIdInput').value || '').trim();
    if(!uid){ alert('Enter user id'); return; }
    const slot = document.getElementById('userCard');
    slot.innerHTML = `<div class="card"><div class="muted">Loading user‚Ä¶</div></div>`;
    const res = await apiFetch('/api/user/' + encodeURIComponent(uid));
    if(res.ok && res.body && res.body.user){
      const u = res.body.user;
      slot.innerHTML = `<div class="card">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="width:64px;height:64px;border-radius:10px;background:#f3f7ff;display:flex;align-items:center;justify-content:center">${escapeHtml((u.fullname||u.username||'U').slice(0,2))}</div>
          <div>
            <div style="font-weight:800">${escapeHtml(u.fullname || u.username)}</div>
            <div class="muted">${escapeHtml(u.email||u.phone||'')}</div>
            <div class="small" style="margin-top:6px">Role: ${escapeHtml(u.role||'unknown')} ‚Ä¢ ${escapeHtml(u.state||'-')}</div>
            <div class="small" style="margin-top:6px">Coords: ${u.lat===null?'-':u.lat}, ${u.lng===null?'-':u.lng}</div>
            <div class="small" style="margin-top:6px">Online: <span id="userOnlineFlag">${u.online? 'Yes' : 'No'}</span></div>
          </div>
        </div>
      </div>`;
    } else {
      slot.innerHTML = `<div class="card"><div class="empty">User not found (${res.status||res.error})</div></div>`;
    }
  });

  // set online/offline (calls /api/tech/status)
  async function setOnlineFlag(userId, online){
    if(!userId) return alert('Missing user id');
    const body = { techId: userId, online: !!online, lat: null, lng: null };
    const res = await apiFetch('/api/tech/status', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(res.ok && res.body && res.body.success){ alert('Updated'); document.getElementById('userLookupBtn').click(); loadOverview(); }
    else alert('Failed to update: ' + (res.body && res.body.message ? res.body.message : (res.status||res.error)));
  }
  document.getElementById('setOnlineBtn').addEventListener('click', ()=> {
    const uid = (document.getElementById('userIdInput').value || '').trim(); if(!uid) return alert('Enter user id'); setOnlineFlag(uid, true);
  });
  document.getElementById('setOfflineBtn').addEventListener('click', ()=> {
    const uid = (document.getElementById('userIdInput').value || '').trim(); if(!uid) return alert('Enter user id'); setOnlineFlag(uid, false);
  });

  // nav helpers for panels present in DOM
  document.querySelectorAll('#menu a[data-panel]').forEach(a => a.addEventListener('click', (e)=>{
    e.preventDefault();
    const panel = a.getAttribute('data-panel');
    openPanel(panel);
  }));

  // top refresh handlers
  refreshAllBtn.addEventListener('click', ()=> { loadOverview(); const cur = window.__panel || 'overview'; openPanel(cur); });
  panelRefresh.addEventListener('click', ()=> { const cur = window.__panel || 'overview'; openPanel(cur); });

  // initial load
  openPanel('overview');
  loadOverview();
  setInterval(loadOverview, 15_000);

  // escape helper
  function escapeHtml(str){ if(!str && str !== 0) return ''; return String(str).replace(/[&<>"'`=\/]/g, function(ch){ return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;' })[ch]; }); }

  // logout
  document.getElementById('logout').addEventListener('click', (e)=> { e.preventDefault(); localStorage.removeItem('wc_admin_token'); localStorage.removeItem('wc_token'); showPopup('Logged out (token cleared). Refresh to re-login.'); });

  // set admin name if available
  try { const me = JSON.parse(localStorage.getItem('wc_user') || 'null'); if(me && (me.fullname||me.username)) document.getElementById('adminName').innerText = (me.fullname||me.username); } catch(e){}
})();
</script>
</body>
</html>