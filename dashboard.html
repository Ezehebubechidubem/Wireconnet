<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect — Dashboard</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --accent:#0b5cff; --muted:#6b7280;
      --surface:#ffffff; --shadow: 0 8px 30px rgba(16,24,40,0.06);
      --radius:12px;
    }
    html,body{height:100%;margin:0}
    body{
      height:100%;
      font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:#111827;
      display:flex;flex-direction:column;
    }
    header{display:flex;align-items:center;gap:12px;padding:12px;box-sizing:border-box;width:100%}
    .logo{flex:1;display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,var(--accent),#55a7ff);border-radius:10px;padding:8px 12px;color:white;box-shadow:0 8px 24px rgba(11,92,255,0.08);min-height:56px}
    .logo img{height:40px;border-radius:6px;object-fit:contain}
    .menu-btn{width:54px;height:54px;border-radius:10px;border:0;background:var(--accent);color:white;display:flex;align-items:center;justify-content:center;cursor:pointer}
    main{flex:1 1 auto;display:flex;align-items:flex-start;justify-content:center;width:100%;box-sizing:border-box;padding:14px;overflow:hidden}
    .card {width:100%;max-width:980px;height:100%;background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);box-sizing:border-box;display:flex;flex-direction:column;overflow:hidden}
    .content {flex:1 1 auto;overflow:auto;padding-right:6px}
    .section{background:var(--surface);border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(16,24,40,0.04)}
    .section h3{margin:0 0 6px;font-size:16px}
    .top-list{padding:8px 0}
    .top-item{padding:10px;border-radius:8px;background:linear-gradient(180deg,#ffffff,#fbfcff);margin-bottom:8px}
    .muted{color:var(--muted);font-size:13px}
    .drawer-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;z-index:1000}
    .drawer{position:fixed;right:0;top:0;height:100%;width:360px;max-width:92vw;background:white;box-shadow:-16px 0 40px rgba(2,6,23,0.12);transform:translateX(100%);transition:transform .28s ease;z-index:1001;padding:18px;box-sizing:border-box}
    .drawer.open{transform:translateX(0)}
    .drawer .header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .logo-small{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#55a7ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    .drawer a{display:block;padding:12px;border-radius:8px;color:#0b0b0b;text-decoration:none;margin-bottom:8px;border:1px solid #f1f5f9;background:#fbfdff}
    .drawer a.primary{background:linear-gradient(90deg,var(--accent),#55a7ff);color:white;border:0}
    .drawer .muted{font-size:13px;color:var(--muted)}
    .toggle-row{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px 0}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#eef3ff;color:var(--accent)}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .hero{width:100%;border-radius:10px;overflow:hidden;background:linear-gradient(90deg,#eef6ff,#ffffff);display:flex;align-items:center;justify-content:center;padding:8px;margin-bottom:12px}
    .hero img{width:100%;height:auto;max-height:140px;object-fit:cover;border-radius:8px}
    @media(max-width:720px){ .logo img{height:34px} .drawer{width:92vw} .card{border-radius:12px;padding:12px} }
    .content::-webkit-scrollbar{width:8px}
    .content::-webkit-scrollbar-thumb{background:rgba(11,92,255,0.12);border-radius:8px}
    .small-note{font-size:13px;color:var(--muted);padding:6px 0}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid #e6eef9;padding:8px 12px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .status-row{display:flex;flex-direction:column;gap:6px}
    .status-info{font-size:13px;color:#0b5cff}
    .loading{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid rgba(11,92,255,0.2);border-top-color:var(--accent);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div class="logo" role="banner" aria-label="WireConnect">
      <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect logo">
    </div>
    <button id="menuBtn" class="menu-btn" aria-label="Open menu">☰</button>
  </header>

  <main>
    <section class="card" role="main" aria-labelledby="dashboardHeading">
      <div class="topbar">
        <div>
          <div id="dashboardHeading" style="font-size:18px;font-weight:700">Welcome</div>
          <div class="muted" id="userGreeting">—</div>
        </div>
        <div class="badge" id="statusBadge" aria-live="polite">Offline</div>
      </div>

      <div class="content">
        <div class="hero">
          <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect banner">
        </div>

        <section class="section" aria-labelledby="leader">
          <h3 id="leader">Leaderboard</h3>
          <div id="leaderboard" style="margin-top:8px"></div>
        </section>

        <section class="section" aria-labelledby="jobs">
          <h3 id="jobs">Your Jobs</h3>
          <div id="jobsList">
            <div class="muted">No jobs yet.</div>
          </div>
        </section>

        <div class="small-note">Quick actions (Profile, KYC, Booking (clients only), Settings, Sign out) are available inside the Menu (top-right).</div>
      </div>
    </section>
  </main>

  <!-- Drawer -->
  <div id="drawerBackdrop" class="drawer-backdrop" aria-hidden="true"></div>
  <aside id="drawer" class="drawer" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Main menu">
    <div class="header">
      <div class="logo-small" aria-hidden="true">
        <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="" style="height:28px;object-fit:contain">
      </div>
      <div>
        <div style="font-weight:700">Quick Menu</div>
        <div class="muted" id="drawerUser">User</div>
      </div>
      <button id="closeDrawerBtn" style="margin-left:auto;background:transparent;border:0;font-size:16px;cursor:pointer">✕</button>
    </div>

    <nav id="drawerNav">
      <a href="profile.html" id="profileLink">Profile</a>
      <a href="kyc.html" id="kycLink">KYC</a>

      <a href="book.html" id="bookingLink" style="display:none" class="primary">Book</a>

      <div style="height:8px"></div>

      <div id="availabilityArea">
        <div style="font-weight:600">Availability</div>
        <div class="muted" style="margin-bottom:8px">Go online to receive job requests</div>

        <div class="toggle-row" style="align-items:center;">
          <div id="availabilityStatus" class="status-row">
            <!-- dynamic status lines inserted here -->
          </div>
          <div>
            <button id="toggleOnlineBtn" class="btn">Go Online</button>
          </div>
        </div>

        <div style="height:8px"></div>
        <div id="nearestDistance" class="small">Nearest job: —</div>
      </div>

      <div style="height:10px"></div>
      <a href="settings.html" id="settingsLink">Settings</a>
      <a href="#" id="logoutBtn" style="background:#fff;border:1px solid #f1f5f9">Sign out</a>

      <div style="height:14px"></div>
      <div class="muted" id="drawerFeedback" style="font-size:13px"></div>
    </nav>
  </aside>

  <script>
    // ---------- Config ----------
    // Root-based backend (same origin). Do not change; using '' means requests go to your Node.js root.
    const API_BASE = '';

    // ---------- Helpers ----------
    const $ = (s) => document.querySelector(s);
    const create = (t, attrs = {}) => { const e = document.createElement(t); Object.assign(e, attrs); return e; };

    // DOM refs
    const menuBtn = $('#menuBtn'), closeDrawerBtn = $('#closeDrawerBtn'), drawer = $('#drawer'), backdrop = $('#drawerBackdrop');
    const toggleOnlineBtn = $('#toggleOnlineBtn'), statusBadge = $('#statusBadge'), drawerFeedback = $('#drawerFeedback'), drawerUser = $('#drawerUser'), userGreeting = $('#userGreeting'), bookingLink = $('#bookingLink'), availabilityStatus = $('#availabilityStatus'), nearestDistance = $('#nearestDistance'), jobsListEl = $('#jobsList');

    // Drawer open/close
    menuBtn.addEventListener('click', ()=>{ drawer.classList.add('open'); backdrop.style.display='block'; drawer.setAttribute('aria-hidden','false'); backdrop.setAttribute('aria-hidden','false'); });
    backdrop.addEventListener('click', ()=>{ drawer.classList.remove('open'); backdrop.style.display='none'; drawer.setAttribute('aria-hidden','true'); backdrop.setAttribute('aria-hidden','true'); });
    closeDrawerBtn.addEventListener('click', ()=>{ drawer.classList.remove('open'); backdrop.style.display='none'; });

    // User handling
    function loadUser(){
      try{ const raw = localStorage.getItem('wc_user'); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }
    function isTechnicianRole(role){ return role === 'worker' || role === 'technician' || role === 'worker'; }

    // UI setter for online/offline
    function setOnlineUI(isOnline){
      statusBadge.textContent = isOnline ? 'Online' : 'Offline';
      statusBadge.style.background = isOnline ? '#ecfff5' : 'transparent';
      statusBadge.style.color = isOnline ? '#037a50' : 'var(--muted)';
      toggleOnlineBtn.textContent = isOnline ? 'Go Offline' : 'Go Online';
      toggleOnlineBtn.style.background = isOnline ? '#fff' : 'var(--accent)';
      toggleOnlineBtn.style.color = isOnline ? 'var(--accent)' : '#fff';
      toggleOnlineBtn.style.border = isOnline ? '1px solid #e6eef9' : '0';
    }

    // Haversine distance (km)
    function distanceKm(lat1, lon1, lat2, lon2){
      if(lat1==null||lon1==null||lat2==null||lon2==null) return null;
      const R = 6371; const toRad = v => v * Math.PI / 180;
      const dLat = toRad(lat2 - lat1); const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Fetch nearest assigned job and compute distance
    async function fetchNearestAssignedJob(techId, techLat, techLng){
      nearestDistance.textContent = 'Nearest job: checking...';
      try{
        const resp = await fetch(API_BASE + '/api/assigned-jobs?techId=' + encodeURIComponent(techId));
        const js = await resp.json().catch(()=>null);
        if(!resp.ok || !js || !js.success){ nearestDistance.textContent = 'Nearest job: none'; return; }
        const jobs = js.jobs || [];
        if(!jobs.length){ nearestDistance.textContent = 'Nearest job: none'; return; }

        const distances = jobs.map(j => {
          if(j.lat != null && j.lng != null && techLat != null && techLng != null){
            return { id: j.id, km: distanceKm(techLat, techLng, j.lat, j.lng), job: j };
          } else if(j.lat != null && j.lng != null){
            return { id: j.id, km: null, job: j };
          } else {
            return { id: j.id, km: null, job: j };
          }
        });

        const withKm = distances.filter(d=>d.km != null).sort((a,b)=>a.km - b.km);
        if(withKm.length){
          const nearest = withKm[0];
          nearestDistance.textContent = `Nearest job: ${nearest.job.job_type || 'Job'} — ${nearest.km.toFixed(2)} km away`;
          if(nearest.km > 50) nearestDistance.textContent += ' ( > 50km )';
        } else {
          nearestDistance.textContent = 'Nearest job: location unavailable';
        }
      }catch(e){
        console.warn('fetchNearestAssignedJob error', e);
        nearestDistance.textContent = 'Nearest job: error';
      }
    }

    // Update tech status: geolocation (if online) + POST /api/tech/status
    async function updateOnlineStatus(on){
      // show spinner when obtaining location
      availabilityStatus.innerHTML = '';
      if(on){
        const s = create('div'); s.innerHTML = '<span class="loading"></span> Obtaining location...'; availabilityStatus.appendChild(s);
      } else {
        availabilityStatus.innerHTML = '<div class="small">Setting offline...</div>';
      }

      // get geolocation if on
      let lat = null, lng = null, acc = null;
      if(on){
        try{
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy:true, timeout:10000 });
          });
          lat = pos.coords.latitude; lng = pos.coords.longitude; acc = pos.coords.accuracy;
        }catch(e){
          console.warn('geolocation not available or denied', e);
          // keep null coords — backend will accept null lat/lng
        }
      }

      const user = loadUser();
      if(!user){
        drawerFeedback.textContent = 'Please login to update status.';
        setOnlineUI(false); return;
      }

      // POST to backend
      try{
        const body = { techId: user.id, online: !!on, lat: lat || null, lng: lng || null };
        const resp = await fetch(API_BASE + '/api/tech/status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const js = await resp.json().catch(()=>null);
        if(resp.ok){
          drawerFeedback.textContent = js && js.message ? js.message : (on ? 'You are now online — waiting for jobs.' : 'You are now offline.');
        } else {
          drawerFeedback.textContent = 'Server: ' + (js && js.message ? js.message : resp.statusText);
        }
      }catch(err){
        console.warn('network error', err);
        drawerFeedback.textContent = 'Network: could not notify server (saved locally).';
      }

      // save ui state & coords
      localStorage.setItem('wc_online', on ? '1' : '0');
      if(lat != null && lng != null){
        localStorage.setItem('wc_last_lat', lat);
        localStorage.setItem('wc_last_lng', lng);
        localStorage.setItem('wc_last_acc', acc || 0);
      }
      setOnlineUI(on);

      // display coords / status
      availabilityStatus.innerHTML = '';
      if(on && lat != null && lng != null){
        const coordsLine = create('div'); coordsLine.innerHTML = `<div class="small">Location: ${lat.toFixed(6)}, ${lng.toFixed(6)} (±${Math.round(acc||0)}m)</div>`;
        availabilityStatus.appendChild(coordsLine);
      } else if(on){
        const noCoords = create('div'); noCoords.innerHTML = `<div class="small">Location not available (permission denied or timeout)</div>`;
        availabilityStatus.appendChild(noCoords);
      } else {
        const off = create('div'); off.innerHTML = `<div class="small">You are offline</div>`; availabilityStatus.appendChild(off);
      }

      // After going online, fetch nearest assigned job distances
      if(on){
        const latSaved = lat != null ? lat : parseFloat(localStorage.getItem('wc_last_lat') || null);
        const lngSaved = lng != null ? lng : parseFloat(localStorage.getItem('wc_last_lng') || null);
        if(latSaved != null && lngSaved != null){
          fetchNearestAssignedJob(user.id, latSaved, lngSaved);
        } else {
          // still attempt nearest by job location only (will show unavailable)
          fetchNearestAssignedJob(user.id, null, null);
        }
      } else {
        nearestDistance.textContent = 'Nearest job: —';
      }
    }

    // Toggle click
    toggleOnlineBtn.addEventListener('click', async ()=>{
      const current = localStorage.getItem('wc_online') === '1';
      await updateOnlineStatus(!current);
    });

    // Leaderboard load
    async function loadLeaderboard(){
      const container = $('#leaderboard');
      container.innerHTML = '<div class="muted">Loading...</div>';
      try{
        const resp = await fetch(API_BASE + '/api/dashboard?role=worker');
        const js = await resp.json().catch(()=>null);
        if(!resp.ok || !js || !js.success){ container.innerHTML = '<div class="muted">Could not load leaderboard</div>'; return; }
        const list = js.leaderboard || [];
        if(!list.length) { container.innerHTML = '<div class="muted">No entries yet</div>'; return; }
        container.innerHTML = '';
        list.forEach((t, idx)=>{
          const row = create('div'); row.style.padding='8px 0'; row.style.borderBottom='1px solid #f3f6fb';
          row.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${t.fullname || t.username}</strong><div class="small">jobs completed: ${t.jobs_completed || 0}</div></div><div class="small">${idx+1}</div></div>`;
          container.appendChild(row);
        });
      }catch(e){
        container.innerHTML = '<div class="muted">Failed to load leaderboard</div>';
      }
    }

    // Load jobs for user
    async function loadJobsForUser(){
      const user = loadUser();
      jobsListEl.innerHTML = `<div class="muted">Loading...</div>`;
      if(!user){ jobsListEl.innerHTML = '<div class="muted">Please login</div>'; return; }

      if(isTechnicianRole(user.role)){
        try{
          const resp = await fetch(API_BASE + '/api/assigned-jobs?techId=' + encodeURIComponent(user.id));
          const js = await resp.json().catch(()=>null);
          if(!resp.ok || !js || !js.success){ jobsListEl.innerHTML = '<div class="muted">No assigned jobs</div>'; return; }
          const jobs = js.jobs || [];
          if(!jobs.length){ jobsListEl.innerHTML = '<div class="muted">No pending jobs</div>'; return; }
          jobsListEl.innerHTML = '';
          jobs.forEach(j=>{
            const div = create('div'); div.className='section';
            div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>${j.job_type || 'Job'}</strong><div class="muted">${j.status} — ${j.created_at ? new Date(j.created_at).toLocaleString() : ''}</div></div>
              <div style="text-align:right">
                <button class="btn" data-action="accept" data-id="${j.id}">Accept</button>
                <button class="btn-ghost" data-action="decline" data-id="${j.id}">Decline</button>
              </div>
            </div>
            <div style="margin-top:8px" class="muted">${(j.description || '').slice(0,160)}</div>`;
            jobsListEl.appendChild(div);
          });
        }catch(e){
          jobsListEl.innerHTML = '<div class="muted">Failed to fetch assigned jobs</div>';
        }
      } else {
        // client side: show local bookings (fallback). Backend job listing can replace this later.
        const localJobs = JSON.parse(localStorage.getItem('wc_bookings') || '[]');
        if(!localJobs.length){ jobsListEl.innerHTML = '<div class="muted">No bookings yet</div>'; return; }
        jobsListEl.innerHTML = '';
        localJobs.slice(0,10).forEach(b=>{
          const div = create('div'); div.className='section';
          div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${b.jobType || 'Job'}</strong><div class="muted">${new Date(b.createdAt).toLocaleString()}</div></div>
            <div><button class="btn" data-openjob="${b.id}">Open</button></div>
          </div>
          <div style="margin-top:8px" class="muted">${(b.description||'').slice(0,160)}</div>`;
          jobsListEl.appendChild(div);
        });
      }
    }

    // Accept/Decline handlers
    document.addEventListener('click', async (ev)=>{
      const t = ev.target;
      if(t.dataset.action && t.dataset.id){
        const action = t.dataset.action, jobId = t.dataset.id;
        const user = loadUser(); if(!user) return alert('Please login');
        try{
          const resp = await fetch(API_BASE + `/api/job/${jobId}/respond`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ techId: user.id, action })
          });
          const js = await resp.json().catch(()=>null);
          if(resp.ok && js && js.success){ alert(js.message || 'OK'); setTimeout(()=>loadJobsForUser(), 800); }
          else alert('Failed: ' + (js && js.message ? js.message : resp.statusText));
        }catch(e){ alert('Network error'); }
      }

      if(t.dataset.openjob){
        const jobId = t.dataset.openjob;
        window.location.href = 'chat.html?jobId=' + encodeURIComponent(jobId);
      }
    });

    // Initialize UI
    (function init(){
      const user = loadUser();
      if(!user){
        $('#drawerUser').textContent = 'Guest';
        $('#userGreeting').textContent = 'Welcome — please login';
        bookingLink.style.display = 'none';
        availabilityStatus.innerHTML = '<div class="small">Location not set</div>';
        setOnlineUI(false);
        loadLeaderboard();
        loadJobsForUser();
        return;
      }

      $('#drawerUser').textContent = user.fullname || user.username || 'User';
      $('#userGreeting').textContent = `Welcome back — ${(user.fullname || user.username)}`;

      if(user.role === 'client'){
        bookingLink.style.display = 'block';
        availabilityStatus.innerHTML = '<div class="small">Clients do not have availability toggle</div>';
        availabilityStatus.style.pointerEvents = 'none';
        availabilityStatus.style.opacity = '0.9';
        setOnlineUI(false);
      } else if(isTechnicianRole(user.role)){
        bookingLink.style.display = 'none';
        // show saved coords (if any)
        const lastLat = localStorage.getItem('wc_last_lat'), lastLng = localStorage.getItem('wc_last_lng'), lastAcc = localStorage.getItem('wc_last_acc');
        if(lastLat && lastLng){
          availabilityStatus.innerHTML = `<div class="small">Last known: ${parseFloat(lastLat).toFixed(6)}, ${parseFloat(lastLng).toFixed(6)} (±${Math.round(lastAcc||0)}m)</div>`;
        } else {
          availabilityStatus.innerHTML = `<div class="small">Location not set</div>`;
        }
        const onlineFlag = localStorage.getItem('wc_online') === '1';
        setOnlineUI(onlineFlag);
      } else {
        bookingLink.style.display = 'none';
        availabilityStatus.innerHTML = '<div class="small">Role not recognized</div>';
        setOnlineUI(false);
      }

      loadLeaderboard();
      loadJobsForUser();

      // Poll assigned jobs & nearest distance periodically if technician & online
      if(isTechnicianRole(user.role)){
        setInterval(async ()=>{
          const onlineFlag = localStorage.getItem('wc_online') === '1';
          if(onlineFlag){
            const lat = parseFloat(localStorage.getItem('wc_last_lat') || null);
            const lng = parseFloat(localStorage.getItem('wc_last_lng') || null);
            await fetchNearestAssignedJob(user.id, lat, lng);
            await loadJobsForUser();
          }
        }, 6000);
      }
    })();

    // Logout
    $('#logoutBtn').addEventListener('click', (ev)=>{ ev.preventDefault(); localStorage.removeItem('wc_user'); localStorage.removeItem('wc_token'); localStorage.removeItem('wc_online'); localStorage.removeItem('wc_last_lat'); localStorage.removeItem('wc_last_lng'); localStorage.removeItem('wc_last_acc'); window.location.href='login.html'; });

  </script>
</body>
</html>