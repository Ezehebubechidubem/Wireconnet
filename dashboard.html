<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect — Dashboard</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --accent:#0b5cff; --muted:#6b7280;
      --surface:#ffffff; --shadow: 0 8px 30px rgba(16,24,40,0.06);
      --radius:12px;
    }
    html,body{height:100%;margin:0}
    body{height:100%;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:var(--bg);color:#111827;display:flex;flex-direction:column}
    header{display:flex;align-items:center;gap:12px;padding:12px;box-sizing:border-box;width:100%}
    .logo{flex:1;display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,var(--accent),#55a7ff);border-radius:10px;padding:8px 12px;color:white;box-shadow:0 8px 24px rgba(11,92,255,0.08);min-height:56px}
    .logo img{height:40px;border-radius:6px;object-fit:contain}
    .menu-btn{width:54px;height:54px;border-radius:10px;border:0;background:var(--accent);color:white;display:flex;align-items:center;justify-content:center;cursor:pointer}
    main{flex:1 1 auto;display:flex;align-items:flex-start;justify-content:center;width:100%;box-sizing:border-box;padding:14px;overflow:hidden}
    .card {width:100%;max-width:980px;height:100%;background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);box-sizing:border-box;display:flex;flex-direction:column;overflow:hidden}
    .content {flex:1 1 auto;overflow:auto;padding-right:6px}
    .section{background:var(--surface);border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(16,24,40,0.04)}
    .muted{color:var(--muted);font-size:13px}
    .drawer-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;z-index:1000}
    .drawer{position:fixed;right:0;top:0;height:100%;width:360px;max-width:92vw;background:white;box-shadow:-16px 0 40px rgba(2,6,23,0.12);transform:translateX(100%);transition:transform .28s ease;z-index:1001;padding:18px;box-sizing:border-box}
    .drawer.open{transform:translateX(0)}
    .logo-small{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#55a7ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    .drawer a{display:block;padding:12px;border-radius:8px;color:#0b0b0b;text-decoration:none;margin-bottom:8px;border:1px solid #f1f5f9;background:#fbfdff}
    .drawer a.primary{background:linear-gradient(90deg,var(--accent),#55a7ff);color:white;border:0}
    .toggle-row{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px 0}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#eef3ff;color:var(--accent)}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .hero{width:100%;border-radius:10px;overflow:hidden;background:linear-gradient(90deg,#eef6ff,#ffffff);display:flex;align-items:center;justify-content:center;padding:8px;margin-bottom:12px}
    .hero img{width:100%;height:auto;max-height:140px;object-fit:cover;border-radius:8px}
    .small{font-size:13px;color:var(--muted)}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid #e6eef9;padding:8px 12px;border-radius:8px;cursor:pointer}
    input, textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid #eef3fb;box-sizing:border-box}
    .diag{background:#0b1220;color:#e6f0ff;padding:10px;border-radius:8px;font-family:monospace;font-size:13px;white-space:pre-wrap;overflow:auto;max-height:220px}
    .loading{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid rgba(11,92,255,0.2);border-top-color:var(--accent);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:720px){ .logo img{height:34px} .drawer{width:92vw} .card{border-radius:12px;padding:12px} }
  </style>
</head>
<body>
  <header>
    <div class="logo" role="banner" aria-label="WireConnect">
      <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect logo">
      <div style="font-weight:700">WireConnect</div>
    </div>
    <button id="menuBtn" class="menu-btn" aria-label="Open menu">☰</button>
  </header>

  <main>
    <section class="card" role="main" aria-labelledby="dashboardHeading">
      <div class="topbar">
        <div>
          <div id="dashboardHeading" style="font-size:18px;font-weight:700">Welcome</div>
          <div class="muted" id="userGreeting">—</div>
        </div>
        <div class="badge" id="statusBadge" aria-live="polite">Offline</div>
      </div>

      <div class="content">
        <div style="flex:1;min-width:320px">
          <div class="hero"><img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect banner"></div>

          <section class="section">
            <h3>Availability (Client & Technician)</h3>
            <div class="muted">Both clients and technicians can toggle Online / Offline. When online we attempt to get geolocation and send it to the server.</div>
            <div style="height:8px"></div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="toggleOnlineBtn" class="btn">Go Online</button>
              <button id="getLocBtn" class="btn-ghost">Get Location</button>
            </div>
            <div style="height:8px"></div>
            <div id="locInfo" class="small">Last location: —</div>
            <div style="height:8px"></div>
            <div id="clientControls" style="display:none">
              <label class="small">Client: preferred max distance (km)</label>
              <input id="clientRadius" type="number" min="1" value="50">
              <div class="small">This preference is saved locally and included in diagnostics/test booking payloads.</div>
            </div>
          </section>

          <section class="section">
            <h3>Test Booking (client)</h3>
            <div class="muted">Quick test booking for debugging. Use this to reproduce /api/book errors — diagnostics below will show exact request & response.</div>
            <div style="height:8px"></div>

            <label>Use assign endpoint (returns assigned tech immediately if available)</label>
            <div style="margin-bottom:8px"><label><input id="useAssign" type="checkbox"> /api/book-assign</label></div>

            <label>Job type</label>
            <select id="tb_job_type"><option value="conduit">Conduit wiring</option><option value="solar">Solar installation</option><option value="other">Other</option></select>

            <label>Price (₦)</label>
            <input id="tb_price" type="number" value="100000">

            <label>Description</label>
            <textarea id="tb_description" rows="3">Test booking from dashboard</textarea>

            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="tbSend" class="btn">Send Test Booking</button>
              <button id="tbShowPayload" class="btn-ghost">Show Payload</button>
            </div>

            <div style="height:12px"></div>
            <h4>Diagnostics</h4>
            <div id="diagBox" class="diag">No requests yet.</div>
          </section>
        </div>

        <div style="width:360px;min-width:320px">
          <section class="section">
            <h3>Leaderboard</h3>
            <div id="leaderboard" class="small">Loading...</div>
          </section>

          <section class="section">
            <h3>Your Jobs / Bookings</h3>
            <div id="jobsList" class="small">Loading...</div>
          </section>

          <section class="section">
            <h3>Quick Logs</h3>
            <div id="quickLogs" class="small">No logs yet.</div>
          </section>
        </div>
      </div>
    </section>
  </main>

  <!-- Drawer -->
  <div id="drawerBackdrop" class="drawer-backdrop" aria-hidden="true"></div>
  <aside id="drawer" class="drawer" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Main menu">
    <div class="header" style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <div class="logo-small"><img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="" style="height:28px;object-fit:contain"></div>
      <div><div style="font-weight:700">Quick Menu</div><div class="muted" id="drawerUser">User</div></div>
      <button id="closeDrawerBtn" style="margin-left:auto;background:transparent;border:0;font-size:16px;cursor:pointer">✕</button>
    </div>
    <nav>
      <a href="profile.html">Profile</a>
      <a href="kyc.html">KYC</a>
      <a href="book.html" id="drawerBookLink" style="display:none">Book</a>
      <div style="height:8px"></div>
      <a href="settings.html">Settings</a>
      <a href="#" id="logoutBtn" style="background:#fff;border:1px solid #f1f5f9">Sign out</a>
      <div style="height:14px"></div>
      <div class="muted" id="drawerFeedback" style="font-size:13px"></div>
    </nav>
  </aside>

  <script>
    // Root backend base (same origin)
    const API_BASE = '';

    // DOM refs
    const menuBtn = document.getElementById('menuBtn');
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('drawerBackdrop');
    const closeDrawerBtn = document.getElementById('closeDrawerBtn');
    const toggleOnlineBtn = document.getElementById('toggleOnlineBtn');
    const getLocBtn = document.getElementById('getLocBtn');
    const locInfo = document.getElementById('locInfo');
    const statusBadge = document.getElementById('statusBadge');
    const clientControls = document.getElementById('clientControls');
    const clientRadius = document.getElementById('clientRadius');
    const useAssign = document.getElementById('useAssign');
    const tb_job_type = document.getElementById('tb_job_type');
    const tb_price = document.getElementById('tb_price');
    const tb_description = document.getElementById('tb_description');
    const tbSend = document.getElementById('tbSend');
    const tbShowPayload = document.getElementById('tbShowPayload');
    const diagBox = document.getElementById('diagBox');
    const leaderboard = document.getElementById('leaderboard');
    const jobsList = document.getElementById('jobsList');
    const drawerUser = document.getElementById('drawerUser');
    const drawerBookLink = document.getElementById('drawerBookLink');
    const logoutBtn = document.getElementById('logoutBtn');
    const quickLogs = document.getElementById('quickLogs');

    // helpers
    const $ = s => document.querySelector(s);
    const logQuick = (txt) => { quickLogs.textContent = new Date().toLocaleTimeString() + ' — ' + txt + '\\n' + quickLogs.textContent; };

    function loadUser(){
      try { const raw = localStorage.getItem('wc_user'); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }
    function isTechRole(role){ return role === 'worker' || role === 'technician' || role === 'tech'; }

    function setOnlineUI(isOnline){
      statusBadge.textContent = isOnline ? 'Online' : 'Offline';
      statusBadge.style.background = isOnline ? '#ecfff5' : 'transparent';
      statusBadge.style.color = isOnline ? '#037a50' : 'var(--muted)';
      toggleOnlineBtn.textContent = isOnline ? 'Go Offline' : 'Go Online';
      toggleOnlineBtn.style.background = isOnline ? '#fff' : 'var(--accent)';
      toggleOnlineBtn.style.color = isOnline ? 'var(--accent)' : '#fff';
    }

    // geolocation promise
    function getLocation(timeout = 10000){
      return new Promise((resolve, reject) => {
        if(!navigator.geolocation) return reject(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy:true, timeout });
      });
    }

    // update loc info UI from localStorage
    function updateLocInfo(){
      const lat = localStorage.getItem('wc_last_lat'), lng = localStorage.getItem('wc_last_lng'), acc = localStorage.getItem('wc_last_acc');
      if(lat && lng){
        locInfo.textContent = `Last location: ${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)} (±${Math.round(acc||0)}m)`;
      } else {
        locInfo.textContent = 'Last location: not set';
      }
    }

    // send /api/tech/status for any role (techId is user's id)
    async function updateOnlineStatus(on){
      const user = loadUser();
      if(!user){ diagBox.textContent = 'Please login first.'; return; }

      diagBox.textContent = 'Updating status...';
      let lat = null, lng = null, acc = null;
      if(on){
        try{ const pos = await getLocation(); lat = pos.coords.latitude; lng = pos.coords.longitude; acc = pos.coords.accuracy; } catch(e){ diagBox.textContent = 'Location not available. Proceeding without coords.'; }
      }

      const payload = { techId: user.id, online: !!on, lat: lat || null, lng: lng || null };
      diagBox.textContent = 'POST /api/tech/status\\n' + JSON.stringify(payload, null, 2);
      try{
        const resp = await fetch(API_BASE + '/api/tech/status', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const txt = await resp.text().catch(()=>null);
        let body = null;
        try{ body = txt ? JSON.parse(txt) : null; } catch(e){ body = txt; }
        diagBox.textContent += '\\n---- RESPONSE ----\\nStatus: ' + resp.status + '\\n' + JSON.stringify(body, null, 2);
        logQuick('POST /api/tech/status -> ' + resp.status);
      }catch(err){
        diagBox.textContent += '\\n---- NETWORK ERROR ----\\n' + String(err);
        logQuick('Network error /api/tech/status');
      }

      localStorage.setItem('wc_online', on ? '1' : '0');
      if(lat != null && lng != null){ localStorage.setItem('wc_last_lat', lat); localStorage.setItem('wc_last_lng', lng); localStorage.setItem('wc_last_acc', acc || 0); }
      setOnlineUI(on);
      updateLocInfo();
      setTimeout(loadJobsForUser, 600);
    }

    // Test booking (client)
    async function sendTestBooking(){
      const user = loadUser();
      if(!user) { alert('Please login as a client'); return; }
      if(user.role !== 'client'){ alert('Only clients can send bookings from this page'); return; }

      const endpoint = useAssign.checked ? '/api/book-assign' : '/api/book';
      const lat = parseFloat(localStorage.getItem('wc_last_lat') || null);
      const lng = parseFloat(localStorage.getItem('wc_last_lng') || null);
      const payload = {
        clientId: user.id,
        state: user.state || 'unknown',
        city: user.city || null,
        address: null,
        lat: isFinite(lat) ? lat : null,
        lng: isFinite(lng) ? lng : null,
        job_type: tb_job_type.value,
        description: tb_description.value,
        price: Number(tb_price.value) || 0
      };

      // client preferred radius is local-only (for diagnostics)
      const prefRadius = Number(clientRadius.value || 50);

      diagBox.textContent = `POST ${endpoint}\\npreferred_radius_km: ${prefRadius}\\nPAYLOAD:\\n${JSON.stringify(payload, null, 2)}\\nSending...`;
      try{
        const resp = await fetch(API_BASE + endpoint, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const txt = await resp.text().catch(()=>null);
        let body = null;
        try{ body = txt ? JSON.parse(txt) : null; } catch(e){ body = txt; }
        diagBox.textContent += '\\n---- RESPONSE ----\\nStatus: ' + resp.status + '\\n' + JSON.stringify(body, null, 2);
        logQuick('POST ' + endpoint + ' -> ' + resp.status);

        // persist bookings locally for client view (so dashboard shows it)
        if(resp.ok && body && body.success && body.jobId){
          const list = JSON.parse(localStorage.getItem('wc_bookings') || '[]');
          list.unshift({ id: body.jobId, jobType: payload.job_type, description: payload.description, price: payload.price, createdAt: new Date().toISOString(), assigned: body.assigned || false, technician: body.technician || null });
          localStorage.setItem('wc_bookings', JSON.stringify(list));
          loadJobsForUser();

          // redirect to chat if job created
          window.location.href = 'chat.html?jobId=' + encodeURIComponent(body.jobId);
        }

      }catch(err){
        diagBox.textContent += '\\n---- NETWORK ERROR ----\\n' + String(err);
        logQuick('Network error test booking');
      }
    }

    // Show payload only
    function showPayloadOnly(){
      const user = loadUser();
      if(!user) { alert('Please login'); return; }
      const lat = parseFloat(localStorage.getItem('wc_last_lat') || null);
      const payload = {
        clientId: user.id,
        state: user.state || 'unknown',
        city: user.city || null,
        lat: isFinite(lat) ? lat : null,
        lng: parseFloat(localStorage.getItem('wc_last_lng') || null),
        job_type: tb_job_type.value,
        description: tb_description.value,
        price: Number(tb_price.value) || 0
      };
      diagBox.textContent = 'PAYLOAD (not sent):\\n' + JSON.stringify(payload, null, 2);
    }

    // Leaderboard loader
    async function loadLeaderboard(){
      leaderboard.textContent = 'Loading...';
      try{
        const r = await fetch(API_BASE + '/api/dashboard?role=worker');
        const js = await r.json();
        if(!js || !js.success){ leaderboard.textContent = 'Could not load leaderboard'; return; }
        const list = js.leaderboard || [];
        if(!list.length){ leaderboard.textContent = 'No entries yet'; return; }
        leaderboard.innerHTML = '';
        list.forEach((t, i) => {
          const div = document.createElement('div');
          div.innerHTML = `<strong>${t.fullname || t.username}</strong><div class="small">jobs completed: ${t.jobs_completed || 0}</div>`;
          leaderboard.appendChild(div);
        });
      }catch(e){ leaderboard.textContent = 'Error loading leaderboard'; console.warn(e); }
    }

    // Load jobs/bookings for the signed-in user
    async function loadJobsForUser(){
      const user = loadUser();
      if(!user){ jobsList.textContent = 'Please login'; return; }
      if(isTechRole(user.role)){
        jobsList.textContent = 'Loading assigned jobs...';
        try{
          const r = await fetch(API_BASE + '/api/assigned-jobs?techId=' + encodeURIComponent(user.id));
          const js = await r.json();
          if(!js || !js.success){ jobsList.textContent = 'No assigned jobs'; return; }
          const arr = js.jobs || [];
          if(!arr.length){ jobsList.textContent = 'No pending jobs'; return; }
          jobsList.innerHTML = '';
          arr.forEach(j => {
            const d = document.createElement('div');
            d.style.marginBottom = '8px';
            d.innerHTML = `<div><strong>${j.job_type || 'Job'}</strong> <div class="muted">status: ${j.status} ${j.assigned_at ? ' — assigned: ' + new Date(j.assigned_at).toLocaleString(): ''}</div></div>
              <div style="margin-top:6px">${(j.description||'').slice(0,150)}</div>
              <div style="margin-top:8px"><button class="btn" data-action="accept" data-id="${j.id}">Accept</button> <button class="btn-ghost" data-action="decline" data-id="${j.id}">Decline</button></div>`;
            jobsList.appendChild(d);
          });
        }catch(e){ jobsList.textContent = 'Failed to load assigned jobs'; console.warn(e); }
      } else {
        const list = JSON.parse(localStorage.getItem('wc_bookings') || '[]');
        if(!list.length){ jobsList.textContent = 'No bookings yet'; return; }
        jobsList.innerHTML = '';
        list.slice(0,10).forEach(b => {
          const d = document.createElement('div');
          d.style.marginBottom = '8px';
          d.innerHTML = `<div><strong>${b.jobType}</strong> <div class="muted">${new Date(b.createdAt).toLocaleString()}</div></div>
                         <div style="margin-top:6px">${(b.description||'').slice(0,150)}</div>`;
          jobsList.appendChild(d);
        });
      }
    }

    // Accept/Decline handlers
    document.addEventListener('click', async (ev) => {
      const t = ev.target;
      if(t.dataset.action && t.dataset.id){
        const action = t.dataset.action, jobId = t.dataset.id;
        const user = loadUser();
        if(!user){ alert('Please login'); return; }
        try{
          const resp = await fetch(API_BASE + `/api/job/${jobId}/respond`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ techId: user.id, action }) });
          const js = await resp.json().catch(()=>null);
          if(resp.ok && js && js.success){ alert(js.message || 'OK'); loadJobsForUser(); }
          else alert('Failed: ' + (js && js.message ? js.message : resp.statusText));
        }catch(e){ alert('Network error'); }
      }
    });

    // Initialization
    (function init(){
      const user = loadUser();
      if(!user){
        drawerUser.textContent = 'Guest';
        document.getElementById('dashboardHeading').textContent = 'Welcome — please login';
        diagBox.textContent = 'Not logged in. Set localStorage.wc_user from login response to test.';
        setOnlineUI(false);
        loadLeaderboard();
        return;
      }

      drawerUser.textContent = user.fullname || user.username || 'User';
      document.getElementById('dashboardHeading').textContent = `Welcome back — ${user.fullname || user.username}`;
      // show/hide client controls
      if(user.role === 'client'){
        clientControls.style.display = 'block';
        drawerBookLink.style.display = 'block';
      } else {
        clientControls.style.display = 'none';
        drawerBookLink.style.display = 'none';
      }

      // load persisted client radius if any
      clientRadius.value = localStorage.getItem('wc_client_radius') || 50;

      // restore online flag
      const onlineFlag = localStorage.getItem('wc_online') === '1';
      setOnlineUI(onlineFlag);
      updateLocInfo();

      loadLeaderboard();
      loadJobsForUser();
      // auto-refresh assigned jobs for techs
      if(isTechRole(user.role)) setInterval(loadJobsForUser, 6000);
    })();

    // handlers / UI wiring
    toggleOnlineBtn.addEventListener('click', async () => {
      const cur = localStorage.getItem('wc_online') === '1';
      await updateOnlineStatus(!cur);
    });
    getLocBtn.addEventListener('click', async () => {
      diagBox.textContent = 'Getting location...';
      try{
        const pos = await getLocation();
        localStorage.setItem('wc_last_lat', pos.coords.latitude);
        localStorage.setItem('wc_last_lng', pos.coords.longitude);
        localStorage.setItem('wc_last_acc', pos.coords.accuracy || 0);
        updateLocInfo();
        diagBox.textContent = 'Location captured: ' + pos.coords.latitude.toFixed(6) + ', ' + pos.coords.longitude.toFixed(6);
        logQuick('Location captured');
      }catch(err){
        diagBox.textContent = 'Could not get location: ' + String(err);
        logQuick('Location error: ' + String(err));
      }
    });
    tbShowPayload.addEventListener('click', () => {
      const user = loadUser();
      if(!user) return alert('Please login');
      const lat = parseFloat(localStorage.getItem('wc_last_lat') || null);
      const payload = {
        clientId: user.id,
        state: user.state || 'unknown',
        city: user.city || null,
        lat: isFinite(lat) ? lat : null,
        lng: parseFloat(localStorage.getItem('wc_last_lng') || null),
        job_type: tb_job_type.value,
        description: tb_description.value,
        price: Number(tb_price.value) || 0
      };
      diagBox.textContent = 'PAYLOAD (not sent):\\n' + JSON.stringify(payload, null, 2);
    });
    tbSend.addEventListener('click', async () => { await sendTestBooking(); });
    clientRadius.addEventListener('change', () => { localStorage.setItem('wc_client_radius', clientRadius.value); logQuick('Client radius set to ' + clientRadius.value + ' km'); });
    logoutBtn.addEventListener('click', (ev) => { ev.preventDefault(); localStorage.removeItem('wc_user'); localStorage.removeItem('wc_token'); localStorage.removeItem('wc_online'); window.location.href = 'login.html'; });

  </script>
</body>
</html>