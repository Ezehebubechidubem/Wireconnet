<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect — Book Job</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#fff;
      --accent:#0b5cff;
      --muted:#6b7280;
      --shadow: 0 8px 30px rgba(16,24,40,0.06);
      --radius:12px;
    }
    html,body{height:100%;margin:0}
    body{
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:#111827;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px;
    }

    .wrap{
      width:100%;
      max-width:980px;
      background:var(--card);
      border-radius:12px;
      padding:0;
      box-shadow:var(--shadow);
      box-sizing:border-box;
      overflow:hidden;
    }

    /* header row with logo */
    .header {
      width:100%;
      height:120px;
      overflow:hidden;
    }
    .header img{ width:100%; height:120px; object-fit:cover; display:block; }

    .content {
      padding:18px;
    }

    h1{margin:0;font-size:20px;font-weight:800;font-style:italic}
    .muted{color:var(--muted);font-size:13px}
    label{display:block;margin-bottom:6px;font-size:14px;font-weight:700}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #eef3fb;box-sizing:border-box;margin-bottom:8px;font-size:14px}
    textarea{font-family:inherit}

    .btn{background:var(--accent);color:white;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
    .btn-ghost{background:transparent;border:1px solid #e6eef9;padding:8px 12px;border-radius:8px;cursor:pointer}
    .estimate{background:#f0f7ff;padding:10px;border-radius:8px;margin-bottom:8px;font-weight:700}
    .small{font-size:13px;color:var(--muted)}
    .controls { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }

    /* modal (clean) */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ width:92%; max-width:520px; background:#fff; border-radius:12px; padding:18px; box-shadow:0 12px 48px rgba(2,6,23,0.4); }
    .modal h3{margin:0 0 8px;font-size:18px}
    .modal .muted{margin-bottom:8px;color:#374151}
    .spinner{ width:64px; height:64px; border-radius:50%; border:6px solid #eef6ff; border-top-color:var(--accent); animation:spin 1s linear infinite; margin:12px auto;}
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .success-icon{ display:block; width:64px; height:64px; margin:10px auto; background:#e6fdf0; border-radius:12px; align-items:center; justify-content:center; text-align:center; font-size:36px; color:#0f9a48; }
    .modal .btn { padding:10px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:800 }
    .modal .btn.secondary { background:#f3f4f6; color:#111; border:1px solid #e6eef9; }
    .tech-card{ display:flex; align-items:center; gap:12px; padding:10px; border-radius:10px; border:1px solid #eef6ff; background:#fbfeff; margin-top:8px }

    /* responsive minor */
    @media(max-width:680px){ .controls{flex-direction:column;align-items:stretch} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect logo">
    </div>

    <div class="content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div><h1>Book a Job</h1><div class="muted" id="userGreeting">—</div></div>
        <div style="align-self:flex-start"><a href="dashboard.html" style="text-decoration:none;color:var(--accent);font-weight:800">← Back to dashboard</a></div>
      </div>

      <!-- booking form -->
      <label>Choose job type</label>
      <select id="jobType">
        <option value="conduit">Conduit wiring</option>
        <option value="solar">Solar installation</option>
        <option value="other">Other (custom)</option>
      </select>

      <div id="conduitFields" style="margin-top:8px">
        <label>Number of rooms</label>
        <input id="conduitRooms" type="number" min="1" value="1">
        <label><input id="conduitDB" type="checkbox"> Include DB mounting (₦15,000)</label>
        <label><input id="conduitNEPA" type="checkbox"> Include NEPA connection (₦50,000)</label>
        <label><input id="conduitWiringAdd" type="checkbox"> Add extra wiring (₦5,000 per room)</label>
        <label><input id="conduitFittings" type="checkbox"> Include fittings (₦15,000 per room)</label>
      </div>

      <div id="solarFields" class="hidden" style="margin-top:8px">
        <label>Building type</label>
        <select id="solarBuilding">
          <option value="bungalow">Bungalow (base)</option>
          <option value="one_story">1 storey (base + 30,000)</option>
          <option value="two_plus">2+ storey (base + 60,000)</option>
        </select>
        <label><input id="solarComplex" type="checkbox"> Complex roof / high access (+₦50,000)</label>
      </div>

      <div id="otherFields" class="hidden" style="margin-top:8px">
        <label>Job name</label>
        <input id="otherName" type="text" placeholder="e.g. Plumbing, AC install">
      </div>

      <!-- NEW inputs: State, LGA, Town/City -->
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:8px;">
        <div>
          <label>State</label>
          <input id="stateInput" type="text" placeholder="State (e.g. Abuja)">
        </div>
        <div>
          <label>LGA</label>
          <input id="lgaInput" type="text" placeholder="LGA">
        </div>
        <div>
          <label>Town / City</label>
          <input id="cityInput" type="text" placeholder="Town or city">
        </div>
      </div>

      <!-- NEW inputs requested earlier -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
        <div>
          <label>Number of workers needed</label>
          <input id="workersNeeded" type="number" min="1" value="1">
        </div>
        <div>
          <label>Estimated days to finish</label>
          <input id="estimatedDays" type="number" min="1" value="1">
        </div>
      </div>

      <label style="margin-top:8px">Small description (max 500 words)</label>
      <textarea id="description" rows="5" placeholder="Describe the job — location, constraints, etc."></textarea>

      <div class="controls">
        <button id="calcBtn" class="btn" title="Estimate price">Calculate estimate</button>
        <button id="submitBtn" class="btn-ghost" title="Submit booking">Submit booking</button>

        <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
          <div style="background:#f3f8ff; border-radius:8px; padding:10px 12px; border:1px solid #eef3fb; color:var(--muted)">₦</div>
          <div id="priceDisplay" style="font-weight:800;font-size:16px">—</div>
        </div>

        <label style="margin-left:12px;align-self:center">
          <input id="useAssign" type="checkbox"> use /api/book-assign
        </label>
      </div>

      <div style="height:12px"></div>
      <div class="estimate" id="estimateBox"><em>Estimate:</em> —</div>

    </div>
  </div>

  <!-- modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div id="modalContent"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="modalClose" class="btn secondary">Close</button>
        <button id="modalOk" class="btn" style="display:none">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const API_BASE = 'https://wireconnet-1.onrender.com'; // change if needed

    // ======= DOM REFS =======
    const jobType = document.getElementById('jobType');
    const conduitFields = document.getElementById('conduitFields');
    const solarFields = document.getElementById('solarFields');
    const otherFields = document.getElementById('otherFields');
    const conduitRooms = document.getElementById('conduitRooms');
    const conduitDB = document.getElementById('conduitDB');
    const conduitNEPA = document.getElementById('conduitNEPA');
    const conduitWiringAdd = document.getElementById('conduitWiringAdd');
    const conduitFittings = document.getElementById('conduitFittings');
    const solarBuilding = document.getElementById('solarBuilding');
    const solarComplex = document.getElementById('solarComplex');
    const otherName = document.getElementById('otherName');
    const description = document.getElementById('description');
    const calcBtn = document.getElementById('calcBtn');
    const submitBtn = document.getElementById('submitBtn');
    const estimateBox = document.getElementById('estimateBox');
    const priceDisplay = document.getElementById('priceDisplay');
    const userGreeting = document.getElementById('userGreeting');
    const useAssign = document.getElementById('useAssign');

    const workersNeeded = document.getElementById('workersNeeded');
    const estimatedDays = document.getElementById('estimatedDays');

    const stateInput = document.getElementById('stateInput');
    const lgaInput = document.getElementById('lgaInput');
    const cityInput = document.getElementById('cityInput');

    // modal elements
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalContent = document.getElementById('modalContent');
    const modalClose = document.getElementById('modalClose');
    const modalOk = document.getElementById('modalOk');

    // ======= PRICES (fallback) =======
    let PRICES = {
      conduit_per_room: 25000,
      conduit_db: 15000,
      conduit_nepa: 50000,
      conduit_wiring_add_per_room: 5000,
      conduit_fittings_per_room: 15000,
      solar_base_bungalow: 170000,
      solar_extra_per_storey: 30000,
      solar_complex: 50000
    };

    // ======= modal helpers (clean look) =======
    function openModal(html, { showOk=false, onOk=null, closable=true } = {}) {
      modalContent.innerHTML = html;
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      modalOk.style.display = showOk ? 'inline-block' : 'none';
      modalClose.style.display = closable ? 'inline-block' : 'none';
      // wire OK
      modalOk.onclick = () => {
        if (typeof onOk === 'function') onOk();
        closeModal();
      };
    }
    function closeModal() {
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
      modalContent.innerHTML = '';
      modalOk.onclick = null;
    }

    function showLoadingModal(message = 'Searching for a nearby technician — please wait...') {
      const html = `<div style="text-align:center"><div class="spinner" role="status" aria-hidden="true"></div><div class="muted" style="margin-top:8px">${message}</div></div>`;
      openModal(html, { showOk:false, closable:false });
    }

    function showSuccessModal(technicianName, jobId, techId) {
      // success modal shows just technician name (per request)
      const html = `<div style="text-align:center">
        <div class="success-icon">✓</div>
        <h3 style="margin-top:6px">Assignment successful</h3>
        <div class="muted" style="margin-top:10px">Technician: <strong>${escapeHtml(technicianName || 'Technician')}</strong></div>
        <div style="margin-top:10px" class="muted">Press OK to open chat</div>
      </div>`;
      openModal(html, { showOk:true, onOk: () => {
        // redirect to chat with jobId & techId
        const qs = 'jobId=' + encodeURIComponent(jobId) + (techId ? ('&techId=' + encodeURIComponent(techId)) : '');
        window.location.href = 'chat.html?' + qs;
      }, closable:false });
    }

    function showNotAssignedModal() {
      const html = `<h3>No technician available right now</h3>
        <div class="muted" style="margin-top:8px">We created your job but couldn't assign a technician at this moment.</div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button id="na-ok" class="btn">OK</button>
        </div>`;
      openModal(html, { showOk:false, closable:true });
      document.getElementById('na-ok').addEventListener('click', closeModal);
    }

    function showErrorModal(title, msg) {
      const html = `<h3>${escapeHtml(title || 'Error')}</h3>
      <div class="muted" style="margin-top:8px">${escapeHtml(msg || 'An error occurred')}</div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="err-ok" class="btn">OK</button>
      </div>`;
      openModal(html, { showOk:false, closable:true });
      document.getElementById('err-ok').addEventListener('click', closeModal);
    }

    // small escape helper to avoid injection if backend returns strings
    function escapeHtml(s){
      if(!s && s !== 0) return '';
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // modal close behaviour
    modalClose.addEventListener('click', () => { closeModal(); });

    // ======= Form behaviour =======
    jobType.addEventListener('change', () => {
      const v = jobType.value;
      conduitFields.classList.toggle('hidden', v !== 'conduit');
      solarFields.classList.toggle('hidden', v !== 'solar');
      otherFields.classList.toggle('hidden', v !== 'other');
    });

    function calculateEstimateLocal(){
      const v = jobType.value;
      let total = 0;
      let breakdown = [];

      if(v === 'conduit'){
        const rooms = Math.max(1, Number(conduitRooms.value || 1));
        const base = PRICES.conduit_per_room * rooms;
        total += base; breakdown.push(`${rooms} room(s) × ₦${PRICES.conduit_per_room.toLocaleString()} = ₦${base.toLocaleString()}`);
        if(conduitDB.checked){ total += PRICES.conduit_db; breakdown.push(`DB mounting = ₦${PRICES.conduit_db.toLocaleString()}`); }
        if(conduitNEPA.checked){ total += PRICES.conduit_nepa; breakdown.push(`NEPA connection = ₦${PRICES.conduit_nepa.toLocaleString()}`); }
        if(conduitWiringAdd.checked){ const add = PRICES.conduit_wiring_add_per_room * rooms; total += add; breakdown.push(`Extra wiring ${rooms}×₦${PRICES.conduit_wiring_add_per_room.toLocaleString()} = ₦${add.toLocaleString()}`); }
        if(conduitFittings.checked){ const fit = PRICES.conduit_fittings_per_room * rooms; total += fit; breakdown.push(`Fittings ${rooms}×₦${PRICES.conduit_fittings_per_room.toLocaleString()} = ₦${fit.toLocaleString()}`); }
      } else if(v === 'solar'){
        let base = PRICES.solar_base_bungalow;
        const b = solarBuilding.value;
        if(b === 'bungalow') { base = PRICES.solar_base_bungalow; breakdown.push(`Bungalow base ₦${base.toLocaleString()}`); }
        else if(b === 'one_story') { base = PRICES.solar_base_bungalow + PRICES.solar_extra_per_storey; breakdown.push(`1 storey: base + ₦${PRICES.solar_extra_per_storey.toLocaleString()}`); }
        else if(b === 'two_plus') { base = PRICES.solar_base_bungalow + PRICES.solar_extra_per_storey * 2; breakdown.push(`2+ storey: base + ₦${(PRICES.solar_extra_per_storey*2).toLocaleString()}`); }
        total += base;
        if(solarComplex.checked){ total += PRICES.solar_complex; breakdown.push(`Complex roof = ₦${PRICES.solar_complex.toLocaleString()}`); }
      } else {
        total = 0;
        breakdown.push(`Custom job — client to set price at checkout/negotiation.`);
      }

      return { total, breakdown };
    }

    calcBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const res = calculateEstimateLocal();
      estimateBox.innerHTML = `<strong>Estimate: ₦${res.total.toLocaleString()}</strong><div class="small" style="margin-top:6px">${res.breakdown.join('<br>')}</div>`;
      priceDisplay.textContent = res.total > 0 ? res.total.toLocaleString() : '—';
    });

    // attempt to load backend prices (silent, non-blocking)
    (async function loadBackendPrices(){
      try{
        const r = await fetch(API_BASE + '/api/prices', { method:'GET', cache:'no-store' });
        if(!r.ok) return;
        const j = await r.json().catch(()=>null);
        const backend = j && j.prices ? j.prices : j;
        if(backend && typeof backend === 'object'){
          for(const k in backend){
            if(Object.prototype.hasOwnProperty.call(PRICES, k) && typeof backend[k] === 'number') PRICES[k] = backend[k];
          }
        }
      }catch(e){}
    })();

    // store / try geolocation (best-effort)
    async function tryGeolocationSave(){
      if(!navigator.geolocation) return;
      try{
        const pos = await new Promise((resolve,reject)=>{
          const t = setTimeout(()=> reject(new Error('geolocation timeout')), 4500);
          navigator.geolocation.getCurrentPosition(p => { clearTimeout(t); resolve(p); }, err => { clearTimeout(t); reject(err); }, { maximumAge:60000, timeout:4500 });
        });
        try{ localStorage.setItem('wc_last_lat', String(pos.coords.latitude)); localStorage.setItem('wc_last_lng', String(pos.coords.longitude)); }catch(e){}
      }catch(e){}
    }

    // get local (logged-in) user (assumes you store wc_user on login)
    function loadUser(){
      try { const raw = localStorage.getItem('wc_user'); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }

    // Submit booking (clean behaviour)
    submitBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      const user = loadUser();
      if(!user){
        showErrorModal('Login required', 'Please login as a client to create a booking.');
        return;
      }

      const jt = jobType.value;
      let job_type = jt;
      let descriptionText = description.value || '';
      if(jt === 'conduit'){
        const rooms = Math.max(1, Number(conduitRooms.value || 1));
        job_type = 'conduit';
        descriptionText = `Conduit wiring — rooms: ${rooms}. ` + descriptionText;
      } else if(jt === 'solar'){
        job_type = 'solar';
        descriptionText = `Solar install — building: ${solarBuilding.value}. ` + descriptionText;
      } else {
        job_type = otherName.value || 'other';
      }

      const est = calculateEstimateLocal();
      let price = est.total;
      if(price === 0 && jt === 'other'){
        const p = Number(prompt('Enter your estimated price in Naira (₦):', '50000')) || 0;
        price = p;
      }

      // best-effort geolocation (does not block)
      await tryGeolocationSave();
      const latLocal = parseFloat(localStorage.getItem('wc_last_lat') || 'NaN');
      const lngLocal = parseFloat(localStorage.getItem('wc_last_lng') || 'NaN');

      // gather inputs including State/LGA/City
      const payload = {
        clientId: user.id,
        state: (stateInput.value && stateInput.value.trim()) ? stateInput.value.trim() : (user.state || null),
        lga: (lgaInput.value && lgaInput.value.trim()) ? lgaInput.value.trim() : null,
        city: (cityInput.value && cityInput.value.trim()) ? cityInput.value.trim() : (user.city || null),
        address: null,
        lat: Number.isFinite(latLocal) ? latLocal : null,
        lng: Number.isFinite(lngLocal) ? lngLocal : null,
        job_type,
        description: descriptionText,
        price,
        workers_needed: Number(workersNeeded.value) || 1,
        estimated_days: Number(estimatedDays.value) || 1
      };

      // show loading modal
      showLoadingModal('Searching for a nearby technician — please wait...');

      try {
        const endpoint = useAssign.checked ? '/api/book-assign' : '/api/book';
        const controller = new AbortController();
        const timeoutId = setTimeout(()=> controller.abort(), 15000);

        const resp = await fetch(API_BASE + endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        const text = await resp.text().catch(()=>null);
        let body = null;
        try { body = text ? JSON.parse(text) : null; } catch(e){ body = text; }

        if(!resp.ok){
          closeModal();
          showErrorModal('Server error', (body && body.message) ? body.message : ('HTTP ' + resp.status));
          return;
        }

        // success handling
        if(body && body.success && body.jobId){
          // if assigned and technician info returned
          if(body.assigned === true && body.technician){
            // show success modal with only technician name; OK -> chat
            closeModal();
            const techName = body.technician.fullname || body.technician.username || body.technician.name || 'Technician';
            const techId = body.technician.id || body.technician.user_id || body.technician.techId || null;
            showSuccessModal(techName, body.jobId, techId);
            return;
          }

          // assigned but no technician details
          if(body.assigned === true && !body.technician){
            closeModal();
            showSuccessModal('Assigned', body.jobId, null);
            return;
          }

          // not assigned
          closeModal();
          showNotAssignedModal();
          return;
        } else {
          closeModal();
          showErrorModal('Unexpected response', 'Server returned an unexpected response.');
          return;
        }
      } catch(err) {
        closeModal();
        const isAbort = err && err.name === 'AbortError';
        showErrorModal(isAbort ? 'Request timed out' : 'Network error', String(err));
        return;
      }
    });

    // init: pre-fill state/city if user exists, and price estimate pre-calc
    (function init(){
      const u = loadUser();
      if(!u){
        // we don't force redirect here, but show placeholder greeting
        userGreeting.textContent = 'Not signed in';
      } else {
        userGreeting.textContent = `${u.fullname || u.username} ${u.city ? ('— ' + u.city) : ''}`;
        if(u.state && !stateInput.value) stateInput.value = u.state;
        if(u.city && !cityInput.value) cityInput.value = u.city;
      }
      // show initial estimate
      const r = calculateEstimateLocal();
      estimateBox.innerHTML = `<strong>Estimate: ₦${r.total.toLocaleString()}</strong><div class="small" style="margin-top:6px">${r.breakdown.join('<br>')}</div>`;
      priceDisplay.textContent = r.total > 0 ? r.total.toLocaleString() : '—';
    })();

    // close modal when clicking outside content area
    modalBackdrop.addEventListener('click', (e) => {
      if(e.target === modalBackdrop) {
        // only allow close when modal is closable (we hide Close/OK when not closable)
        closeModal();
      }
    });
  </script>
</body>
</html>