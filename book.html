<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect — Book Job</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#fff;
      --accent:#0b5cff;
      --muted:#6b7280;
      --surface:#ffffff;
      --shadow: 0 8px 30px rgba(16,24,40,0.06);
      --radius:12px;
    }
    html,body{height:100%;margin:0}
    body{
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:#111827;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px;
    }

    .wrap{
      width:100%;
      max-width:980px;
      background:var(--card);
      border-radius:12px;
      padding:0;
      box-shadow:var(--shadow);
      box-sizing:border-box;
      overflow:hidden;
    }

    /* HEADER: logo full width (removed the small title/back link) */
    .header-logo {
      width:100%;
      display:block;
      background:#fff;
      border-bottom: 1px solid #e6eef9;
    }
    .header-logo img {
      width:100%;
      height:120px;
      object-fit:cover;
      display:block;
    }

    .content {
      padding:18px;
    }

    /* booking form */
    .top {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .logo { display:flex; align-items:center; gap:12px; }
    h1{margin:0;font-size:20px;font-weight:800;font-style:italic}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    label{display:block;margin-bottom:6px;font-size:14px;font-weight:700}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #eef3fb;box-sizing:border-box;margin-bottom:8px;font-size:14px}
    textarea{font-family:inherit}
    .btn{background:var(--accent);color:white;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
    .btn-ghost{background:transparent;border:1px solid #e6eef9;padding:8px 12px;border-radius:8px;cursor:pointer}
    .diag{background:#0b1220;color:#e6f0ff;padding:10px;border-radius:8px;font-family:monospace;font-size:13px;white-space:pre-wrap;overflow:auto;max-height:220px}
    .estimate{background:#f0f7ff;padding:10px;border-radius:8px;margin-bottom:8px;font-weight:700}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none}
    .controls { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }

    /* Modal/pop popups */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(2,6,23,0.35);display:none;align-items:center;justify-content:center;z-index:9999;
    }
    .modal{
      width:92%;
      max-width:560px;
      background:#fff;border-radius:12px;padding:18px;box-shadow:0 12px 48px rgba(2,6,23,0.4);
      transform:translateY(0);
    }
    .modal h3{margin:0 0 8px;font-size:18px}
    .modal .muted{margin-bottom:8px}
    .spinner{width:56px;height:56px;border-radius:50%;border:6px solid #eef6ff;border-top-color:var(--accent);animation:spin 1s linear infinite;margin:10px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .tech-card{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;border:1px solid #eef6ff;background:#fbfeff}
    .tech-avatar{width:64px;height:64px;border-radius:10px;object-fit:cover;background:#f0f3ff;display:inline-block}
    .tech-info{flex:1}
    .success-italic{font-style:italic;color:#065f46;font-weight:700;margin-top:8px}
    .fail{color:#b91c1c;font-weight:700;margin-top:8px}
    .popup-ok { display:inline-block; margin-top:12px; padding:8px 12px; background:var(--accent); color:#fff; border-radius:8px; cursor:pointer; font-weight:800; text-align:center; }

    /* responsive */
    @media(max-width:680px){
      .logo img{height:72px}
      .controls{flex-direction:column;align-items:stretch}
    }

    /* price display */
    .price-input { display:flex; gap:8px; align-items:center; }
    .price-currency { background:#f3f8ff;border-radius:8px;padding:10px 12px;border:1px solid #eef3fb;color:var(--muted) }

    /* small spacing tweaks */
    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media(max-width:680px){ .form-grid { grid-template-columns: 1fr; } }

  </style>
</head>
<body>
  <div class="wrap">
    <!-- logo full width, removed back link/title area -->
    <div class="header-logo" role="banner" aria-hidden="true">
      <img src="https://i.postimg.cc/ZRSK3pJx/IMG-20260202-144108.png" alt="WireConnect logo">
    </div>

    <div class="content">
      <!-- top small heading inside content (kept as section title) -->
      <div class="top" aria-hidden="false" style="padding-bottom:6px">
        <div>
          <h1>Book a Job</h1>
          <div class="muted" id="userGreeting">—</div>
        </div>
        <div style="align-self:flex-start;color:var(--muted);font-weight:700">
          <!-- intentionally minimal right info kept -->
        </div>
      </div>

      <!-- Booking form -->
      <div>
        <label>Choose job type</label>
        <select id="jobType">
          <option value="conduit">Conduit wiring</option>
          <option value="solar">Solar installation</option>
          <option value="other">Other (custom)</option>
        </select>

        <!-- dynamic options for conduit -->
        <div id="conduitFields" style="margin-top:8px">
          <label>Number of rooms</label>
          <input id="conduitRooms" type="number" min="1" value="1">
          <label><input id="conduitDB" type="checkbox"> Include DB mounting (₦15,000)</label>
          <label><input id="conduitNEPA" type="checkbox"> Include NEPA connection (₦50,000)</label>
          <label><input id="conduitWiringAdd" type="checkbox"> Add extra wiring (₦5,000 per room)</label>
          <label><input id="conduitFittings" type="checkbox"> Include fittings (₦15,000 per room)</label>
        </div>

        <!-- dynamic options for solar -->
        <div id="solarFields" class="hidden" style="margin-top:8px">
          <label>Building type</label>
          <select id="solarBuilding">
            <option value="bungalow">Bungalow (base)</option>
            <option value="one_story">1 storey (base + 30,000)</option>
            <option value="two_plus">2+ storey (base + 60,000)</option>
          </select>
          <label><input id="solarComplex" type="checkbox"> Complex roof / high access (+₦50,000)</label>
        </div>

        <div id="otherFields" class="hidden" style="margin-top:8px">
          <label>Job name</label>
          <input id="otherName" type="text" placeholder="e.g. Plumbing, AC install">
        </div>

        <!-- NEW: State, L.G.A, Town/City inputs (user requested) -->
        <div style="margin-top:10px" class="form-grid">
          <div>
            <label for="stateInput">State</label>
            <input id="stateInput" type="text" placeholder="e.g. Abuja / Lagos / Kano">
          </div>
          <div>
            <label for="lgaInput">L.G.A</label>
            <input id="lgaInput" type="text" placeholder="Local Government Area">
          </div>
          <div style="grid-column: 1 / -1;">
            <label for="cityInput">Town / City</label>
            <input id="cityInput" type="text" placeholder="e.g. Wuse, Ikeja, Maitama">
          </div>
        </div>

        <label style="margin-top:8px">Small description (max 500 words)</label>
        <textarea id="description" rows="5" placeholder="Describe the job — location, special constraints, etc."></textarea>

        <div class="controls">
          <button id="calcBtn" class="btn" title="Estimate price">Calculate estimate</button>
          <button id="submitBtn" class="btn-ghost" title="Submit booking">Submit booking</button>

          <!-- price display (read only) -->
          <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
            <div class="price-currency">₦</div>
            <div id="priceDisplay" style="font-weight:800;font-size:16px">—</div>
          </div>

          <label style="margin-left:12px;align-self:center">
            <input id="useAssign" type="checkbox"> use /api/book-assign
          </label>
        </div>

        <div style="height:12px"></div>
        <div class="estimate" id="estimateBox"><em>Estimate:</em> —</div>

        <h4 style="margin-bottom:6px">Diagnostics (server request/response)</h4>
        <div id="diag" class="diag">No actions yet.</div>
      </div>
    </div>
  </div>

  <!-- modal used for "searching / success / error" and as generic popup -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div id="modalContent">
        <!-- injected by JS -->
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <div id="modalOk" class="popup-ok" style="display:none">OK</div>
        <button id="modalClose" class="btn-ghost">Close</button>
      </div>
    </div>
  </div>

  <script>
    // API root
    const API_BASE = 'https://wireconnet-1.onrender.com';

    // DOM refs
    const jobType = document.getElementById('jobType');
    const conduitFields = document.getElementById('conduitFields');
    const solarFields = document.getElementById('solarFields');
    const otherFields = document.getElementById('otherFields');
    const conduitRooms = document.getElementById('conduitRooms');
    const conduitDB = document.getElementById('conduitDB');
    const conduitNEPA = document.getElementById('conduitNEPA');
    const conduitWiringAdd = document.getElementById('conduitWiringAdd');
    const conduitFittings = document.getElementById('conduitFittings');
    const solarBuilding = document.getElementById('solarBuilding');
    const solarComplex = document.getElementById('solarComplex');
    const otherName = document.getElementById('otherName');
    const description = document.getElementById('description');
    const calcBtn = document.getElementById('calcBtn');
    const submitBtn = document.getElementById('submitBtn');
    const estimateBox = document.getElementById('estimateBox');
    const diag = document.getElementById('diag');
    const useAssign = document.getElementById('useAssign');
    const userGreeting = document.getElementById('userGreeting');
    const priceDisplay = document.getElementById('priceDisplay');

    // new inputs
    const stateInput = document.getElementById('stateInput');
    const lgaInput = document.getElementById('lgaInput');
    const cityInput = document.getElementById('cityInput');

    // modal refs
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalContent = document.getElementById('modalContent');
    const modalClose = document.getElementById('modalClose');
    const modalOk = document.getElementById('modalOk');

    // default PRICES (fallback)
    let PRICES = {
      conduit_per_room: 25000,
      conduit_db: 15000,
      conduit_nepa: 50000,
      conduit_wiring_add_per_room: 5000,
      conduit_fittings_per_room: 15000,
      solar_base_bungalow: 170000,
      solar_extra_per_storey: 30000,
      solar_complex: 50000
    };

    // ------------------ Utility: nice popup (replaces alert) ------------------
    function showPopup(title, message, opts = {}) {
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      const html = [];
      if(title) html.push(`<h3 id="modalTitle">${title}</h3>`);
      html.push(`<div class="muted">${typeof message === 'string' ? message.replace(/\n/g,'<br>') : (JSON.stringify(message,null,2))}</div>`);
      modalContent.innerHTML = html.join('');
      if(opts.okText === null) { modalOk.style.display='none'; }
      else {
        modalOk.style.display='inline-block';
        modalOk.innerText = opts.okText || 'OK';
      }
      modalClose.style.display = (opts.hideClose ? 'none' : 'inline-block');
      const okHandler = () => {
        if(opts.onOk) try{ opts.onOk(); }catch(e){}
        closeModal();
      };
      const closeHandler = closeModal;
      modalOk.onclick = okHandler;
      modalClose.onclick = closeHandler;
      if(opts.autoCloseMs && typeof opts.autoCloseMs === 'number') {
        setTimeout(() => { okHandler(); }, opts.autoCloseMs);
      }
    }

    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
      modalContent.innerHTML = '';
      modalOk.onclick = null;
      modalClose.onclick = null;
    }

    // --------- Modal variants used in previous page behavior (keep names) ----------
    function showModalLoading(){
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      modalContent.innerHTML = `
        <div style="text-align:center">
          <div class="spinner" aria-hidden="true"></div>
          <div class="muted" style="margin-top:8px">Searching for a nearby technician — this may take a few seconds...</div>
        </div>
      `;
      modalOk.style.display = 'none';
      modalClose.style.display = 'none';
    }

    function showModalAssigned(technician, clientName, jobId){
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      modalContent.innerHTML = `
        <div>
          <h3 id="modalTitle">Job matching successful ✅</h3>
          <div class="muted">Your job was created and a technician was matched.</div>

          <div style="height:12px"></div>
          <div class="tech-card">
            <img src="${technician.avatar_url || 'https://i.postimg.cc/7PWQ7P1j/default-avatar.png'}" alt="avatar" class="tech-avatar">
            <div class="tech-info">
              <div style="font-weight:800;font-size:16px">${technician.fullname || technician.username || 'Technician'}</div>
              <div class="small">${technician.username ? ('@' + technician.username) : ''} ${technician.lat && technician.lng ? '• near you' : ''}</div>
              <div class="small" style="margin-top:6px">Job ID: <strong>${jobId}</strong></div>
            </div>
          </div>

          <div class="success-italic"><em>Job matching successful ✅</em></div>

          <div style="margin-top:12px">
            <strong>Client:</strong> ${clientName || 'You'}<br>
            <strong>Technician:</strong> ${technician.fullname || technician.username || 'N/A'}<br>
            ${technician.phone ? ('<strong>Phone:</strong> ' + technician.phone + '<br>') : ''}
            ${technician.email ? ('<strong>Email:</strong> ' + technician.email + '<br>') : ''}
          </div>

          <div style="height:8px"></div>
          <div class="muted">You will be redirected to chat in a moment...</div>
        </div>
      `;
      modalOk.style.display='inline-block';
      modalOk.innerText = 'Close';
      modalClose.style.display='inline-block';
    }

    function showModalNotAssigned(body){
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      modalContent.innerHTML = `
        <div>
          <h3 id="modalTitle">Job created — no immediate match</h3>
          <div class="muted">We created your job but no available technician could be assigned right now.</div>
          <div style="height:10px"></div>
          <div class="diag" style="max-height:160px;background:#fff;color:#111;border:1px solid #eef3fb">${JSON.stringify(body,null,2)}</div>
        </div>
      `;
      modalOk.style.display='inline-block';
      modalOk.innerText = 'Close';
      modalClose.style.display='inline-block';
    }

    function showModalError(message, raw){
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      modalContent.innerHTML = `
        <div>
          <h3 id="modalTitle">Error</h3>
          <div class="fail">${message}</div>
          <div style="height:8px"></div>
          <div class="diag" style="max-height:140px;background:#fff;color:#111;border:1px solid #fee">${raw ? JSON.stringify(raw,null,2) : ''}</div>
        </div>
      `;
      modalOk.style.display='inline-block';
      modalOk.innerText = 'Close';
      modalClose.style.display='inline-block';
    }

    // ------------------ Form behaviour & helpers ------------------

    jobType.addEventListener('change', () => {
      const v = jobType.value;
      conduitFields.classList.toggle('hidden', v !== 'conduit');
      solarFields.classList.toggle('hidden', v !== 'solar');
      otherFields.classList.toggle('hidden', v !== 'other');
    });

    function loadUser() {
      try { const raw = localStorage.getItem('wc_user'); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }

    function ensureClient(){
      const u = loadUser();
      if(!u){
        showPopup('Not logged in', 'Please log in as a client to book a job. You will be redirected to login.', { okText: 'OK', onOk: () => { window.location.href = 'login.html'; } });
        return null;
      }
      if(u.role !== 'client'){
        showPopup('Wrong account', 'Only client accounts can create bookings. You will be redirected to dashboard.', { okText: 'OK', onOk: () => { window.location.href = 'dashboard.html'; } });
        return null;
      }
      return u;
    }

    // calculate estimate using PRICES
    function calculateEstimateLocal(){
      const v = jobType.value;
      let total = 0;
      let breakdown = [];

      if(v === 'conduit'){
        const rooms = Math.max(1, Number(conduitRooms.value || 1));
        const base = PRICES.conduit_per_room * rooms;
        total += base; breakdown.push(`${rooms} room(s) × ₦${PRICES.conduit_per_room.toLocaleString()} = ₦${base.toLocaleString()}`);
        if(conduitDB.checked){ total += PRICES.conduit_db; breakdown.push(`DB mounting = ₦${PRICES.conduit_db.toLocaleString()}`); }
        if(conduitNEPA.checked){ total += PRICES.conduit_nepa; breakdown.push(`NEPA connection = ₦${PRICES.conduit_nepa.toLocaleString()}`); }
        if(conduitWiringAdd.checked){ const add = PRICES.conduit_wiring_add_per_room * rooms; total += add; breakdown.push(`Extra wiring ${rooms}×₦${PRICES.conduit_wiring_add_per_room.toLocaleString()} = ₦${add.toLocaleString()}`); }
        if(conduitFittings.checked){ const fit = PRICES.conduit_fittings_per_room * rooms; total += fit; breakdown.push(`Fittings ${rooms}×₦${PRICES.conduit_fittings_per_room.toLocaleString()} = ₦${fit.toLocaleString()}`); }
      } else if(v === 'solar'){
        let base = PRICES.solar_base_bungalow;
        const b = solarBuilding.value;
        if(b === 'bungalow') { base = PRICES.solar_base_bungalow; breakdown.push(`Bungalow base ₦${base.toLocaleString()}`); }
        else if(b === 'one_story') { base = PRICES.solar_base_bungalow + PRICES.solar_extra_per_storey; breakdown.push(`1 storey: base + ₦${PRICES.solar_extra_per_storey.toLocaleString()}`); }
        else if(b === 'two_plus') { base = PRICES.solar_base_bungalow + PRICES.solar_extra_per_storey * 2; breakdown.push(`2+ storey: base + ₦${(PRICES.solar_extra_per_storey*2).toLocaleString()}`); }
        total += base;
        if(solarComplex.checked){ total += PRICES.solar_complex; breakdown.push(`Complex roof = ₦${PRICES.solar_complex.toLocaleString()}`); }
      } else {
        const price = 0;
        total = price;
        breakdown.push(`Custom job — client to set price at checkout/negotiation.`);
      }

      return { total, breakdown };
    }

     // display estimate
    calcBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const u = ensureClient(); if(!u) return;
      const res = calculateEstimateLocal();
      estimateBox.innerHTML = `<strong>Estimate: ₦${res.total.toLocaleString()}</strong><div class="small" style="margin-top:6px">${res.breakdown.join('<br>')}</div>`;
      priceDisplay.textContent = res.total > 0 ? res.total.toLocaleString() : '—';
    });

    // try to use geolocation once and store for later
    async function tryGeolocationSave(){
      if(!navigator.geolocation) return;
      try{
        const pos = await new Promise((resolve,reject)=>{
          const t = setTimeout(()=> reject(new Error('geolocation timeout')), 4500);
          navigator.geolocation.getCurrentPosition(p => { clearTimeout(t); resolve(p); }, err => { clearTimeout(t); reject(err); }, { maximumAge:60000, timeout:4500 });
        });
        try{ localStorage.setItem('wc_last_lat', String(pos.coords.latitude)); localStorage.setItem('wc_last_lng', String(pos.coords.longitude)); }catch(e){}
      }catch(e){ /* ignore */ }
    }

    // Submit booking with modal UX (uses state/lga/city inputs)
    submitBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      const user = ensureClient(); if(!user) return;

      // Build job payload details
      const jt = jobType.value;
      let job_type = jt;
      let descriptionText = description.value || '';
      if(jt === 'conduit'){
        const rooms = Math.max(1, Number(conduitRooms.value || 1));
        job_type = 'conduit';
        descriptionText = `Conduit wiring — rooms: ${rooms}. ` + descriptionText;
      } else if(jt === 'solar'){
        job_type = 'solar';
        descriptionText = `Solar install — building: ${solarBuilding.value}. ` + descriptionText;
      } else {
        job_type = otherName.value || 'other';
      }

      // price
      const est = calculateEstimateLocal();
      let price = est.total;
      if(price === 0 && jt === 'other'){
        // ask using popup for suggested price
        showPopup('Set estimated price', 'This is a custom job — please enter an estimated price in Naira (no commas):', {
          okText: 'Use price',
          onOk: () => {
            const pRaw = prompt('Enter your estimated price in Naira (₦):', '50000');
            const p = Number(pRaw || 0) || 0;
            price = p;
            doSubmitJob(user, job_type, descriptionText, price);
          },
          hideClose: true
        });
        return;
      }

      // proceed with job submission
      doSubmitJob(user, job_type, descriptionText, price);
    });

    async function doSubmitJob(user, job_type, descriptionText, price){
      // Save last known coords
      await tryGeolocationSave();
      const latLocal = parseFloat(localStorage.getItem('wc_last_lat') || 'NaN');
      const lngLocal = parseFloat(localStorage.getItem('wc_last_lng') || 'NaN');

      // Use the form state inputs to locate technicians (user requested)
      const stateVal = (stateInput.value && stateInput.value.trim()) ? stateInput.value.trim() : (user.state || 'unknown');
      const lgaVal = (lgaInput.value && lgaInput.value.trim()) ? lgaInput.value.trim() : (user.lga || null);
      const cityVal = (cityInput.value && cityInput.value.trim()) ? cityInput.value.trim() : (user.city || null);

      const payload = {
        clientId: user.id,
        state: stateVal,
        city: cityVal,
        address: null,
        lat: Number.isFinite(latLocal) ? latLocal : null,
        lng: Number.isFinite(lngLocal) ? lngLocal : null,
        job_type,
        description: descriptionText,
        price
      };

      // Show modal loading (pop menu)
      showModalLoading();

      // choose endpoint
      const endpoint = (useAssign.checked ? '/api/book-assign' : '/api/book');
      diag.textContent = `POST ${endpoint}\nPAYLOAD:\n${JSON.stringify(payload, null, 2)}\nSending...`;

      try{
        const controller = new AbortController();
        const timeoutId = setTimeout(()=> controller.abort(), 15000);
        const resp = await fetch(API_BASE + endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        const text = await resp.text().catch(()=>null);
        let body = null;
        try { body = text ? JSON.parse(text) : null; } catch(e) { body = text; }

        diag.textContent = `HTTP ${resp.status} ${resp.statusText}\nRESPONSE:\n${JSON.stringify(body, null, 2)}`;

        if(!resp.ok){
          showModalError('Server error while creating booking', body || `HTTP ${resp.status}`);
          return;
        }

        // success path
        if(body && body.success && body.jobId){
          // save to local storage bookings list
          try{
            const existing = JSON.parse(localStorage.getItem('wc_bookings') || '[]');
            existing.unshift({
              id: body.jobId,
              jobType: job_type,
              description: payload.description,
              estimate: price,
              createdAt: new Date().toISOString(),
              assigned: !!body.assigned,
              technician: body.technician || null
            });
            localStorage.setItem('wc_bookings', JSON.stringify(existing));
          }catch(e){ /* ignore storage errors */ }

          if(body.assigned === true){
            // show the assigned modal
            const tech = body.technician || {};
            showModalAssigned(tech, user.fullname || user.username || 'Client', body.jobId);

            // --- NEW: redirect to chat.html immediately (short delay to allow modal render) ---
            // Compose chat URL with jobId and techId if available
            const jobId = body.jobId;
            const techId = (tech && (tech.id || tech.user_id || tech.tech_id)) ? (tech.id || tech.user_id || tech.tech_id) : (body.assigned_tech_id || body.assignedTechId || null);
            const qs = 'jobId=' + encodeURIComponent(jobId) + (techId ? ('&techId=' + encodeURIComponent(techId)) : '');
            // Delay 700ms then redirect
            setTimeout(() => {
              window.location.href = 'chat.html?' + qs;
            }, 700);
            return;
          } else {
            showModalNotAssigned(body);
            return;
          }
        } else {
          showModalError('Unexpected response from server', body);
          return;
        }
      }catch(err){
        const isAbort = err && err.name === 'AbortError';
        showModalError(isAbort ? 'Request timed out' : 'Network error', String(err));
        diag.textContent += '\nNETWORK ERROR:\n' + String(err);
      }
    }

    // init
    (async function init(){
      const userRaw = localStorage.getItem('wc_user');
      if(!userRaw){
        showPopup('Not logged in', 'Please login as client to book. You will be redirected to login.', { okText:'Login', onOk: ()=> { window.location.href='login.html'; } });
        return;
      }
      const user = JSON.parse(userRaw);
      if(user.role !== 'client'){
        showPopup('Not allowed', 'Only clients can book. Redirecting to dashboard.', { okText:'OK', onOk: ()=> { window.location.href='dashboard.html'; } });
        return;
      }
      userGreeting.textContent = `${user.fullname || user.username} — ${user.city || user.state || ''}`;

      try{
        if(user.state) stateInput.value = user.state;
        if(user.lga) lgaInput.value = user.lga;
        if(user.city) cityInput.value = user.city;
      }catch(e){}

      try{
        const resp = await fetch(API_BASE + '/api/prices', { method:'GET', cache:'no-store' });
        if(resp.ok){
          const json = await resp.json().catch(()=>null);
          const backendPrices = (json && json.prices) ? json.prices : json;
          if(backendPrices && typeof backendPrices === 'object'){
            for(const k in backendPrices){
              if(Object.prototype.hasOwnProperty.call(PRICES, k) && typeof backendPrices[k] === 'number'){
                PRICES[k] = backendPrices[k];
              }
            }
          }
        }
      }catch(e){ /* ignore */ }

      const res = calculateEstimateLocal();
      estimateBox.innerHTML = `<strong>Estimate: ₦${res.total.toLocaleString()}</strong><div class="small" style="margin-top:6px">${res.breakdown.join('<br>')}</div>`;
      priceDisplay.textContent = res.total > 0 ? res.total.toLocaleString() : '—';

      tryGeolocationSave();
    })();

    // keyboard / backdrop close
    document.addEventListener('keydown', (e)=> {
      if(e.key === 'Escape') closeModal();
    });
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeModal(); });
    modalClose.addEventListener('click', closeModal);

  </script>
</body>
</html>