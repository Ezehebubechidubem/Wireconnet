<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WireConnect — Book Job</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --accent:#0b5cff; --muted:#6b7280;
      --surface:#ffffff; --shadow: 0 8px 30px rgba(16,24,40,0.06);
    }
    html,body{height:100%;margin:0}
    body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:var(--bg);color:#111827;display:flex;justify-content:center;align-items:flex-start;padding:24px}
    .wrap{width:100%;max-width:900px;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
    h1{margin:0 0 8px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #eef3fb;box-sizing:border-box;margin-bottom:8px}
    label{display:block;margin-bottom:6px;font-size:14px}
    .btn{background:var(--accent);color:white;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid #e6eef9;padding:8px 12px;border-radius:8px;cursor:pointer}
    .diag{background:#0b1220;color:#e6f0ff;padding:10px;border-radius:8px;font-family:monospace;font-size:13px;white-space:pre-wrap;overflow:auto;max-height:220px}
    .estimate{background:#f0f7ff;padding:10px;border-radius:8px;margin-bottom:8px}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h1>Book a Job</h1>
      <div><a href="dashboard.html" style="text-decoration:none;color:var(--accent)">← Back to dashboard</a></div>
    </div>

    <div class="muted" id="userGreeting">—</div>
    <div style="height:12px"></div>

    <!-- Booking form -->
    <div>
      <label>Choose job type</label>
      <select id="jobType">
        <option value="conduit">Conduit wiring</option>
        <option value="solar">Solar installation</option>
        <option value="other">Other (custom)</option>
      </select>

      <!-- dynamic options for conduit -->
      <div id="conduitFields" style="margin-top:8px">
        <label>Number of rooms</label>
        <input id="conduitRooms" type="number" min="1" value="1">
        <label><input id="conduitDB" type="checkbox"> Include DB mounting (₦15,000)</label>
        <label><input id="conduitNEPA" type="checkbox"> Include NEPA connection (₦50,000)</label>
        <label><input id="conduitWiringAdd" type="checkbox"> Add extra wiring (₦5,000 per room)</label>
        <label><input id="conduitFittings" type="checkbox"> Include fittings (₦15,000 per room)</label>
      </div>

      <!-- dynamic options for solar -->
      <div id="solarFields" class="hidden" style="margin-top:8px">
        <label>Building type</label>
        <select id="solarBuilding">
          <option value="bungalow">Bungalow (base)</option>
          <option value="one_story">1 storey (base + 30,000)</option>
          <option value="two_plus">2+ storey (base + 60,000)</option>
        </select>
        <label><input id="solarComplex" type="checkbox"> Complex roof / high access (+₦50,000)</label>
      </div>

      <div id="otherFields" class="hidden" style="margin-top:8px">
        <label>Job name</label>
        <input id="otherName" type="text" placeholder="e.g. Plumbing, AC install">
      </div>

      <label style="margin-top:8px">Small description (max 500 words)</label>
      <textarea id="description" rows="5" placeholder="Describe the job — location, special constraints, etc."></textarea>

      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <button id="calcBtn" class="btn">Calculate estimate</button>
        <button id="submitBtn" class="btn-ghost">Submit booking</button>
        <label style="margin-left:auto"><input id="useAssign" type="checkbox"> use /api/book-assign</label>
      </div>

      <div style="height:12px"></div>
      <div class="estimate" id="estimateBox">Estimate: —</div>

      <h4>Diagnostics (server request/response)</h4>
      <div id="diag" class="diag">No actions yet.</div>
    </div>
  </div>

  <script>
    // BACKEND ROOT
    const API_BASE = '';

    // DOM
    const jobType = document.getElementById('jobType');
    const conduitFields = document.getElementById('conduitFields');
    const solarFields = document.getElementById('solarFields');
    const otherFields = document.getElementById('otherFields');
    const conduitRooms = document.getElementById('conduitRooms');
    const conduitDB = document.getElementById('conduitDB');
    const conduitNEPA = document.getElementById('conduitNEPA');
    const conduitWiringAdd = document.getElementById('conduitWiringAdd');
    const conduitFittings = document.getElementById('conduitFittings');
    const solarBuilding = document.getElementById('solarBuilding');
    const solarComplex = document.getElementById('solarComplex');
    const otherName = document.getElementById('otherName');
    const description = document.getElementById('description');
    const calcBtn = document.getElementById('calcBtn');
    const submitBtn = document.getElementById('submitBtn');
    const estimateBox = document.getElementById('estimateBox');
    const diag = document.getElementById('diag');
    const useAssign = document.getElementById('useAssign');
    const userGreeting = document.getElementById('userGreeting');

    // Pricing rules (adjustable, explicit)
    // CONDUIT:
    // - per room base: ₦25,000
    // - DB mounting: ₦15,000 (flat)
    // - NEPA connection: ₦50,000 (flat)
    // - extra wiring: ₦5,000 per room (if selected)
    // - fittings: ₦15,000 per room (if selected)
    const PRICES = {
      conduit_per_room: 25000,
      conduit_db: 15000,
      conduit_nepa: 50000,
      conduit_wiring_add_per_room: 5000,
      conduit_fittings_per_room: 15000,
      solar_base_bungalow: 170000,
      solar_extra_per_storey: 30000,
      solar_complex: 50000
    };

    function loadUser(){
      try { const raw = localStorage.getItem('wc_user'); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }

    function ensureClient(){
      const u = loadUser();
      if(!u){ alert('Please login (client) to book'); window.location.href = 'login.html'; return null; }
      if(u.role !== 'client'){ alert('Only clients can book. Please login as a client.'); window.location.href = 'dashboard.html'; return null; }
      return u;
    }

    // show/hide dynamic fields
    jobType.addEventListener('change', () => {
      const v = jobType.value;
      conduitFields.classList.toggle('hidden', v !== 'conduit');
      solarFields.classList.toggle('hidden', v !== 'solar');
      otherFields.classList.toggle('hidden', v !== 'other');
    });

    // calculator
    function calculateEstimate(){
      const v = jobType.value;
      let total = 0;
      let breakdown = [];

      if(v === 'conduit'){
        const rooms = Math.max(1, Number(conduitRooms.value || 1));
        const base = PRICES.conduit_per_room * rooms;
        total += base; breakdown.push(`${rooms} room(s) × ₦${PRICES.conduit_per_room.toLocaleString()} = ₦${base.toLocaleString()}`);
        if(conduitDB.checked){ total += PRICES.conduit_db; breakdown.push(`DB mounting = ₦${PRICES.conduit_db.toLocaleString()}`); }
        if(conduitNEPA.checked){ total += PRICES.conduit_nepa; breakdown.push(`NEPA connection = ₦${PRICES.conduit_nepa.toLocaleString()}`); }
        if(conduitWiringAdd.checked){ const add = PRICES.conduit_wiring_add_per_room * rooms; total += add; breakdown.push(`Extra wiring ${rooms}×₦${PRICES.conduit_wiring_add_per_room.toLocaleString()} = ₦${add.toLocaleString()}`); }
        if(conduitFittings.checked){ const fit = PRICES.conduit_fittings_per_room * rooms; total += fit; breakdown.push(`Fittings ${rooms}×₦${PRICES.conduit_fittings_per_room.toLocaleString()} = ₦${fit.toLocaleString()}`); }
      } else if(v === 'solar'){
        let base = PRICES.solar_base_bungalow;
        const b = solarBuilding.value;
        if(b === 'bungalow') { base = PRICES.solar_base_bungalow; breakdown.push(`Bungalow base ₦${base.toLocaleString()}`); }
        else if(b === 'one_story') { base = PRICES.solar_base_bungalow + PRICES.solar_extra_per_storey; breakdown.push(`1 storey: base + ₦${PRICES.solar_extra_per_storey.toLocaleString()}`); }
        else if(b === 'two_plus') { base = PRICES.solar_base_bungalow + PRICES.solar_extra_per_storey * 2; breakdown.push(`2+ storey: base + ₦${(PRICES.solar_extra_per_storey*2).toLocaleString()}`); }
        total += base;
        if(solarComplex.checked){ total += PRICES.solar_complex; breakdown.push(`Complex roof = ₦${PRICES.solar_complex.toLocaleString()}`); }
      } else {
        // other: client supplies estimate price
        const price = Number(prompt('Enter your estimated price in Naira (₦):', '50000')) || 0;
        total = price;
        breakdown.push(`Client-provided estimate ₦${price.toLocaleString()}`);
      }

      return { total, breakdown };
    }

    // show estimate button
    calcBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const u = ensureClient();
      if(!u) return;
      const res = calculateEstimate();
      estimateBox.innerHTML = `<strong>Estimate: ₦${res.total.toLocaleString()}</strong><div class="small" style="margin-top:6px">${res.breakdown.join('<br>')}</div>`;
    });

    // submit booking
    submitBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const user = ensureClient();
      if(!user) return;

      // build job payload
      const jt = jobType.value;
      let job_type = jt;
      let descriptionText = description.value || '';
      if(jt === 'conduit'){
        job_type = 'conduit';
        const rooms = Math.max(1, Number(conduitRooms.value || 1));
        descriptionText = `Conduit wiring — rooms: ${rooms}. ` + descriptionText;
      } else if(jt === 'solar'){
        job_type = 'solar';
        descriptionText = `Solar install — building: ${solarBuilding.value}. ` + descriptionText;
      } else {
        job_type = otherName.value || 'other';
      }

      // calculate price
      const est = calculateEstimate();
      const price = est.total;

      // get last known coords if available
      const lat = parseFloat(localStorage.getItem('wc_last_lat') || null);
      const lng = parseFloat(localStorage.getItem('wc_last_lng') || null);

      const payload = {
        clientId: user.id,
        state: user.state || 'unknown',
        city: user.city || null,
        address: null,
        lat: isFinite(lat) ? lat : null,
        lng: isFinite(lng) ? lng : null,
        job_type,
        description: descriptionText,
        price
      };

      const endpoint = useAssign.checked ? '/api/book-assign' : '/api/book';
      diag.textContent = `POST ${endpoint}\\nPAYLOAD:\\n${JSON.stringify(payload, null, 2)}\\nSending...`;

      try{
        const resp = await fetch(API_BASE + endpoint, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const txt = await resp.text().catch(()=>null);
        let body = null;
        try{ body = txt ? JSON.parse(txt) : null; } catch(e){ body = txt; }
        diag.textContent = `HTTP ${resp.status} ${resp.statusText}\\nRESPONSE:\\n${JSON.stringify(body, null, 2)}`;
        if(resp.ok && body && body.success && body.jobId){
          // save to local storage bookings
          const existing = JSON.parse(localStorage.getItem('wc_bookings') || '[]');
          existing.unshift({ id: body.jobId, jobType: job_type, description: payload.description, estimate: price, createdAt: new Date().toISOString(), assigned: body.assigned || false, technician: body.technician || null });
          localStorage.setItem('wc_bookings', JSON.stringify(existing));

          // redirect to chat page for the job
          window.location.href = 'chat.html?jobId=' + encodeURIComponent(body.jobId);
        } else {
          // keep diagnostics visible
          console.warn('Booking not successful', body);
        }
      }catch(err){
        diag.textContent += '\\nNETWORK ERROR:\\n' + String(err);
      }
    });

    // initialize user greeting and redirect if not client
    (function init(){
      const userRaw = localStorage.getItem('wc_user');
      if(!userRaw){
        alert('Please login as client to book. Redirecting to login.');
        window.location.href = 'login.html';
        return;
      }
      const user = JSON.parse(userRaw);
      if(user.role !== 'client'){
        alert('Only clients can access booking. Redirecting to dashboard.');
        window.location.href = 'dashboard.html';
        return;
      }
      userGreeting.textContent = `${user.fullname || user.username} — ${user.city || user.state || ''}`;
    })();
  </script>
</body>
</html>